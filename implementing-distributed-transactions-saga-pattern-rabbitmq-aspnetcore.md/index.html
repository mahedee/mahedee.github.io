<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.16.6 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Implementing Distributed Transactions in Microservices: SAGA Pattern with RabbitMQ and ASP.NET Core - Think Simple</title>
<meta name="description" content="Learn how to implement distributed transactions in microservices using the SAGA choreography pattern with RabbitMQ and ASP.NET Core. This comprehensive guide covers data consistency challenges, event-driven architecture, and step-by-step implementation with practical code examples.">


  <meta name="author" content="Mahedee Hasan">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Think Simple">
<meta property="og:title" content="Implementing Distributed Transactions in Microservices: SAGA Pattern with RabbitMQ and ASP.NET Core">
<meta property="og:url" content="https://mahedee.net/implementing-distributed-transactions-saga-pattern-rabbitmq-aspnetcore.md/">


  <meta property="og:description" content="Learn how to implement distributed transactions in microservices using the SAGA choreography pattern with RabbitMQ and ASP.NET Core. This comprehensive guide covers data consistency challenges, event-driven architecture, and step-by-step implementation with practical code examples.">



  <meta property="og:image" content="https://mahedee.net/assets/images/post_banner01.jpeg">





  <meta property="article:published_time" content="2026-01-04T00:00:00-05:00">





  

  


<link rel="canonical" href="https://mahedee.net/implementing-distributed-transactions-saga-pattern-rabbitmq-aspnetcore.md/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Mahedee Hasan",
      "url": "https://mahedee.net/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Think Simple Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



<!-- SEO tags -->
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Implementing Distributed Transactions in Microservices: SAGA Pattern with RabbitMQ and ASP.NET Core | Think Simple</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Implementing Distributed Transactions in Microservices: SAGA Pattern with RabbitMQ and ASP.NET Core" />
<meta name="author" content="Mahedee Hasan" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Learn how to implement distributed transactions in microservices using the SAGA choreography pattern with RabbitMQ and ASP.NET Core. This comprehensive guide covers data consistency challenges, event-driven architecture, and step-by-step implementation with practical code examples." />
<meta property="og:description" content="Learn how to implement distributed transactions in microservices using the SAGA choreography pattern with RabbitMQ and ASP.NET Core. This comprehensive guide covers data consistency challenges, event-driven architecture, and step-by-step implementation with practical code examples." />
<link rel="canonical" href="https://mahedee.net/implementing-distributed-transactions-saga-pattern-rabbitmq-aspnetcore.md/" />
<meta property="og:url" content="https://mahedee.net/implementing-distributed-transactions-saga-pattern-rabbitmq-aspnetcore.md/" />
<meta property="og:site_name" content="Think Simple" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2026-01-04T00:00:00-05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Implementing Distributed Transactions in Microservices: SAGA Pattern with RabbitMQ and ASP.NET Core" />
<meta name="twitter:site" content="@" />
<meta name="twitter:creator" content="@Mahedee Hasan" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Mahedee Hasan"},"dateModified":"2026-01-04T00:00:00-05:00","datePublished":"2026-01-04T00:00:00-05:00","description":"Learn how to implement distributed transactions in microservices using the SAGA choreography pattern with RabbitMQ and ASP.NET Core. This comprehensive guide covers data consistency challenges, event-driven architecture, and step-by-step implementation with practical code examples.","headline":"Implementing Distributed Transactions in Microservices: SAGA Pattern with RabbitMQ and ASP.NET Core","mainEntityOfPage":{"@type":"WebPage","@id":"https://mahedee.net/implementing-distributed-transactions-saga-pattern-rabbitmq-aspnetcore.md/"},"url":"https://mahedee.net/implementing-distributed-transactions-saga-pattern-rabbitmq-aspnetcore.md/"}</script>
<!-- End Jekyll SEO tag -->


    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->



     
  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Think Simple
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/" >Home</a>
            </li><li class="masthead__menu-item">
              <a href="/categories" >Categories</a>
            </li><li class="masthead__menu-item">
              <a href="/about/" >About</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/assets/images/me.jpg" alt="Mahedee Hasan" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Mahedee Hasan</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>I am a Microsoft MVP (11th times), programmer, software developer, software architect, consultant, author, researcher, technical blogger, technical speaker, trainer and learner. I have more than 17 years experience in the field of software design and development.</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Toronto, Ontario, Canada</span>
        </li>
      

      
        
          
            <li><a href="mailto:mahedee.hasan@gmail.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i> Email</a></li>
          
        
          
            <li><a href="https://mahedee.net" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-link" aria-hidden="true"></i> Website</a></li>
          
        
          
            <li><a href="https://mvp.microsoft.com/en-us/PublicProfile/5001294" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-award" aria-hidden="true"></i> MVP</a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/mahedee/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> LinkedIn</a></li>
          
        
          
            <li><a href="https://twitter.com/mahedeehasan" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
          
        
          
            <li><a href="https://facebook.com/mahedee19" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-facebook-square" aria-hidden="true"></i> Facebook</a></li>
          
        
          
            <li><a href="https://github.com/mahedee" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
          
        
          
            <li><a href="https://www.buymeacoffee.com/mahedee" rel="nofollow noopener noreferrer"><i class="fab fa fa-coffee" aria-hidden="true"></i> Buy me a Coffee</a></li>
          
        
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Implementing Distributed Transactions in Microservices: SAGA Pattern with RabbitMQ and ASP.NET Core">
    <meta itemprop="description" content="Learn how to implement distributed transactions in microservices using the SAGA choreography pattern with RabbitMQ and ASP.NET Core. This comprehensive guide covers data consistency challenges, event-driven architecture, and step-by-step implementation with practical code examples.">
    <meta itemprop="datePublished" content="January 04, 2026">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Implementing Distributed Transactions in Microservices: SAGA Pattern with RabbitMQ and ASP.NET Core
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  25 minute read
</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>Modern microservices architectures bring tremendous benefits in scalability and maintainability, but they also introduce a critical challenge: <strong>how do you maintain data consistency across multiple services and databases?</strong> Traditional ACID transactions work perfectly within a single database, but they break down when operations span multiple distributed services. Consider an e-commerce scenario where placing an order involves updating inventory, processing payment, and creating order records across different services—if any step fails after others succeed, you’re left with inconsistent data. The <strong>SAGA pattern</strong> solves this problem by coordinating distributed transactions through a sequence of local transactions, each with compensation logic to handle failures gracefully. In this comprehensive guide, you’ll learn how to implement the SAGA choreography pattern using <strong>RabbitMQ</strong> for event-driven messaging and <strong>ASP.NET Core</strong> for building resilient microservices that maintain data consistency even when things go wrong.</p>

<p><strong>Understanding the SAGA Pattern</strong></p>

<p>The <strong>SAGA pattern</strong> is a distributed transaction management approach that breaks down a complex business transaction into a sequence of smaller, local transactions. Unlike traditional ACID transactions that lock resources across multiple databases, SAGA ensures data consistency through a choreographed series of events and compensating actions.</p>

<p><strong>How SAGA Works:</strong></p>

<ol>
  <li><strong>Local Transactions</strong>: Each service performs its own local database transaction</li>
  <li><strong>Event Publishing</strong>: After successful completion, the service publishes an event or message</li>
  <li><strong>Chain Reaction</strong>: Other services listen for these events and execute their own transactions</li>
  <li><strong>Compensation Logic</strong>: If any transaction fails, previously completed transactions are undone through compensating actions</li>
</ol>

<p><strong>Key Benefits:</strong></p>
<ul>
  <li><strong>No Distributed Locks</strong>: Avoids the complexity and performance issues of distributed locking</li>
  <li><strong>Fault Tolerance</strong>: System can recover gracefully from failures</li>
  <li><strong>Scalability</strong>: Each service manages its own data independently</li>
  <li><strong>Eventual Consistency</strong>: Data becomes consistent over time, not immediately</li>
</ul>

<p><strong>SAGA Implementation Approaches</strong>
SAGA can be implemented using two distinct patterns, each with its own trade-offs:</p>

<p><strong>Choreography Pattern</strong>
Services communicate directly with each other through events, without central coordination. Each service knows what events to listen for and what events to publish next.</p>

<p><img src="/assets/images/posts/2026/choreography-pattern.png" alt="" /></p>

<p>Fig - Choreography saga (Collected)</p>

<p><strong>Characteristics:</strong></p>
<ul>
  <li>Decentralized control</li>
  <li>Services are loosely coupled</li>
  <li>No single point of failure</li>
  <li>More complex to track transaction state</li>
</ul>

<p><strong>Orchestration Pattern</strong> 
A central orchestrator service coordinates the entire transaction flow, telling each service what to do and when.</p>

<p><img src="/assets/images/posts/2026/orchestrator.png" alt="" /></p>

<p>Fig - Orchestration saga (Collected)</p>

<p><strong>Characteristics:</strong></p>
<ul>
  <li>Centralized control and monitoring</li>
  <li>Easier to track transaction progress</li>
  <li>Single point of failure (the orchestrator)</li>
  <li>Orchestrator can become a bottleneck</li>
</ul>

<p>In this tutorial, we’ll implement the <strong>choreography pattern</strong> as it promotes better service autonomy and scalability in microservices architectures.</p>

<h2 id="implementation-of-choreography-pattern">Implementation of Choreography Pattern</h2>

<p>In this section, we’ll build a comprehensive e-commerce application demonstrating the SAGA choreography pattern with three microservices communicating through RabbitMQ to handle a complete order-to-payment flow.</p>

<h3 id="project-overview"><strong>Project Overview</strong></h3>

<p>We’ll implement a realistic e-commerce scenario with:</p>

<ul>
  <li><strong>Order Service</strong>: Manages customer orders and orchestrates the overall flow</li>
  <li><strong>Catalog Service</strong>: Manages product inventory and stock reservations</li>
  <li><strong>Payment Service</strong>: Handles payment processing and transaction management</li>
</ul>

<p><strong>Enhanced Transaction Flow:</strong></p>
<ol>
  <li>Customer places order → Order Service creates order record</li>
  <li>Order Service publishes “OrderCreated” event → RabbitMQ</li>
  <li>Catalog Service receives event → Validates and reserves inventory</li>
  <li>Catalog Service publishes “InventoryReserved” event → RabbitMQ</li>
  <li>Payment Service receives event → Processes payment transaction</li>
  <li>Payment Service publishes “PaymentProcessed” event → RabbitMQ</li>
  <li>Order &amp; Catalog Services receive payment result → Finalize or compensate</li>
</ol>

<p><strong>Compensation Scenarios:</strong></p>
<ul>
  <li><strong>Inventory Failure</strong>: Order cancelled immediately</li>
  <li><strong>Payment Failure</strong>: Inventory released, order cancelled</li>
  <li><strong>Service Timeout</strong>: Automatic compensation after timeout period</li>
</ul>

<h3 id="prerequisites"><strong>Prerequisites</strong></h3>

<ul>
  <li><strong>Visual Studio 2026</strong> or <strong>Visual Studio Code</strong> with C# extensions</li>
  <li><strong>.NET 10.0</strong> (Latest LTS) or <strong>.NET 11.0</strong> (Preview)</li>
  <li><strong>Docker Desktop</strong> (for RabbitMQ container)</li>
  <li><strong>Entity Framework Core 10.0+</strong> with SQLite provider</li>
  <li><strong>SQLite database for simplicity</strong></li>
</ul>

<h2 id="step-1-setup-rabbitmq-with-docker"><strong>Step 1: Setup RabbitMQ with Docker</strong></h2>

<p>Start RabbitMQ in a Docker container:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-d</span> <span class="nt">--hostname</span> ecommerce-rabbit <span class="nt">--name</span> saga-rabbitmq <span class="nt">-p</span> 15672:15672 <span class="nt">-p</span> 5672:5672 rabbitmq:4-management
</code></pre></div></div>
<p><strong>Verify RabbitMQ:</strong></p>
<ul>
  <li>Open browser to <code class="language-plaintext highlighter-rouge">http://localhost:15672</code></li>
  <li>Login with username: <code class="language-plaintext highlighter-rouge">guest</code>, password: <code class="language-plaintext highlighter-rouge">guest</code></li>
</ul>

<h2 id="step-2-create-solution-structure"><strong>Step 2: Create Solution Structure</strong></h2>

<p>Create the solution with proper project structure:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Create solution</span>
dotnet new sln <span class="nt">-n</span> EcommerceSaga

<span class="c"># Create projects with .NET 10 framework and traditional controllers</span>
dotnet new webapi <span class="nt">-n</span> Order.API <span class="nt">--use-controllers</span> <span class="nt">--use-program-main</span>
dotnet new webapi <span class="nt">-n</span> Catalog.API <span class="nt">--use-controllers</span> <span class="nt">--use-program-main</span>
dotnet new webapi <span class="nt">-n</span> Payment.API <span class="nt">--use-controllers</span> <span class="nt">--use-program-main</span>
dotnet new classlib <span class="nt">-n</span> Shared

<span class="c"># Add projects to solution</span>
dotnet sln add Order.API/Order.API.csproj
dotnet sln add Catalog.API/Catalog.API.csproj
dotnet sln add Payment.API/Payment.API.csproj
dotnet sln add Shared/Shared.csproj
</code></pre></div></div>

<p><strong>Final structure:</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>EcommerceSaga/
├── EcommerceSaga.sln
├── Order.API/
├── Catalog.API/
├── Payment.API/
└── Shared/
</code></pre></div></div>

<p>This structure allows us to share common models and utilities in the <strong>Shared</strong> project while keeping each microservice isolated.</p>

<ul>
  <li>Run the following command to build the entire solution (if you have a .sln file):
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dotnet build EcommerceSaga.sln
</code></pre></div>    </div>
  </li>
</ul>

<h2 id="step-3-create-shared-models"><strong>Step 3: Create Shared Models</strong></h2>

<p>Add the following models in the <strong>Shared</strong> project:</p>

<h3 id="modelsordercreatedeventcs"><strong>Models/OrderCreatedEvent.cs</strong></h3>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">namespace</span> <span class="nn">Shared.Models</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">OrderCreatedEvent</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">OrderId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">ProductId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">ProductName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">Quantity</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">decimal</span> <span class="n">UnitPrice</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">decimal</span> <span class="n">TotalAmount</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">CustomerEmail</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="modelsinventoryreservedeventcs"><strong>Models/InventoryReservedEvent.cs</strong></h3>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">namespace</span> <span class="nn">Shared.Models</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">InventoryReservedEvent</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">OrderId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">ProductId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">bool</span> <span class="n">IsSuccess</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">Message</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">decimal</span> <span class="n">TotalAmount</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">CustomerEmail</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">ReservedQuantity</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="modelspaymentprocessedeventcs"><strong>Models/PaymentProcessedEvent.cs</strong></h3>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">namespace</span> <span class="nn">Shared.Models</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">PaymentProcessedEvent</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">OrderId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">ProductId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">bool</span> <span class="n">IsSuccess</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">TransactionId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">decimal</span> <span class="n">Amount</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">Message</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">CustomerEmail</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="modelsinventoryreleaseeventcs"><strong>Models/InventoryReleaseEvent.cs</strong></h3>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">namespace</span> <span class="nn">Shared.Models</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">InventoryReleaseEvent</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">OrderId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">ProductId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">Quantity</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">Reason</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="step-4-build-the-order-service"><strong>Step 4: Build the Order Service</strong></h2>

<h3 id="install-required-packages"><strong>Install Required Packages</strong></h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>Order.API
dotnet add package Microsoft.EntityFrameworkCore.Sqlite
dotnet add package Microsoft.EntityFrameworkCore.Tools
dotnet add package Plain.RabbitMQ
dotnet add package Swashbuckle.AspNetCore
<span class="c"># Note: Using System.Text.Json (built-in) instead of Newtonsoft.Json</span>
dotnet add reference ../Shared/Shared.csproj
</code></pre></div></div>

<h3 id="modelsordercs"><strong>Models/Order.cs</strong></h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">System.ComponentModel.DataAnnotations</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.ComponentModel.DataAnnotations.Schema</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Order.API.Models</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">Order</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="n">Key</span><span class="p">]</span>
        <span class="p">[</span><span class="nf">DatabaseGenerated</span><span class="p">(</span><span class="n">DatabaseGeneratedOption</span><span class="p">.</span><span class="n">Identity</span><span class="p">)]</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        
        <span class="k">public</span> <span class="kt">int</span> <span class="n">ProductId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="n">required</span> <span class="kt">string</span> <span class="n">ProductName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">Quantity</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        
        <span class="p">[</span><span class="nf">Column</span><span class="p">(</span><span class="n">TypeName</span> <span class="p">=</span> <span class="s">"decimal(18,2)"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="kt">decimal</span> <span class="n">UnitPrice</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        
        <span class="p">[</span><span class="nf">Column</span><span class="p">(</span><span class="n">TypeName</span> <span class="p">=</span> <span class="s">"decimal(18,2)"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="kt">decimal</span> <span class="n">TotalAmount</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        
        <span class="k">public</span> <span class="kt">string</span> <span class="n">Status</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span> <span class="s">"Pending"</span><span class="p">;</span> <span class="c1">// Pending, InventoryReserved, PaymentProcessing, Confirmed, Cancelled</span>
        <span class="k">public</span> <span class="n">DateTime</span> <span class="n">CreatedAt</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">UtcNow</span><span class="p">;</span>
        <span class="k">public</span> <span class="n">DateTime</span><span class="p">?</span> <span class="n">UpdatedAt</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="n">required</span> <span class="kt">string</span> <span class="n">CustomerEmail</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<h3 id="dataorderdbcontextcs"><strong>Data/OrderDbContext.cs</strong></h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">Microsoft.EntityFrameworkCore</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Order.API.Models</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Order.API.Data</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">OrderDbContext</span> <span class="p">:</span> <span class="n">DbContext</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="nf">OrderDbContext</span><span class="p">(</span><span class="n">DbContextOptions</span><span class="p">&lt;</span><span class="n">OrderDbContext</span><span class="p">&gt;</span> <span class="n">options</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="p">{</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">DbSet</span><span class="p">&lt;</span><span class="n">Models</span><span class="p">.</span><span class="n">Order</span><span class="p">&gt;</span> <span class="n">Orders</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnModelCreating</span><span class="p">(</span><span class="n">ModelBuilder</span> <span class="n">modelBuilder</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">modelBuilder</span><span class="p">.</span><span class="n">Entity</span><span class="p">&lt;</span><span class="n">Models</span><span class="p">.</span><span class="n">Order</span><span class="p">&gt;(</span><span class="n">entity</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="n">entity</span><span class="p">.</span><span class="nf">HasIndex</span><span class="p">(</span><span class="n">e</span> <span class="p">=&gt;</span> <span class="n">e</span><span class="p">.</span><span class="n">ProductId</span><span class="p">);</span>
                <span class="n">entity</span><span class="p">.</span><span class="nf">Property</span><span class="p">(</span><span class="n">e</span> <span class="p">=&gt;</span> <span class="n">e</span><span class="p">.</span><span class="n">Status</span><span class="p">).</span><span class="nf">HasMaxLength</span><span class="p">(</span><span class="m">20</span><span class="p">);</span>
                <span class="n">entity</span><span class="p">.</span><span class="nf">Property</span><span class="p">(</span><span class="n">e</span> <span class="p">=&gt;</span> <span class="n">e</span><span class="p">.</span><span class="n">ProductName</span><span class="p">).</span><span class="nf">HasMaxLength</span><span class="p">(</span><span class="m">200</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<h3 id="servicesinventoryresponselistenercs"><strong>Services/InventoryResponseListener.cs</strong></h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">Microsoft.Extensions.DependencyInjection</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.Hosting</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.Logging</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Text.Json</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Order.API.Data</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Plain.RabbitMQ</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Shared.Models</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Order.API.Services</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">InventoryResponseListener</span> <span class="p">:</span> <span class="n">IHostedService</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">ISubscriber</span> <span class="n">_subscriber</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IServiceScopeFactory</span> <span class="n">_scopeFactory</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">ILogger</span><span class="p">&lt;</span><span class="n">InventoryResponseListener</span><span class="p">&gt;</span> <span class="n">_logger</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">InventoryResponseListener</span><span class="p">(</span>
            <span class="n">ISubscriber</span> <span class="n">subscriber</span><span class="p">,</span>
            <span class="n">IServiceScopeFactory</span> <span class="n">scopeFactory</span><span class="p">,</span>
            <span class="n">ILogger</span><span class="p">&lt;</span><span class="n">InventoryResponseListener</span><span class="p">&gt;</span> <span class="n">logger</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_subscriber</span> <span class="p">=</span> <span class="n">subscriber</span><span class="p">;</span>
            <span class="n">_scopeFactory</span> <span class="p">=</span> <span class="n">scopeFactory</span><span class="p">;</span>
            <span class="n">_logger</span> <span class="p">=</span> <span class="n">logger</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">Task</span> <span class="nf">StartAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_subscriber</span><span class="p">.</span><span class="nf">Subscribe</span><span class="p">(</span><span class="n">ProcessInventoryResponse</span><span class="p">);</span>
            <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">"Inventory Response Listener started"</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">CompletedTask</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="kt">bool</span> <span class="nf">ProcessInventoryResponse</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">,</span> <span class="n">IDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;</span> <span class="n">headers</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">$"Received inventory response: </span><span class="p">{</span><span class="n">message</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
                <span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="n">JsonSerializer</span><span class="p">.</span><span class="n">Deserialize</span><span class="p">&lt;</span><span class="n">InventoryReservedEvent</span><span class="p">&gt;(</span><span class="n">message</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">response</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">_logger</span><span class="p">.</span><span class="nf">LogError</span><span class="p">(</span><span class="s">"Failed to deserialize inventory response"</span><span class="p">);</span>
                    <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">using</span> <span class="nn">var</span> <span class="n">scope</span> <span class="p">=</span> <span class="n">_scopeFactory</span><span class="p">.</span><span class="nf">CreateScope</span><span class="p">();</span>
                <span class="kt">var</span> <span class="n">context</span> <span class="p">=</span> <span class="n">scope</span><span class="p">.</span><span class="n">ServiceProvider</span><span class="p">.</span><span class="n">GetRequiredService</span><span class="p">&lt;</span><span class="n">OrderDbContext</span><span class="p">&gt;();</span>

                <span class="kt">var</span> <span class="n">order</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Orders</span><span class="p">.</span><span class="nf">FirstOrDefault</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="n">response</span><span class="p">.</span><span class="n">OrderId</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">order</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">_logger</span><span class="p">.</span><span class="nf">LogWarning</span><span class="p">(</span><span class="s">$"Order </span><span class="p">{</span><span class="n">response</span><span class="p">.</span><span class="n">OrderId</span><span class="p">}</span><span class="s"> not found"</span><span class="p">);</span>
                    <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">IsSuccess</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="c1">// Move to next step - inventory reserved, waiting for payment</span>
                    <span class="n">order</span><span class="p">.</span><span class="n">Status</span> <span class="p">=</span> <span class="s">"InventoryReserved"</span><span class="p">;</span>
                    <span class="n">order</span><span class="p">.</span><span class="n">UpdatedAt</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">UtcNow</span><span class="p">;</span>
                    <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">$"Order </span><span class="p">{</span><span class="n">order</span><span class="p">.</span><span class="n">Id</span><span class="p">}</span><span class="s"> inventory reserved, awaiting payment processing"</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="c1">// Compensation: Cancel order due to inventory failure</span>
                    <span class="n">order</span><span class="p">.</span><span class="n">Status</span> <span class="p">=</span> <span class="s">"Cancelled"</span><span class="p">;</span>
                    <span class="n">order</span><span class="p">.</span><span class="n">UpdatedAt</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">UtcNow</span><span class="p">;</span>
                    <span class="n">_logger</span><span class="p">.</span><span class="nf">LogWarning</span><span class="p">(</span><span class="s">$"Order </span><span class="p">{</span><span class="n">order</span><span class="p">.</span><span class="n">Id</span><span class="p">}</span><span class="s"> cancelled due to inventory failure: </span><span class="p">{</span><span class="n">response</span><span class="p">.</span><span class="n">Message</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="n">context</span><span class="p">.</span><span class="nf">SaveChanges</span><span class="p">();</span>
                <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">_logger</span><span class="p">.</span><span class="nf">LogError</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">"Error processing inventory response"</span><span class="p">);</span>
                <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">Task</span> <span class="nf">StopAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">"Inventory Response Listener stopped"</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">CompletedTask</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>


</code></pre></div></div>

<h3 id="servicespaymentresponselistenercs"><strong>Services/PaymentResponseListener.cs</strong></h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">Microsoft.Extensions.DependencyInjection</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.Hosting</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.Logging</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Text.Json</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Order.API.Data</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Plain.RabbitMQ</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Shared.Models</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Order.API.Services</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">PaymentResponseListener</span> <span class="p">:</span> <span class="n">IHostedService</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">ISubscriber</span> <span class="n">_paymentSubscriber</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IPublisher</span> <span class="n">_publisher</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IServiceScopeFactory</span> <span class="n">_scopeFactory</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">ILogger</span><span class="p">&lt;</span><span class="n">PaymentResponseListener</span><span class="p">&gt;</span> <span class="n">_logger</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">PaymentResponseListener</span><span class="p">(</span>
            <span class="n">ISubscriber</span> <span class="n">paymentSubscriber</span><span class="p">,</span>
            <span class="n">IPublisher</span> <span class="n">publisher</span><span class="p">,</span>
            <span class="n">IServiceScopeFactory</span> <span class="n">scopeFactory</span><span class="p">,</span>
            <span class="n">ILogger</span><span class="p">&lt;</span><span class="n">PaymentResponseListener</span><span class="p">&gt;</span> <span class="n">logger</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_paymentSubscriber</span> <span class="p">=</span> <span class="n">paymentSubscriber</span><span class="p">;</span>
            <span class="n">_publisher</span> <span class="p">=</span> <span class="n">publisher</span><span class="p">;</span>
            <span class="n">_scopeFactory</span> <span class="p">=</span> <span class="n">scopeFactory</span><span class="p">;</span>
            <span class="n">_logger</span> <span class="p">=</span> <span class="n">logger</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">Task</span> <span class="nf">StartAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_paymentSubscriber</span><span class="p">.</span><span class="nf">Subscribe</span><span class="p">(</span><span class="n">ProcessPaymentResponse</span><span class="p">);</span>
            <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">"Payment Response Listener started"</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">CompletedTask</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="kt">bool</span> <span class="nf">ProcessPaymentResponse</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">,</span> <span class="n">IDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;</span> <span class="n">headers</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">$"Received payment response: </span><span class="p">{</span><span class="n">message</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
                <span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="n">JsonSerializer</span><span class="p">.</span><span class="n">Deserialize</span><span class="p">&lt;</span><span class="n">PaymentProcessedEvent</span><span class="p">&gt;(</span><span class="n">message</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">response</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">_logger</span><span class="p">.</span><span class="nf">LogError</span><span class="p">(</span><span class="s">"Failed to deserialize payment response"</span><span class="p">);</span>
                    <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">using</span> <span class="nn">var</span> <span class="n">scope</span> <span class="p">=</span> <span class="n">_scopeFactory</span><span class="p">.</span><span class="nf">CreateScope</span><span class="p">();</span>
                <span class="kt">var</span> <span class="n">context</span> <span class="p">=</span> <span class="n">scope</span><span class="p">.</span><span class="n">ServiceProvider</span><span class="p">.</span><span class="n">GetRequiredService</span><span class="p">&lt;</span><span class="n">OrderDbContext</span><span class="p">&gt;();</span>

                <span class="kt">var</span> <span class="n">order</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Orders</span><span class="p">.</span><span class="nf">FirstOrDefault</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="n">response</span><span class="p">.</span><span class="n">OrderId</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">order</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">_logger</span><span class="p">.</span><span class="nf">LogWarning</span><span class="p">(</span><span class="s">$"Order </span><span class="p">{</span><span class="n">response</span><span class="p">.</span><span class="n">OrderId</span><span class="p">}</span><span class="s"> not found"</span><span class="p">);</span>
                    <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">IsSuccess</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="c1">// Payment successful - confirm order</span>
                    <span class="n">order</span><span class="p">.</span><span class="n">Status</span> <span class="p">=</span> <span class="s">"Confirmed"</span><span class="p">;</span>
                    <span class="n">order</span><span class="p">.</span><span class="n">UpdatedAt</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">UtcNow</span><span class="p">;</span>
                    <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">$"Order </span><span class="p">{</span><span class="n">order</span><span class="p">.</span><span class="n">Id</span><span class="p">}</span><span class="s"> confirmed after successful payment: </span><span class="p">{</span><span class="n">response</span><span class="p">.</span><span class="n">TransactionId</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="c1">// Payment failed - compensate by cancelling order and releasing inventory</span>
                    <span class="n">order</span><span class="p">.</span><span class="n">Status</span> <span class="p">=</span> <span class="s">"Cancelled"</span><span class="p">;</span>
                    <span class="n">order</span><span class="p">.</span><span class="n">UpdatedAt</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">UtcNow</span><span class="p">;</span>
                    
                    <span class="n">_logger</span><span class="p">.</span><span class="nf">LogWarning</span><span class="p">(</span><span class="s">$"Order </span><span class="p">{</span><span class="n">order</span><span class="p">.</span><span class="n">Id</span><span class="p">}</span><span class="s"> cancelled due to payment failure: </span><span class="p">{</span><span class="n">response</span><span class="p">.</span><span class="n">Message</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>

                    <span class="c1">// Publish inventory release event for compensation</span>
                    <span class="kt">var</span> <span class="n">releaseEvent</span> <span class="p">=</span> <span class="k">new</span> <span class="n">InventoryReleaseEvent</span>
                    <span class="p">{</span>
                        <span class="n">OrderId</span> <span class="p">=</span> <span class="n">response</span><span class="p">.</span><span class="n">OrderId</span><span class="p">,</span>
                        <span class="n">ProductId</span> <span class="p">=</span> <span class="n">response</span><span class="p">.</span><span class="n">ProductId</span><span class="p">,</span>
                        <span class="n">Quantity</span> <span class="p">=</span> <span class="n">order</span><span class="p">.</span><span class="n">Quantity</span><span class="p">,</span>
                        <span class="n">Reason</span> <span class="p">=</span> <span class="s">"Payment failed"</span>
                    <span class="p">};</span>

                    <span class="n">_publisher</span><span class="p">.</span><span class="nf">Publish</span><span class="p">(</span>
                        <span class="n">JsonSerializer</span><span class="p">.</span><span class="nf">Serialize</span><span class="p">(</span><span class="n">releaseEvent</span><span class="p">),</span>
                        <span class="s">"inventory.release"</span><span class="p">,</span>
                        <span class="k">null</span><span class="p">);</span>

                    <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">$"Published inventory release event for order </span><span class="p">{</span><span class="n">response</span><span class="p">.</span><span class="n">OrderId</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="n">context</span><span class="p">.</span><span class="nf">SaveChanges</span><span class="p">();</span>
                <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">_logger</span><span class="p">.</span><span class="nf">LogError</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">"Error processing payment response"</span><span class="p">);</span>
                <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">Task</span> <span class="nf">StopAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">"Payment Response Listener stopped"</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">CompletedTask</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>


</code></pre></div></div>

<h3 id="controllersorderscontrollercs"><strong>Controllers/OrdersController.cs</strong></h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Mvc</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.EntityFrameworkCore</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Text.Json</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Order.API.Data</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Plain.RabbitMQ</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Shared.Models</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Order.API.Controllers</span>
<span class="p">{</span>
    <span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"api/[controller]"</span><span class="p">)]</span>
    <span class="p">[</span><span class="n">ApiController</span><span class="p">]</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">OrdersController</span> <span class="p">:</span> <span class="n">ControllerBase</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">OrderDbContext</span> <span class="n">_context</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IPublisher</span> <span class="n">_publisher</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">ILogger</span><span class="p">&lt;</span><span class="n">OrdersController</span><span class="p">&gt;</span> <span class="n">_logger</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">OrdersController</span><span class="p">(</span>
            <span class="n">OrderDbContext</span> <span class="n">context</span><span class="p">,</span> 
            <span class="n">IPublisher</span> <span class="n">publisher</span><span class="p">,</span> 
            <span class="n">ILogger</span><span class="p">&lt;</span><span class="n">OrdersController</span><span class="p">&gt;</span> <span class="n">logger</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_context</span> <span class="p">=</span> <span class="n">context</span><span class="p">;</span>
            <span class="n">_publisher</span> <span class="p">=</span> <span class="n">publisher</span><span class="p">;</span>
            <span class="n">_logger</span> <span class="p">=</span> <span class="n">logger</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="n">HttpGet</span><span class="p">]</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">ActionResult</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Models</span><span class="p">.</span><span class="n">Order</span><span class="p">&gt;&gt;&gt;</span> <span class="nf">GetOrders</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">_context</span><span class="p">.</span><span class="n">Orders</span><span class="p">.</span><span class="nf">OrderByDescending</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">CreatedAt</span><span class="p">).</span><span class="nf">ToListAsync</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="nf">HttpGet</span><span class="p">(</span><span class="s">"{id}"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">ActionResult</span><span class="p">&lt;</span><span class="n">Models</span><span class="p">.</span><span class="n">Order</span><span class="p">&gt;&gt;</span> <span class="nf">GetOrder</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">order</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_context</span><span class="p">.</span><span class="n">Orders</span><span class="p">.</span><span class="nf">FindAsync</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">order</span> <span class="p">==</span> <span class="k">null</span> <span class="p">?</span> <span class="nf">NotFound</span><span class="p">()</span> <span class="p">:</span> <span class="n">order</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="n">HttpPost</span><span class="p">]</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">ActionResult</span><span class="p">&lt;</span><span class="n">Models</span><span class="p">.</span><span class="n">Order</span><span class="p">&gt;&gt;</span> <span class="nf">CreateOrder</span><span class="p">(</span><span class="n">CreateOrderRequest</span> <span class="n">request</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">order</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Models</span><span class="p">.</span><span class="n">Order</span>
                <span class="p">{</span>
                    <span class="n">ProductId</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="n">ProductId</span><span class="p">,</span>
                    <span class="n">ProductName</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="n">ProductName</span><span class="p">,</span>
                    <span class="n">Quantity</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="n">Quantity</span><span class="p">,</span>
                    <span class="n">UnitPrice</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="n">UnitPrice</span><span class="p">,</span>
                    <span class="n">TotalAmount</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="n">Quantity</span> <span class="p">*</span> <span class="n">request</span><span class="p">.</span><span class="n">UnitPrice</span><span class="p">,</span>
                    <span class="n">CustomerEmail</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="n">CustomerEmail</span>
                <span class="p">};</span>

                <span class="n">_context</span><span class="p">.</span><span class="n">Orders</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">order</span><span class="p">);</span>
                <span class="k">await</span> <span class="n">_context</span><span class="p">.</span><span class="nf">SaveChangesAsync</span><span class="p">();</span>

                <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">$"Order </span><span class="p">{</span><span class="n">order</span><span class="p">.</span><span class="n">Id</span><span class="p">}</span><span class="s"> created, publishing OrderCreated event"</span><span class="p">);</span>

                <span class="c1">// Publish order created event</span>
                <span class="kt">var</span> <span class="n">orderCreatedEvent</span> <span class="p">=</span> <span class="k">new</span> <span class="n">OrderCreatedEvent</span>
                <span class="p">{</span>
                    <span class="n">OrderId</span> <span class="p">=</span> <span class="n">order</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span>
                    <span class="n">ProductId</span> <span class="p">=</span> <span class="n">order</span><span class="p">.</span><span class="n">ProductId</span><span class="p">,</span>
                    <span class="n">ProductName</span> <span class="p">=</span> <span class="n">order</span><span class="p">.</span><span class="n">ProductName</span><span class="p">,</span>
                    <span class="n">Quantity</span> <span class="p">=</span> <span class="n">order</span><span class="p">.</span><span class="n">Quantity</span><span class="p">,</span>
                    <span class="n">UnitPrice</span> <span class="p">=</span> <span class="n">order</span><span class="p">.</span><span class="n">UnitPrice</span><span class="p">,</span>
                    <span class="n">TotalAmount</span> <span class="p">=</span> <span class="n">order</span><span class="p">.</span><span class="n">TotalAmount</span><span class="p">,</span>
                    <span class="n">CustomerEmail</span> <span class="p">=</span> <span class="n">order</span><span class="p">.</span><span class="n">CustomerEmail</span>
                <span class="p">};</span>

                <span class="n">_publisher</span><span class="p">.</span><span class="nf">Publish</span><span class="p">(</span>
                    <span class="n">JsonSerializer</span><span class="p">.</span><span class="nf">Serialize</span><span class="p">(</span><span class="n">orderCreatedEvent</span><span class="p">),</span>
                    <span class="s">"order.created"</span><span class="p">,</span>
                    <span class="k">null</span><span class="p">);</span>

                <span class="k">return</span> <span class="nf">CreatedAtAction</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">GetOrder</span><span class="p">),</span> <span class="k">new</span> <span class="p">{</span> <span class="n">id</span> <span class="p">=</span> <span class="n">order</span><span class="p">.</span><span class="n">Id</span> <span class="p">},</span> <span class="n">order</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">_logger</span><span class="p">.</span><span class="nf">LogError</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">"Error creating order"</span><span class="p">);</span>
                <span class="k">return</span> <span class="nf">StatusCode</span><span class="p">(</span><span class="m">500</span><span class="p">,</span> <span class="s">"Internal server error"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">class</span> <span class="nc">CreateOrderRequest</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">ProductId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">ProductName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">Quantity</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">decimal</span> <span class="n">UnitPrice</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">CustomerEmail</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<h3 id="appsettingsjson"><strong>appsettings.json</strong></h3>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"Logging"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"LogLevel"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Default"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Information"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Microsoft.AspNetCore"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Warning"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Microsoft.EntityFrameworkCore"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Warning"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"ConnectionStrings"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"DefaultConnection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Data Source=orders.db"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"AllowedHosts"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="programcs"><strong>Program.cs</strong></h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">Microsoft.EntityFrameworkCore</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Order.API.Data</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Order.API.Services</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Plain.RabbitMQ</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">RabbitMQ.Client</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Order.API</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">builder</span> <span class="p">=</span> <span class="n">WebApplication</span><span class="p">.</span><span class="nf">CreateBuilder</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>

            <span class="c1">// Add services</span>
            <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="nf">AddControllers</span><span class="p">();</span>
            <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="nf">AddEndpointsApiExplorer</span><span class="p">();</span>
            <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="nf">AddSwaggerGen</span><span class="p">();</span>

            <span class="c1">// Database</span>
            <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddDbContext</span><span class="p">&lt;</span><span class="n">OrderDbContext</span><span class="p">&gt;(</span><span class="n">options</span> <span class="p">=&gt;</span>
                <span class="n">options</span><span class="p">.</span><span class="nf">UseSqlite</span><span class="p">(</span><span class="n">builder</span><span class="p">.</span><span class="n">Configuration</span><span class="p">.</span><span class="nf">GetConnectionString</span><span class="p">(</span><span class="s">"DefaultConnection"</span><span class="p">)));</span>

            <span class="c1">// RabbitMQ Configuration</span>
            <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">IConnectionProvider</span><span class="p">&gt;(</span>
                <span class="k">new</span> <span class="nf">ConnectionProvider</span><span class="p">(</span><span class="s">"amqp://guest:guest@localhost:5672"</span><span class="p">));</span>

            <span class="c1">// Publisher for Order events</span>
            <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">IPublisher</span><span class="p">&gt;(</span><span class="n">provider</span> <span class="p">=&gt;</span>
                <span class="k">new</span> <span class="nf">Publisher</span><span class="p">(</span>
                    <span class="n">provider</span><span class="p">.</span><span class="n">GetService</span><span class="p">&lt;</span><span class="n">IConnectionProvider</span><span class="p">&gt;(),</span>
                    <span class="s">"order.exchange"</span><span class="p">,</span>
                    <span class="n">ExchangeType</span><span class="p">.</span><span class="n">Topic</span><span class="p">));</span>

            <span class="c1">// Subscriber for Inventory events</span>
            <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">ISubscriber</span><span class="p">&gt;(</span><span class="n">provider</span> <span class="p">=&gt;</span>
                <span class="k">new</span> <span class="nf">Subscriber</span><span class="p">(</span>
                    <span class="n">provider</span><span class="p">.</span><span class="n">GetService</span><span class="p">&lt;</span><span class="n">IConnectionProvider</span><span class="p">&gt;(),</span>
                    <span class="s">"inventory.exchange"</span><span class="p">,</span>
                    <span class="s">"inventory.response.queue"</span><span class="p">,</span>
                    <span class="s">"inventory.reserved"</span><span class="p">,</span>
                    <span class="n">ExchangeType</span><span class="p">.</span><span class="n">Topic</span><span class="p">));</span>

            <span class="c1">// Subscriber for Payment events</span>
            <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddKeyedSingleton</span><span class="p">&lt;</span><span class="n">ISubscriber</span><span class="p">&gt;(</span><span class="s">"PaymentSubscriber"</span><span class="p">,</span> <span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="p">=&gt;</span>
                <span class="k">new</span> <span class="nf">Subscriber</span><span class="p">(</span>
                    <span class="n">provider</span><span class="p">.</span><span class="n">GetService</span><span class="p">&lt;</span><span class="n">IConnectionProvider</span><span class="p">&gt;(),</span>
                    <span class="s">"payment.exchange"</span><span class="p">,</span>
                    <span class="s">"payment.response.queue"</span><span class="p">,</span>
                    <span class="s">"payment.processed"</span><span class="p">,</span>
                    <span class="n">ExchangeType</span><span class="p">.</span><span class="n">Topic</span><span class="p">));</span>

            <span class="c1">// Background Services</span>
            <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddHostedService</span><span class="p">&lt;</span><span class="n">InventoryResponseListener</span><span class="p">&gt;();</span>
            <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddHostedService</span><span class="p">&lt;</span><span class="n">PaymentResponseListener</span><span class="p">&gt;();</span>

            <span class="kt">var</span> <span class="n">app</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">Build</span><span class="p">();</span>

            <span class="c1">// Configure the HTTP request pipeline</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="n">Environment</span><span class="p">.</span><span class="nf">IsDevelopment</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="n">app</span><span class="p">.</span><span class="nf">UseSwagger</span><span class="p">();</span>
                <span class="n">app</span><span class="p">.</span><span class="nf">UseSwaggerUI</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="n">app</span><span class="p">.</span><span class="nf">UseHttpsRedirection</span><span class="p">();</span>
            <span class="n">app</span><span class="p">.</span><span class="nf">UseAuthorization</span><span class="p">();</span>
            <span class="n">app</span><span class="p">.</span><span class="nf">MapControllers</span><span class="p">();</span>

            <span class="c1">// Ensure database is created</span>
            <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">scope</span> <span class="p">=</span> <span class="n">app</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="nf">CreateScope</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">context</span> <span class="p">=</span> <span class="n">scope</span><span class="p">.</span><span class="n">ServiceProvider</span><span class="p">.</span><span class="n">GetRequiredService</span><span class="p">&lt;</span><span class="n">OrderDbContext</span><span class="p">&gt;();</span>
                <span class="n">context</span><span class="p">.</span><span class="n">Database</span><span class="p">.</span><span class="nf">EnsureCreated</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="n">app</span><span class="p">.</span><span class="nf">Run</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<ul>
  <li>Run the following command to build the Order.API project:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dotnet build
</code></pre></div>    </div>
  </li>
</ul>

<h2 id="step-5-build-the-catalog-service"><strong>Step 5: Build the Catalog Service</strong></h2>

<h3 id="install-required-packages-1"><strong>Install Required Packages</strong></h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> ../Catalog.API
dotnet add package Microsoft.EntityFrameworkCore.Sqlite
dotnet add package Microsoft.EntityFrameworkCore.Tools
dotnet add package Plain.RabbitMQ
dotnet add package Swashbuckle.AspNetCore
<span class="c"># Note: Using System.Text.Json (built-in with .NET 10) instead of Newtonsoft.Json</span>
dotnet add reference ../Shared/Shared.csproj
</code></pre></div></div>

<h3 id="modelsproductcs"><strong>Models/Product.cs</strong></h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">using</span> <span class="nn">System.ComponentModel.DataAnnotations</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.ComponentModel.DataAnnotations.Schema</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Catalog.API.Models</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">Product</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="n">Key</span><span class="p">]</span>
        <span class="p">[</span><span class="nf">DatabaseGenerated</span><span class="p">(</span><span class="n">DatabaseGeneratedOption</span><span class="p">.</span><span class="n">Identity</span><span class="p">)]</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        
        <span class="p">[</span><span class="n">Required</span><span class="p">]</span>
        <span class="p">[</span><span class="nf">MaxLength</span><span class="p">(</span><span class="m">200</span><span class="p">)]</span>
        <span class="k">public</span> <span class="n">required</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        
        <span class="p">[</span><span class="nf">MaxLength</span><span class="p">(</span><span class="m">1000</span><span class="p">)]</span>
        <span class="k">public</span> <span class="n">required</span> <span class="kt">string</span> <span class="n">Description</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        
        <span class="p">[</span><span class="nf">Column</span><span class="p">(</span><span class="n">TypeName</span> <span class="p">=</span> <span class="s">"decimal(18,2)"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="kt">decimal</span> <span class="n">Price</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        
        <span class="k">public</span> <span class="kt">int</span> <span class="n">AvailableStock</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">ReservedStock</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">MaxStockThreshold</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span> <span class="m">100</span><span class="p">;</span>
        
        <span class="k">public</span> <span class="n">DateTime</span> <span class="n">CreatedAt</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">UtcNow</span><span class="p">;</span>
        <span class="k">public</span> <span class="n">DateTime</span><span class="p">?</span> <span class="n">UpdatedAt</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        
        <span class="c1">// Computed property for total stock</span>
        <span class="p">[</span><span class="n">NotMapped</span><span class="p">]</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">TotalStock</span> <span class="p">=&gt;</span> <span class="n">AvailableStock</span> <span class="p">+</span> <span class="n">ReservedStock</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<h3 id="datacatalogdbcontextcs"><strong>Data/CatalogDbContext.cs</strong></h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">using</span> <span class="nn">Microsoft.EntityFrameworkCore</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Catalog.API.Models</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Catalog.API.Data</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">CatalogDbContext</span> <span class="p">:</span> <span class="n">DbContext</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="nf">CatalogDbContext</span><span class="p">(</span><span class="n">DbContextOptions</span><span class="p">&lt;</span><span class="n">CatalogDbContext</span><span class="p">&gt;</span> <span class="n">options</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="p">{</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">DbSet</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;</span> <span class="n">Products</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnModelCreating</span><span class="p">(</span><span class="n">ModelBuilder</span> <span class="n">modelBuilder</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// Seed some sample data</span>
            <span class="n">modelBuilder</span><span class="p">.</span><span class="n">Entity</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;().</span><span class="nf">HasData</span><span class="p">(</span>
                <span class="k">new</span> <span class="n">Product</span> 
                <span class="p">{</span> 
                    <span class="n">Id</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span> 
                    <span class="n">Name</span> <span class="p">=</span> <span class="s">"Gaming Laptop"</span><span class="p">,</span> 
                    <span class="n">Description</span> <span class="p">=</span> <span class="s">"High-performance gaming laptop with RTX graphics"</span><span class="p">,</span> 
                    <span class="n">Price</span> <span class="p">=</span> <span class="m">1299.99m</span><span class="p">,</span> 
                    <span class="n">AvailableStock</span> <span class="p">=</span> <span class="m">10</span><span class="p">,</span> 
                    <span class="n">ReservedStock</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span>
                    <span class="n">MaxStockThreshold</span> <span class="p">=</span> <span class="m">20</span> 
                <span class="p">},</span>
                <span class="k">new</span> <span class="n">Product</span> 
                <span class="p">{</span> 
                    <span class="n">Id</span> <span class="p">=</span> <span class="m">2</span><span class="p">,</span> 
                    <span class="n">Name</span> <span class="p">=</span> <span class="s">"Wireless Mouse"</span><span class="p">,</span> 
                    <span class="n">Description</span> <span class="p">=</span> <span class="s">"Ergonomic wireless gaming mouse"</span><span class="p">,</span> 
                    <span class="n">Price</span> <span class="p">=</span> <span class="m">79.99m</span><span class="p">,</span> 
                    <span class="n">AvailableStock</span> <span class="p">=</span> <span class="m">25</span><span class="p">,</span> 
                    <span class="n">ReservedStock</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span>
                    <span class="n">MaxStockThreshold</span> <span class="p">=</span> <span class="m">50</span> 
                <span class="p">},</span>
                <span class="k">new</span> <span class="n">Product</span> 
                <span class="p">{</span> 
                    <span class="n">Id</span> <span class="p">=</span> <span class="m">3</span><span class="p">,</span> 
                    <span class="n">Name</span> <span class="p">=</span> <span class="s">"Mechanical Keyboard"</span><span class="p">,</span> 
                    <span class="n">Description</span> <span class="p">=</span> <span class="s">"RGB mechanical keyboard with Cherry MX switches"</span><span class="p">,</span> 
                    <span class="n">Price</span> <span class="p">=</span> <span class="m">159.99m</span><span class="p">,</span> 
                    <span class="n">AvailableStock</span> <span class="p">=</span> <span class="m">15</span><span class="p">,</span> 
                    <span class="n">ReservedStock</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span>
                    <span class="n">MaxStockThreshold</span> <span class="p">=</span> <span class="m">30</span> 
                <span class="p">}</span>
            <span class="p">);</span>

            <span class="c1">// Add index for better performance</span>
            <span class="n">modelBuilder</span><span class="p">.</span><span class="n">Entity</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;()</span>
                <span class="p">.</span><span class="nf">HasIndex</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<h3 id="servicesordercreatedlistenercs"><strong>Services/OrderCreatedListener.cs</strong></h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.DependencyInjection</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.Hosting</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.Logging</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Text.Json</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Catalog.API.Data</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Plain.RabbitMQ</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Shared.Models</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Catalog.API.Services</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">OrderCreatedListener</span> <span class="p">:</span> <span class="n">IHostedService</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">ISubscriber</span> <span class="n">_subscriber</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IPublisher</span> <span class="n">_publisher</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IServiceScopeFactory</span> <span class="n">_scopeFactory</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">ILogger</span><span class="p">&lt;</span><span class="n">OrderCreatedListener</span><span class="p">&gt;</span> <span class="n">_logger</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">OrderCreatedListener</span><span class="p">(</span>
            <span class="n">ISubscriber</span> <span class="n">subscriber</span><span class="p">,</span>
            <span class="n">IPublisher</span> <span class="n">publisher</span><span class="p">,</span>
            <span class="n">IServiceScopeFactory</span> <span class="n">scopeFactory</span><span class="p">,</span>
            <span class="n">ILogger</span><span class="p">&lt;</span><span class="n">OrderCreatedListener</span><span class="p">&gt;</span> <span class="n">logger</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_subscriber</span> <span class="p">=</span> <span class="n">subscriber</span><span class="p">;</span>
            <span class="n">_publisher</span> <span class="p">=</span> <span class="n">publisher</span><span class="p">;</span>
            <span class="n">_scopeFactory</span> <span class="p">=</span> <span class="n">scopeFactory</span><span class="p">;</span>
            <span class="n">_logger</span> <span class="p">=</span> <span class="n">logger</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">Task</span> <span class="nf">StartAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_subscriber</span><span class="p">.</span><span class="nf">Subscribe</span><span class="p">(</span><span class="n">ProcessOrderCreated</span><span class="p">);</span>
            <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">"Order Created Listener started"</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">CompletedTask</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="kt">bool</span> <span class="nf">ProcessOrderCreated</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">,</span> <span class="n">IDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;</span> <span class="n">headers</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">InventoryReservedEvent</span><span class="p">?</span> <span class="n">response</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">$"Received order created event: </span><span class="p">{</span><span class="n">message</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
                <span class="kt">var</span> <span class="n">orderCreated</span> <span class="p">=</span> <span class="n">JsonSerializer</span><span class="p">.</span><span class="n">Deserialize</span><span class="p">&lt;</span><span class="n">OrderCreatedEvent</span><span class="p">&gt;(</span><span class="n">message</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">orderCreated</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">_logger</span><span class="p">.</span><span class="nf">LogError</span><span class="p">(</span><span class="s">"Failed to deserialize order created event"</span><span class="p">);</span>
                    <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">using</span> <span class="nn">var</span> <span class="n">scope</span> <span class="p">=</span> <span class="n">_scopeFactory</span><span class="p">.</span><span class="nf">CreateScope</span><span class="p">();</span>
                <span class="kt">var</span> <span class="n">context</span> <span class="p">=</span> <span class="n">scope</span><span class="p">.</span><span class="n">ServiceProvider</span><span class="p">.</span><span class="n">GetRequiredService</span><span class="p">&lt;</span><span class="n">CatalogDbContext</span><span class="p">&gt;();</span>

                <span class="n">response</span> <span class="p">=</span> <span class="k">new</span> <span class="n">InventoryReservedEvent</span>
                <span class="p">{</span>
                    <span class="n">OrderId</span> <span class="p">=</span> <span class="n">orderCreated</span><span class="p">.</span><span class="n">OrderId</span><span class="p">,</span>
                    <span class="n">ProductId</span> <span class="p">=</span> <span class="n">orderCreated</span><span class="p">.</span><span class="n">ProductId</span><span class="p">,</span>
                    <span class="n">TotalAmount</span> <span class="p">=</span> <span class="n">orderCreated</span><span class="p">.</span><span class="n">TotalAmount</span><span class="p">,</span>
                    <span class="n">CustomerEmail</span> <span class="p">=</span> <span class="n">orderCreated</span><span class="p">.</span><span class="n">CustomerEmail</span>
                <span class="p">};</span>

                <span class="kt">var</span> <span class="n">product</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Products</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="n">orderCreated</span><span class="p">.</span><span class="n">ProductId</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">product</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">response</span><span class="p">.</span><span class="n">IsSuccess</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
                    <span class="n">response</span><span class="p">.</span><span class="n">Message</span> <span class="p">=</span> <span class="s">$"Product with ID </span><span class="p">{</span><span class="n">orderCreated</span><span class="p">.</span><span class="n">ProductId</span><span class="p">}</span><span class="s"> not found"</span><span class="p">;</span>
                    <span class="n">_logger</span><span class="p">.</span><span class="nf">LogWarning</span><span class="p">(</span><span class="s">$"Product </span><span class="p">{</span><span class="n">orderCreated</span><span class="p">.</span><span class="n">ProductId</span><span class="p">}</span><span class="s"> not found for order </span><span class="p">{</span><span class="n">orderCreated</span><span class="p">.</span><span class="n">OrderId</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">product</span><span class="p">.</span><span class="n">AvailableStock</span> <span class="p">&lt;</span> <span class="n">orderCreated</span><span class="p">.</span><span class="n">Quantity</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">response</span><span class="p">.</span><span class="n">IsSuccess</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
                    <span class="n">response</span><span class="p">.</span><span class="n">Message</span> <span class="p">=</span> <span class="s">$"Insufficient stock. Available: </span><span class="p">{</span><span class="n">product</span><span class="p">.</span><span class="n">AvailableStock</span><span class="p">}</span><span class="s">, Requested: </span><span class="p">{</span><span class="n">orderCreated</span><span class="p">.</span><span class="n">Quantity</span><span class="p">}</span><span class="s">"</span><span class="p">;</span>
                    <span class="n">_logger</span><span class="p">.</span><span class="nf">LogWarning</span><span class="p">(</span><span class="s">$"Insufficient stock for product </span><span class="p">{</span><span class="n">orderCreated</span><span class="p">.</span><span class="n">ProductId</span><span class="p">}</span><span class="s">. Available: </span><span class="p">{</span><span class="n">product</span><span class="p">.</span><span class="n">AvailableStock</span><span class="p">}</span><span class="s">, Requested: </span><span class="p">{</span><span class="n">orderCreated</span><span class="p">.</span><span class="n">Quantity</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="c1">// Reserve inventory (don't commit yet, wait for payment confirmation)</span>
                    <span class="kt">var</span> <span class="n">originalStock</span> <span class="p">=</span> <span class="n">product</span><span class="p">.</span><span class="n">AvailableStock</span><span class="p">;</span>
                    <span class="n">product</span><span class="p">.</span><span class="n">AvailableStock</span> <span class="p">-=</span> <span class="n">orderCreated</span><span class="p">.</span><span class="n">Quantity</span><span class="p">;</span>
                    <span class="n">product</span><span class="p">.</span><span class="n">ReservedStock</span> <span class="p">+=</span> <span class="n">orderCreated</span><span class="p">.</span><span class="n">Quantity</span><span class="p">;</span>
                    <span class="n">product</span><span class="p">.</span><span class="n">UpdatedAt</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">UtcNow</span><span class="p">;</span>
                    
                    <span class="n">context</span><span class="p">.</span><span class="nf">SaveChanges</span><span class="p">();</span>

                    <span class="n">response</span><span class="p">.</span><span class="n">IsSuccess</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
                    <span class="n">response</span><span class="p">.</span><span class="n">Message</span> <span class="p">=</span> <span class="s">"Inventory reserved successfully, awaiting payment"</span><span class="p">;</span>
                    <span class="n">response</span><span class="p">.</span><span class="n">ReservedQuantity</span> <span class="p">=</span> <span class="n">orderCreated</span><span class="p">.</span><span class="n">Quantity</span><span class="p">;</span>
                    
                    <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">$"Inventory reserved for product </span><span class="p">{</span><span class="n">orderCreated</span><span class="p">.</span><span class="n">ProductId</span><span class="p">}</span><span class="s">. "</span> <span class="p">+</span>
                                         <span class="s">$"Available stock changed from </span><span class="p">{</span><span class="n">originalStock</span><span class="p">}</span><span class="s"> to </span><span class="p">{</span><span class="n">product</span><span class="p">.</span><span class="n">AvailableStock</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="c1">// Publish inventory response</span>
                <span class="n">_publisher</span><span class="p">.</span><span class="nf">Publish</span><span class="p">(</span>
                    <span class="n">JsonSerializer</span><span class="p">.</span><span class="nf">Serialize</span><span class="p">(</span><span class="n">response</span><span class="p">),</span>
                    <span class="s">"inventory.reserved"</span><span class="p">,</span>
                    <span class="k">null</span><span class="p">);</span>

                <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">_logger</span><span class="p">.</span><span class="nf">LogError</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">"Error processing order created event"</span><span class="p">);</span>
                
                <span class="c1">// Publish failure response if we have basic info</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">response</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">response</span><span class="p">.</span><span class="n">IsSuccess</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
                    <span class="n">response</span><span class="p">.</span><span class="n">Message</span> <span class="p">=</span> <span class="s">"Internal error processing inventory reservation"</span><span class="p">;</span>
                    
                    <span class="n">_publisher</span><span class="p">.</span><span class="nf">Publish</span><span class="p">(</span>
                        <span class="n">JsonSerializer</span><span class="p">.</span><span class="nf">Serialize</span><span class="p">(</span><span class="n">response</span><span class="p">),</span>
                        <span class="s">"inventory.reserved"</span><span class="p">,</span>
                        <span class="k">null</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">Task</span> <span class="nf">StopAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">"Order Created Listener stopped"</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">CompletedTask</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<h3 id="servicesinventoryreleaselistenercs"><strong>Services/InventoryReleaseListener.cs</strong></h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.DependencyInjection</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.Hosting</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.Logging</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Text.Json</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Catalog.API.Data</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Plain.RabbitMQ</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Shared.Models</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Catalog.API.Services</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">InventoryReleaseListener</span> <span class="p">:</span> <span class="n">IHostedService</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">ISubscriber</span> <span class="n">_subscriber</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IServiceScopeFactory</span> <span class="n">_scopeFactory</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">ILogger</span><span class="p">&lt;</span><span class="n">InventoryReleaseListener</span><span class="p">&gt;</span> <span class="n">_logger</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">InventoryReleaseListener</span><span class="p">(</span>
            <span class="n">ISubscriber</span> <span class="n">subscriber</span><span class="p">,</span>
            <span class="n">IServiceScopeFactory</span> <span class="n">scopeFactory</span><span class="p">,</span>
            <span class="n">ILogger</span><span class="p">&lt;</span><span class="n">InventoryReleaseListener</span><span class="p">&gt;</span> <span class="n">logger</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_subscriber</span> <span class="p">=</span> <span class="n">subscriber</span><span class="p">;</span>
            <span class="n">_scopeFactory</span> <span class="p">=</span> <span class="n">scopeFactory</span><span class="p">;</span>
            <span class="n">_logger</span> <span class="p">=</span> <span class="n">logger</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">Task</span> <span class="nf">StartAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_subscriber</span><span class="p">.</span><span class="nf">Subscribe</span><span class="p">(</span><span class="n">ProcessInventoryRelease</span><span class="p">);</span>
            <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">"Inventory Release Listener started"</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">CompletedTask</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="kt">bool</span> <span class="nf">ProcessInventoryRelease</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">,</span> <span class="n">IDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;</span> <span class="n">headers</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">$"Received inventory release event: </span><span class="p">{</span><span class="n">message</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
                <span class="kt">var</span> <span class="n">releaseEvent</span> <span class="p">=</span> <span class="n">JsonSerializer</span><span class="p">.</span><span class="n">Deserialize</span><span class="p">&lt;</span><span class="n">InventoryReleaseEvent</span><span class="p">&gt;(</span><span class="n">message</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">releaseEvent</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">_logger</span><span class="p">.</span><span class="nf">LogError</span><span class="p">(</span><span class="s">"Failed to deserialize inventory release event"</span><span class="p">);</span>
                    <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">using</span> <span class="nn">var</span> <span class="n">scope</span> <span class="p">=</span> <span class="n">_scopeFactory</span><span class="p">.</span><span class="nf">CreateScope</span><span class="p">();</span>
                <span class="kt">var</span> <span class="n">context</span> <span class="p">=</span> <span class="n">scope</span><span class="p">.</span><span class="n">ServiceProvider</span><span class="p">.</span><span class="n">GetRequiredService</span><span class="p">&lt;</span><span class="n">CatalogDbContext</span><span class="p">&gt;();</span>

                <span class="kt">var</span> <span class="n">product</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Products</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="n">releaseEvent</span><span class="p">.</span><span class="n">ProductId</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">product</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">_logger</span><span class="p">.</span><span class="nf">LogWarning</span><span class="p">(</span><span class="s">$"Product </span><span class="p">{</span><span class="n">releaseEvent</span><span class="p">.</span><span class="n">ProductId</span><span class="p">}</span><span class="s"> not found for inventory release"</span><span class="p">);</span>
                    <span class="k">return</span> <span class="k">true</span><span class="p">;</span> <span class="c1">// Consider it processed</span>
                <span class="p">}</span>

                <span class="c1">// Release reserved inventory back to available stock</span>
                <span class="kt">var</span> <span class="n">beforeAvailable</span> <span class="p">=</span> <span class="n">product</span><span class="p">.</span><span class="n">AvailableStock</span><span class="p">;</span>
                <span class="kt">var</span> <span class="n">beforeReserved</span> <span class="p">=</span> <span class="n">product</span><span class="p">.</span><span class="n">ReservedStock</span><span class="p">;</span>
                
                <span class="n">product</span><span class="p">.</span><span class="n">AvailableStock</span> <span class="p">+=</span> <span class="n">releaseEvent</span><span class="p">.</span><span class="n">Quantity</span><span class="p">;</span>
                <span class="n">product</span><span class="p">.</span><span class="n">ReservedStock</span> <span class="p">=</span> <span class="n">Math</span><span class="p">.</span><span class="nf">Max</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">product</span><span class="p">.</span><span class="n">ReservedStock</span> <span class="p">-</span> <span class="n">releaseEvent</span><span class="p">.</span><span class="n">Quantity</span><span class="p">);</span>
                <span class="n">product</span><span class="p">.</span><span class="n">UpdatedAt</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">UtcNow</span><span class="p">;</span>
                
                <span class="n">context</span><span class="p">.</span><span class="nf">SaveChanges</span><span class="p">();</span>

                <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">$"Released inventory for product </span><span class="p">{</span><span class="n">releaseEvent</span><span class="p">.</span><span class="n">ProductId</span><span class="p">}</span><span class="s"> due to: </span><span class="p">{</span><span class="n">releaseEvent</span><span class="p">.</span><span class="n">Reason</span><span class="p">}</span><span class="s">. "</span> <span class="p">+</span>
                                     <span class="s">$"Available: </span><span class="p">{</span><span class="n">beforeAvailable</span><span class="p">}</span><span class="s"> → </span><span class="p">{</span><span class="n">product</span><span class="p">.</span><span class="n">AvailableStock</span><span class="p">}</span><span class="s">, "</span> <span class="p">+</span>
                                     <span class="s">$"Reserved: </span><span class="p">{</span><span class="n">beforeReserved</span><span class="p">}</span><span class="s"> → </span><span class="p">{</span><span class="n">product</span><span class="p">.</span><span class="n">ReservedStock</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>

                <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">_logger</span><span class="p">.</span><span class="nf">LogError</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">"Error processing inventory release event"</span><span class="p">);</span>
                <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">Task</span> <span class="nf">StopAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">"Inventory Release Listener stopped"</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">CompletedTask</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<h3 id="servicespaymentconfirmationlistenercs"><strong>Services/PaymentConfirmationListener.cs</strong></h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.DependencyInjection</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.Hosting</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.Logging</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Text.Json</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Catalog.API.Data</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Plain.RabbitMQ</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Shared.Models</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Catalog.API.Services</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">PaymentConfirmationListener</span> <span class="p">:</span> <span class="n">IHostedService</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">ISubscriber</span> <span class="n">_subscriber</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IServiceScopeFactory</span> <span class="n">_scopeFactory</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">ILogger</span><span class="p">&lt;</span><span class="n">PaymentConfirmationListener</span><span class="p">&gt;</span> <span class="n">_logger</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">PaymentConfirmationListener</span><span class="p">(</span>
            <span class="n">ISubscriber</span> <span class="n">subscriber</span><span class="p">,</span>
            <span class="n">IServiceScopeFactory</span> <span class="n">scopeFactory</span><span class="p">,</span>
            <span class="n">ILogger</span><span class="p">&lt;</span><span class="n">PaymentConfirmationListener</span><span class="p">&gt;</span> <span class="n">logger</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_subscriber</span> <span class="p">=</span> <span class="n">subscriber</span><span class="p">;</span>
            <span class="n">_scopeFactory</span> <span class="p">=</span> <span class="n">scopeFactory</span><span class="p">;</span>
            <span class="n">_logger</span> <span class="p">=</span> <span class="n">logger</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">Task</span> <span class="nf">StartAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_subscriber</span><span class="p">.</span><span class="nf">Subscribe</span><span class="p">(</span><span class="n">ProcessPaymentConfirmation</span><span class="p">);</span>
            <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">"Payment Confirmation Listener started"</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">CompletedTask</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="kt">bool</span> <span class="nf">ProcessPaymentConfirmation</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">,</span> <span class="n">IDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;</span> <span class="n">headers</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">$"Received payment confirmation: </span><span class="p">{</span><span class="n">message</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
                <span class="kt">var</span> <span class="n">paymentEvent</span> <span class="p">=</span> <span class="n">JsonSerializer</span><span class="p">.</span><span class="n">Deserialize</span><span class="p">&lt;</span><span class="n">PaymentProcessedEvent</span><span class="p">&gt;(</span><span class="n">message</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">paymentEvent</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">_logger</span><span class="p">.</span><span class="nf">LogError</span><span class="p">(</span><span class="s">"Failed to deserialize payment event"</span><span class="p">);</span>
                    <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">paymentEvent</span><span class="p">.</span><span class="n">IsSuccess</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="c1">// Payment successful - inventory reservation is now committed</span>
                    <span class="c1">// No action needed, inventory was already reserved</span>
                    <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">$"Payment confirmed for order </span><span class="p">{</span><span class="n">paymentEvent</span><span class="p">.</span><span class="n">OrderId</span><span class="p">}</span><span class="s">, inventory reservation committed"</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="c1">// Note: If payment fails, the InventoryReleaseListener will handle releasing the inventory</span>

                <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">_logger</span><span class="p">.</span><span class="nf">LogError</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">"Error processing payment confirmation"</span><span class="p">);</span>
                <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">Task</span> <span class="nf">StopAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">"Payment Confirmation Listener stopped"</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">CompletedTask</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<h3 id="controllersproductscontrollercs"><strong>Controllers/ProductsController.cs</strong></h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Mvc</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.EntityFrameworkCore</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Catalog.API.Data</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Catalog.API.Models</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Catalog.API.Controllers</span>
<span class="p">{</span>
    <span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"api/[controller]"</span><span class="p">)]</span>
    <span class="p">[</span><span class="n">ApiController</span><span class="p">]</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">ProductsController</span> <span class="p">:</span> <span class="n">ControllerBase</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">CatalogDbContext</span> <span class="n">_context</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">ILogger</span><span class="p">&lt;</span><span class="n">ProductsController</span><span class="p">&gt;</span> <span class="n">_logger</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">ProductsController</span><span class="p">(</span><span class="n">CatalogDbContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">ILogger</span><span class="p">&lt;</span><span class="n">ProductsController</span><span class="p">&gt;</span> <span class="n">logger</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_context</span> <span class="p">=</span> <span class="n">context</span><span class="p">;</span>
            <span class="n">_logger</span> <span class="p">=</span> <span class="n">logger</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="n">HttpGet</span><span class="p">]</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">ActionResult</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;&gt;&gt;</span> <span class="nf">GetProducts</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">_context</span><span class="p">.</span><span class="n">Products</span><span class="p">.</span><span class="nf">OrderBy</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">Name</span><span class="p">).</span><span class="nf">ToListAsync</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="nf">HttpGet</span><span class="p">(</span><span class="s">"{id}"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">ActionResult</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;&gt;</span> <span class="nf">GetProduct</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">product</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_context</span><span class="p">.</span><span class="n">Products</span><span class="p">.</span><span class="nf">FindAsync</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">product</span> <span class="p">==</span> <span class="k">null</span> <span class="p">?</span> <span class="nf">NotFound</span><span class="p">()</span> <span class="p">:</span> <span class="n">product</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="nf">HttpPut</span><span class="p">(</span><span class="s">"{id}/stock"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">IActionResult</span><span class="p">&gt;</span> <span class="nf">UpdateStock</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">UpdateStockRequest</span> <span class="n">request</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">product</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_context</span><span class="p">.</span><span class="n">Products</span><span class="p">.</span><span class="nf">FindAsync</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">product</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="nf">NotFound</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="kt">var</span> <span class="n">oldAvailableStock</span> <span class="p">=</span> <span class="n">product</span><span class="p">.</span><span class="n">AvailableStock</span><span class="p">;</span>
            <span class="n">product</span><span class="p">.</span><span class="n">AvailableStock</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="n">AvailableStock</span><span class="p">;</span>
            <span class="n">product</span><span class="p">.</span><span class="n">UpdatedAt</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">UtcNow</span><span class="p">;</span>

            <span class="k">try</span>
            <span class="p">{</span>
                <span class="k">await</span> <span class="n">_context</span><span class="p">.</span><span class="nf">SaveChangesAsync</span><span class="p">();</span>
                <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">$"Stock updated for product </span><span class="p">{</span><span class="n">id</span><span class="p">}</span><span class="s">: </span><span class="p">{</span><span class="n">oldAvailableStock</span><span class="p">}</span><span class="s"> → </span><span class="p">{</span><span class="n">request</span><span class="p">.</span><span class="n">AvailableStock</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
                <span class="k">return</span> <span class="nf">NoContent</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">DbUpdateConcurrencyException</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(!</span><span class="nf">ProductExists</span><span class="p">(</span><span class="n">id</span><span class="p">))</span>
                    <span class="k">return</span> <span class="nf">NotFound</span><span class="p">();</span>
                <span class="k">throw</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="kt">bool</span> <span class="nf">ProductExists</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">_context</span><span class="p">.</span><span class="n">Products</span><span class="p">.</span><span class="nf">Any</span><span class="p">(</span><span class="n">e</span> <span class="p">=&gt;</span> <span class="n">e</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="n">id</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">class</span> <span class="nc">UpdateStockRequest</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">AvailableStock</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<h3 id="appsettingsjson-1"><strong>appsettings.json</strong></h3>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"Logging"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"LogLevel"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Default"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Information"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Microsoft.AspNetCore"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Warning"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Microsoft.EntityFrameworkCore"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Warning"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"ConnectionStrings"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"DefaultConnection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Data Source=catalog.db"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"AllowedHosts"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="programcs-1"><strong>Program.cs</strong></h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">using</span> <span class="nn">Microsoft.EntityFrameworkCore</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Catalog.API.Data</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Catalog.API.Services</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Plain.RabbitMQ</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">RabbitMQ.Client</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Catalog.API</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">builder</span> <span class="p">=</span> <span class="n">WebApplication</span><span class="p">.</span><span class="nf">CreateBuilder</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>

            <span class="c1">// Add services</span>
            <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="nf">AddControllers</span><span class="p">();</span>
            <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="nf">AddEndpointsApiExplorer</span><span class="p">();</span>
            <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="nf">AddSwaggerGen</span><span class="p">();</span>

            <span class="c1">// Database</span>
            <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddDbContext</span><span class="p">&lt;</span><span class="n">CatalogDbContext</span><span class="p">&gt;(</span><span class="n">options</span> <span class="p">=&gt;</span>
                <span class="n">options</span><span class="p">.</span><span class="nf">UseSqlite</span><span class="p">(</span><span class="n">builder</span><span class="p">.</span><span class="n">Configuration</span><span class="p">.</span><span class="nf">GetConnectionString</span><span class="p">(</span><span class="s">"DefaultConnection"</span><span class="p">)));</span>

            <span class="c1">// RabbitMQ Configuration</span>
            <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">IConnectionProvider</span><span class="p">&gt;(</span>
                <span class="k">new</span> <span class="nf">ConnectionProvider</span><span class="p">(</span><span class="s">"amqp://guest:guest@localhost:5672"</span><span class="p">));</span>

            <span class="c1">// Publisher for Inventory events</span>
            <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">IPublisher</span><span class="p">&gt;(</span><span class="n">provider</span> <span class="p">=&gt;</span>
                <span class="k">new</span> <span class="nf">Publisher</span><span class="p">(</span>
                    <span class="n">provider</span><span class="p">.</span><span class="n">GetService</span><span class="p">&lt;</span><span class="n">IConnectionProvider</span><span class="p">&gt;(),</span>
                    <span class="s">"inventory.exchange"</span><span class="p">,</span>
                    <span class="n">ExchangeType</span><span class="p">.</span><span class="n">Topic</span><span class="p">));</span>

            <span class="c1">// Subscriber for Order events</span>
            <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">ISubscriber</span><span class="p">&gt;(</span><span class="n">provider</span> <span class="p">=&gt;</span>
                <span class="k">new</span> <span class="nf">Subscriber</span><span class="p">(</span>
                    <span class="n">provider</span><span class="p">.</span><span class="n">GetService</span><span class="p">&lt;</span><span class="n">IConnectionProvider</span><span class="p">&gt;(),</span>
                    <span class="s">"order.exchange"</span><span class="p">,</span>
                    <span class="s">"order.created.queue"</span><span class="p">,</span>
                    <span class="s">"order.created"</span><span class="p">,</span>
                    <span class="n">ExchangeType</span><span class="p">.</span><span class="n">Topic</span><span class="p">));</span>

            <span class="c1">// Subscriber for Inventory Release events</span>
            <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddKeyedSingleton</span><span class="p">&lt;</span><span class="n">ISubscriber</span><span class="p">&gt;(</span><span class="s">"ReleaseSubscriber"</span><span class="p">,</span> <span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="p">=&gt;</span>
                <span class="k">new</span> <span class="nf">Subscriber</span><span class="p">(</span>
                    <span class="n">provider</span><span class="p">.</span><span class="n">GetService</span><span class="p">&lt;</span><span class="n">IConnectionProvider</span><span class="p">&gt;(),</span>
                    <span class="s">"order.exchange"</span><span class="p">,</span>
                    <span class="s">"inventory.release.queue"</span><span class="p">,</span>
                    <span class="s">"inventory.release"</span><span class="p">,</span>
                    <span class="n">ExchangeType</span><span class="p">.</span><span class="n">Topic</span><span class="p">));</span>

            <span class="c1">// Subscriber for Payment events</span>
            <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddKeyedSingleton</span><span class="p">&lt;</span><span class="n">ISubscriber</span><span class="p">&gt;(</span><span class="s">"PaymentSubscriber"</span><span class="p">,</span> <span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="p">=&gt;</span>
                <span class="k">new</span> <span class="nf">Subscriber</span><span class="p">(</span>
                    <span class="n">provider</span><span class="p">.</span><span class="n">GetService</span><span class="p">&lt;</span><span class="n">IConnectionProvider</span><span class="p">&gt;(),</span>
                    <span class="s">"payment.exchange"</span><span class="p">,</span>
                    <span class="s">"payment.confirmation.queue"</span><span class="p">,</span>
                    <span class="s">"payment.processed"</span><span class="p">,</span>
                    <span class="n">ExchangeType</span><span class="p">.</span><span class="n">Topic</span><span class="p">));</span>

            <span class="c1">// Background Services</span>
            <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddHostedService</span><span class="p">&lt;</span><span class="n">OrderCreatedListener</span><span class="p">&gt;();</span>
            <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddHostedService</span><span class="p">&lt;</span><span class="n">InventoryReleaseListener</span><span class="p">&gt;();</span>
            <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddHostedService</span><span class="p">&lt;</span><span class="n">PaymentConfirmationListener</span><span class="p">&gt;();</span>

            <span class="kt">var</span> <span class="n">app</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">Build</span><span class="p">();</span>

            <span class="c1">// Configure the HTTP request pipeline</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="n">Environment</span><span class="p">.</span><span class="nf">IsDevelopment</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="n">app</span><span class="p">.</span><span class="nf">UseSwagger</span><span class="p">();</span>
                <span class="n">app</span><span class="p">.</span><span class="nf">UseSwaggerUI</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="n">app</span><span class="p">.</span><span class="nf">UseHttpsRedirection</span><span class="p">();</span>
            <span class="n">app</span><span class="p">.</span><span class="nf">UseAuthorization</span><span class="p">();</span>
            <span class="n">app</span><span class="p">.</span><span class="nf">MapControllers</span><span class="p">();</span>

            <span class="c1">// Ensure database is created and seeded</span>
            <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">scope</span> <span class="p">=</span> <span class="n">app</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="nf">CreateScope</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">context</span> <span class="p">=</span> <span class="n">scope</span><span class="p">.</span><span class="n">ServiceProvider</span><span class="p">.</span><span class="n">GetRequiredService</span><span class="p">&lt;</span><span class="n">CatalogDbContext</span><span class="p">&gt;();</span>
                <span class="n">context</span><span class="p">.</span><span class="n">Database</span><span class="p">.</span><span class="nf">EnsureCreated</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="n">app</span><span class="p">.</span><span class="nf">Run</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<!-- Completed up to -->

<h2 id="step-6-build-the-payment-service"><strong>Step 6: Build the Payment Service</strong></h2>

<h3 id="install-required-packages-2"><strong>Install Required Packages</strong></h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> ../Payment.API
dotnet add package Microsoft.EntityFrameworkCore.Sqlite
dotnet add package Microsoft.EntityFrameworkCore.Tools
dotnet add package Plain.RabbitMQ
dotnet add package Swashbuckle.AspNetCore
<span class="c"># Note: Using System.Text.Json (built-in with .NET 10) instead of Newtonsoft.Json</span>
dotnet add reference ../Shared/Shared.csproj
</code></pre></div></div>

<h3 id="modelspaymenttransactioncs"><strong>Models/PaymentTransaction.cs</strong></h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">using</span> <span class="nn">System.ComponentModel.DataAnnotations</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.ComponentModel.DataAnnotations.Schema</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Payment.API.Models</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">PaymentTransaction</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="n">Key</span><span class="p">]</span>
        <span class="p">[</span><span class="nf">DatabaseGenerated</span><span class="p">(</span><span class="n">DatabaseGeneratedOption</span><span class="p">.</span><span class="n">Identity</span><span class="p">)]</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        
        <span class="k">public</span> <span class="kt">int</span> <span class="n">OrderId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">ProductId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        
        <span class="p">[</span><span class="nf">Column</span><span class="p">(</span><span class="n">TypeName</span> <span class="p">=</span> <span class="s">"decimal(18,2)"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="kt">decimal</span> <span class="n">Amount</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        
        <span class="p">[</span><span class="n">Required</span><span class="p">]</span>
        <span class="p">[</span><span class="nf">MaxLength</span><span class="p">(</span><span class="m">200</span><span class="p">)]</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">CustomerEmail</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        
        <span class="p">[</span><span class="nf">MaxLength</span><span class="p">(</span><span class="m">50</span><span class="p">)]</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">Status</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span> <span class="s">"Pending"</span><span class="p">;</span> <span class="c1">// Pending, Completed, Failed, Refunded</span>
        
        <span class="p">[</span><span class="nf">MaxLength</span><span class="p">(</span><span class="m">100</span><span class="p">)]</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">TransactionId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        
        <span class="p">[</span><span class="nf">MaxLength</span><span class="p">(</span><span class="m">50</span><span class="p">)]</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">PaymentMethod</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span> <span class="s">"CreditCard"</span><span class="p">;</span>
        
        <span class="k">public</span> <span class="n">DateTime</span> <span class="n">CreatedAt</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">UtcNow</span><span class="p">;</span>
        <span class="k">public</span> <span class="n">DateTime</span><span class="p">?</span> <span class="n">ProcessedAt</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        
        <span class="p">[</span><span class="nf">MaxLength</span><span class="p">(</span><span class="m">500</span><span class="p">)]</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">FailureReason</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        
        <span class="p">[</span><span class="nf">MaxLength</span><span class="p">(</span><span class="m">100</span><span class="p">)]</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">ExternalTransactionId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="datapaymentdbcontextcs"><strong>Data/PaymentDbContext.cs</strong></h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">using</span> <span class="nn">Microsoft.EntityFrameworkCore</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Payment.API.Models</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Payment.API.Data</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">PaymentDbContext</span> <span class="p">:</span> <span class="n">DbContext</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="nf">PaymentDbContext</span><span class="p">(</span><span class="n">DbContextOptions</span><span class="p">&lt;</span><span class="n">PaymentDbContext</span><span class="p">&gt;</span> <span class="n">options</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="p">{</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">DbSet</span><span class="p">&lt;</span><span class="n">PaymentTransaction</span><span class="p">&gt;</span> <span class="n">PaymentTransactions</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnModelCreating</span><span class="p">(</span><span class="n">ModelBuilder</span> <span class="n">modelBuilder</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">modelBuilder</span><span class="p">.</span><span class="n">Entity</span><span class="p">&lt;</span><span class="n">PaymentTransaction</span><span class="p">&gt;(</span><span class="n">entity</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="n">entity</span><span class="p">.</span><span class="nf">HasIndex</span><span class="p">(</span><span class="n">e</span> <span class="p">=&gt;</span> <span class="n">e</span><span class="p">.</span><span class="n">OrderId</span><span class="p">);</span>
                <span class="n">entity</span><span class="p">.</span><span class="nf">HasIndex</span><span class="p">(</span><span class="n">e</span> <span class="p">=&gt;</span> <span class="n">e</span><span class="p">.</span><span class="n">TransactionId</span><span class="p">);</span>
                <span class="n">entity</span><span class="p">.</span><span class="nf">HasIndex</span><span class="p">(</span><span class="n">e</span> <span class="p">=&gt;</span> <span class="n">e</span><span class="p">.</span><span class="n">CustomerEmail</span><span class="p">);</span>
                <span class="n">entity</span><span class="p">.</span><span class="nf">Property</span><span class="p">(</span><span class="n">e</span> <span class="p">=&gt;</span> <span class="n">e</span><span class="p">.</span><span class="n">TransactionId</span><span class="p">).</span><span class="nf">IsRequired</span><span class="p">();</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="servicespaymentprocessorcs"><strong>Services/PaymentProcessor.cs</strong></h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">Microsoft.Extensions.Logging</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Payment.API.Services</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">interface</span> <span class="nc">IPaymentProcessor</span>
    <span class="p">{</span>
        <span class="n">Task</span><span class="p">&lt;</span><span class="n">PaymentResult</span><span class="p">&gt;</span> <span class="nf">ProcessPaymentAsync</span><span class="p">(</span><span class="kt">decimal</span> <span class="n">amount</span><span class="p">,</span> <span class="kt">string</span> <span class="n">customerEmail</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">class</span> <span class="nc">PaymentProcessor</span> <span class="p">:</span> <span class="n">IPaymentProcessor</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">ILogger</span><span class="p">&lt;</span><span class="n">PaymentProcessor</span><span class="p">&gt;</span> <span class="n">_logger</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">Random</span> <span class="n">_random</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Random</span><span class="p">();</span>

        <span class="k">public</span> <span class="nf">PaymentProcessor</span><span class="p">(</span><span class="n">ILogger</span><span class="p">&lt;</span><span class="n">PaymentProcessor</span><span class="p">&gt;</span> <span class="n">logger</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_logger</span> <span class="p">=</span> <span class="n">logger</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">PaymentResult</span><span class="p">&gt;</span> <span class="nf">ProcessPaymentAsync</span><span class="p">(</span><span class="kt">decimal</span> <span class="n">amount</span><span class="p">,</span> <span class="kt">string</span> <span class="n">customerEmail</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">$"Processing payment of $</span><span class="p">{</span><span class="n">amount</span><span class="p">}</span><span class="s"> for </span><span class="p">{</span><span class="n">customerEmail</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
            
            <span class="c1">// Simulate payment processing time</span>
            <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Delay</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">2</span><span class="p">));</span>

            <span class="c1">// Simulate payment success/failure (90% success rate for demo)</span>
            <span class="kt">var</span> <span class="n">isSuccess</span> <span class="p">=</span> <span class="n">_random</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">101</span><span class="p">)</span> <span class="p">&lt;=</span> <span class="m">90</span><span class="p">;</span>
            
            <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">new</span> <span class="n">PaymentResult</span>
            <span class="p">{</span>
                <span class="n">IsSuccess</span> <span class="p">=</span> <span class="n">isSuccess</span><span class="p">,</span>
                <span class="n">TransactionId</span> <span class="p">=</span> <span class="n">Guid</span><span class="p">.</span><span class="nf">NewGuid</span><span class="p">().</span><span class="nf">ToString</span><span class="p">(</span><span class="s">"N"</span><span class="p">)[..</span><span class="m">16</span><span class="p">].</span><span class="nf">ToUpper</span><span class="p">(),</span>
                <span class="n">Amount</span> <span class="p">=</span> <span class="n">amount</span><span class="p">,</span>
                <span class="n">ProcessedAt</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">UtcNow</span>
            <span class="p">};</span>

            <span class="k">if</span> <span class="p">(!</span><span class="n">isSuccess</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">failureReasons</span> <span class="p">=</span> <span class="k">new</span><span class="p">[]</span>
                <span class="p">{</span>
                    <span class="s">"Insufficient funds"</span><span class="p">,</span>
                    <span class="s">"Card expired"</span><span class="p">,</span>
                    <span class="s">"Card declined"</span><span class="p">,</span>
                    <span class="s">"Invalid card number"</span><span class="p">,</span>
                    <span class="s">"Processing error"</span>
                <span class="p">};</span>
                <span class="n">result</span><span class="p">.</span><span class="n">FailureReason</span> <span class="p">=</span> <span class="n">failureReasons</span><span class="p">[</span><span class="n">_random</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="n">failureReasons</span><span class="p">.</span><span class="n">Length</span><span class="p">)];</span>
            <span class="p">}</span>

            <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">$"Payment result: </span><span class="p">{(</span><span class="n">isSuccess</span> <span class="p">?</span> <span class="s">"Success"</span> <span class="p">:</span> <span class="s">"Failed"</span><span class="p">)}</span><span class="s"> - </span><span class="p">{</span><span class="n">result</span><span class="p">.</span><span class="n">TransactionId</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">class</span> <span class="nc">PaymentResult</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">bool</span> <span class="n">IsSuccess</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">TransactionId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">decimal</span> <span class="n">Amount</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="n">DateTime</span> <span class="n">ProcessedAt</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">FailureReason</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="servicesinventoryreservedlistenercs"><strong>Services/InventoryReservedListener.cs</strong></h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.DependencyInjection</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.Hosting</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.Logging</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Text.Json</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Payment.API.Data</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Payment.API.Models</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Payment.API.Services</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Plain.RabbitMQ</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Shared.Models</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Payment.API.Services</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">InventoryReservedListener</span> <span class="p">:</span> <span class="n">IHostedService</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">ISubscriber</span> <span class="n">_subscriber</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IPublisher</span> <span class="n">_publisher</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IServiceScopeFactory</span> <span class="n">_scopeFactory</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">ILogger</span><span class="p">&lt;</span><span class="n">InventoryReservedListener</span><span class="p">&gt;</span> <span class="n">_logger</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">InventoryReservedListener</span><span class="p">(</span>
            <span class="n">ISubscriber</span> <span class="n">subscriber</span><span class="p">,</span>
            <span class="n">IPublisher</span> <span class="n">publisher</span><span class="p">,</span>
            <span class="n">IServiceScopeFactory</span> <span class="n">scopeFactory</span><span class="p">,</span>
            <span class="n">ILogger</span><span class="p">&lt;</span><span class="n">InventoryReservedListener</span><span class="p">&gt;</span> <span class="n">logger</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_subscriber</span> <span class="p">=</span> <span class="n">subscriber</span><span class="p">;</span>
            <span class="n">_publisher</span> <span class="p">=</span> <span class="n">publisher</span><span class="p">;</span>
            <span class="n">_scopeFactory</span> <span class="p">=</span> <span class="n">scopeFactory</span><span class="p">;</span>
            <span class="n">_logger</span> <span class="p">=</span> <span class="n">logger</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">Task</span> <span class="nf">StartAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_subscriber</span><span class="p">.</span><span class="nf">Subscribe</span><span class="p">(</span><span class="n">ProcessInventoryReserved</span><span class="p">);</span>
            <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">"Inventory Reserved Listener started"</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">CompletedTask</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="kt">bool</span> <span class="nf">ProcessInventoryReserved</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">,</span> <span class="n">IDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;</span> <span class="n">headers</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">PaymentProcessedEvent</span> <span class="n">response</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">$"Received inventory reserved event: </span><span class="p">{</span><span class="n">message</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
                <span class="kt">var</span> <span class="n">inventoryEvent</span> <span class="p">=</span> <span class="n">JsonSerializer</span><span class="p">.</span><span class="n">Deserialize</span><span class="p">&lt;</span><span class="n">InventoryReservedEvent</span><span class="p">&gt;(</span><span class="n">message</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">inventoryEvent</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">_logger</span><span class="p">.</span><span class="nf">LogError</span><span class="p">(</span><span class="s">"Failed to deserialize inventory reserved event"</span><span class="p">);</span>
                    <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="n">response</span> <span class="p">=</span> <span class="k">new</span> <span class="n">PaymentProcessedEvent</span>
                <span class="p">{</span>
                    <span class="n">OrderId</span> <span class="p">=</span> <span class="n">inventoryEvent</span><span class="p">.</span><span class="n">OrderId</span><span class="p">,</span>
                    <span class="n">ProductId</span> <span class="p">=</span> <span class="n">inventoryEvent</span><span class="p">.</span><span class="n">ProductId</span><span class="p">,</span>
                    <span class="n">Amount</span> <span class="p">=</span> <span class="n">inventoryEvent</span><span class="p">.</span><span class="n">TotalAmount</span><span class="p">,</span>
                    <span class="n">CustomerEmail</span> <span class="p">=</span> <span class="n">inventoryEvent</span><span class="p">.</span><span class="n">CustomerEmail</span>
                <span class="p">};</span>

                <span class="k">if</span> <span class="p">(!</span><span class="n">inventoryEvent</span><span class="p">.</span><span class="n">IsSuccess</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="c1">// Inventory reservation failed, no payment needed</span>
                    <span class="n">response</span><span class="p">.</span><span class="n">IsSuccess</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
                    <span class="n">response</span><span class="p">.</span><span class="n">Message</span> <span class="p">=</span> <span class="s">"Payment skipped due to inventory failure"</span><span class="p">;</span>
                    <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">$"Skipping payment for order </span><span class="p">{</span><span class="n">inventoryEvent</span><span class="p">.</span><span class="n">OrderId</span><span class="p">}</span><span class="s"> due to inventory failure"</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="c1">// Process payment</span>
                    <span class="k">using</span> <span class="nn">var</span> <span class="n">scope</span> <span class="p">=</span> <span class="n">_scopeFactory</span><span class="p">.</span><span class="nf">CreateScope</span><span class="p">();</span>
                    <span class="kt">var</span> <span class="n">context</span> <span class="p">=</span> <span class="n">scope</span><span class="p">.</span><span class="n">ServiceProvider</span><span class="p">.</span><span class="n">GetRequiredService</span><span class="p">&lt;</span><span class="n">PaymentDbContext</span><span class="p">&gt;();</span>
                    <span class="kt">var</span> <span class="n">paymentProcessor</span> <span class="p">=</span> <span class="n">scope</span><span class="p">.</span><span class="n">ServiceProvider</span><span class="p">.</span><span class="n">GetRequiredService</span><span class="p">&lt;</span><span class="n">IPaymentProcessor</span><span class="p">&gt;();</span>

                    <span class="c1">// Create payment record</span>
                    <span class="kt">var</span> <span class="n">payment</span> <span class="p">=</span> <span class="k">new</span> <span class="n">PaymentTransaction</span>
                    <span class="p">{</span>
                        <span class="n">OrderId</span> <span class="p">=</span> <span class="n">inventoryEvent</span><span class="p">.</span><span class="n">OrderId</span><span class="p">,</span>
                        <span class="n">ProductId</span> <span class="p">=</span> <span class="n">inventoryEvent</span><span class="p">.</span><span class="n">ProductId</span><span class="p">,</span>
                        <span class="n">Amount</span> <span class="p">=</span> <span class="n">inventoryEvent</span><span class="p">.</span><span class="n">TotalAmount</span><span class="p">,</span>
                        <span class="n">CustomerEmail</span> <span class="p">=</span> <span class="n">inventoryEvent</span><span class="p">.</span><span class="n">CustomerEmail</span><span class="p">,</span>
                        <span class="n">Status</span> <span class="p">=</span> <span class="s">"Processing"</span>
                    <span class="p">};</span>

                    <span class="n">context</span><span class="p">.</span><span class="n">PaymentTransactions</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">payment</span><span class="p">);</span>
                    <span class="n">context</span><span class="p">.</span><span class="nf">SaveChanges</span><span class="p">();</span>

                    <span class="c1">// Process payment</span>
                    <span class="kt">var</span> <span class="n">paymentResult</span> <span class="p">=</span> <span class="n">paymentProcessor</span><span class="p">.</span><span class="nf">ProcessPaymentAsync</span><span class="p">(</span>
                        <span class="n">inventoryEvent</span><span class="p">.</span><span class="n">TotalAmount</span><span class="p">,</span> 
                        <span class="n">inventoryEvent</span><span class="p">.</span><span class="n">CustomerEmail</span><span class="p">).</span><span class="n">Result</span><span class="p">;</span>

                    <span class="c1">// Update payment record</span>
                    <span class="n">payment</span><span class="p">.</span><span class="n">Status</span> <span class="p">=</span> <span class="n">paymentResult</span><span class="p">.</span><span class="n">IsSuccess</span> <span class="p">?</span> <span class="s">"Completed"</span> <span class="p">:</span> <span class="s">"Failed"</span><span class="p">;</span>
                    <span class="n">payment</span><span class="p">.</span><span class="n">TransactionId</span> <span class="p">=</span> <span class="n">paymentResult</span><span class="p">.</span><span class="n">TransactionId</span><span class="p">;</span>
                    <span class="n">payment</span><span class="p">.</span><span class="n">ProcessedAt</span> <span class="p">=</span> <span class="n">paymentResult</span><span class="p">.</span><span class="n">ProcessedAt</span><span class="p">;</span>
                    <span class="n">payment</span><span class="p">.</span><span class="n">FailureReason</span> <span class="p">=</span> <span class="n">paymentResult</span><span class="p">.</span><span class="n">FailureReason</span><span class="p">;</span>
                    <span class="n">payment</span><span class="p">.</span><span class="n">ExternalTransactionId</span> <span class="p">=</span> <span class="n">paymentResult</span><span class="p">.</span><span class="n">TransactionId</span><span class="p">;</span>

                    <span class="n">context</span><span class="p">.</span><span class="nf">SaveChanges</span><span class="p">();</span>

                    <span class="c1">// Prepare response</span>
                    <span class="n">response</span><span class="p">.</span><span class="n">IsSuccess</span> <span class="p">=</span> <span class="n">paymentResult</span><span class="p">.</span><span class="n">IsSuccess</span><span class="p">;</span>
                    <span class="n">response</span><span class="p">.</span><span class="n">TransactionId</span> <span class="p">=</span> <span class="n">paymentResult</span><span class="p">.</span><span class="n">TransactionId</span><span class="p">;</span>
                    <span class="n">response</span><span class="p">.</span><span class="n">Message</span> <span class="p">=</span> <span class="n">paymentResult</span><span class="p">.</span><span class="n">IsSuccess</span> 
                        <span class="p">?</span> <span class="s">"Payment processed successfully"</span> 
                        <span class="p">:</span> <span class="s">$"Payment failed: </span><span class="p">{</span><span class="n">paymentResult</span><span class="p">.</span><span class="n">FailureReason</span><span class="p">}</span><span class="s">"</span><span class="p">;</span>

                    <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">$"Payment processing completed for order </span><span class="p">{</span><span class="n">inventoryEvent</span><span class="p">.</span><span class="n">OrderId</span><span class="p">}</span><span class="s">: "</span> <span class="p">+</span>
                                         <span class="s">$"</span><span class="p">{(</span><span class="n">paymentResult</span><span class="p">.</span><span class="n">IsSuccess</span> <span class="p">?</span> <span class="s">"Success"</span> <span class="p">:</span> <span class="s">"Failed"</span><span class="p">)}</span><span class="s">"</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="c1">// Publish payment response</span>
                <span class="n">_publisher</span><span class="p">.</span><span class="nf">Publish</span><span class="p">(</span>
                    <span class="n">JsonSerializer</span><span class="p">.</span><span class="nf">Serialize</span><span class="p">(</span><span class="n">response</span><span class="p">),</span>
                    <span class="s">"payment.processed"</span><span class="p">,</span>
                    <span class="k">null</span><span class="p">);</span>

                <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">_logger</span><span class="p">.</span><span class="nf">LogError</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">"Error processing inventory reserved event"</span><span class="p">);</span>
                
                <span class="c1">// Publish failure response</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">response</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">response</span><span class="p">.</span><span class="n">IsSuccess</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
                    <span class="n">response</span><span class="p">.</span><span class="n">Message</span> <span class="p">=</span> <span class="s">"Internal error processing payment"</span><span class="p">;</span>
                    
                    <span class="n">_publisher</span><span class="p">.</span><span class="nf">Publish</span><span class="p">(</span>
                        <span class="n">JsonSerializer</span><span class="p">.</span><span class="nf">Serialize</span><span class="p">(</span><span class="n">response</span><span class="p">),</span>
                        <span class="s">"payment.processed"</span><span class="p">,</span>
                        <span class="k">null</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">Task</span> <span class="nf">StopAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">"Inventory Reserved Listener stopped"</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">CompletedTask</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<h3 id="controllerspaymentscontrollercs"><strong>Controllers/PaymentsController.cs</strong></h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Mvc</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.EntityFrameworkCore</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Payment.API.Data</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Payment.API.Models</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Payment.API.Controllers</span>
<span class="p">{</span>
    <span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"api/[controller]"</span><span class="p">)]</span>
    <span class="p">[</span><span class="n">ApiController</span><span class="p">]</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">PaymentsController</span> <span class="p">:</span> <span class="n">ControllerBase</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">PaymentDbContext</span> <span class="n">_context</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">ILogger</span><span class="p">&lt;</span><span class="n">PaymentsController</span><span class="p">&gt;</span> <span class="n">_logger</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">PaymentsController</span><span class="p">(</span><span class="n">PaymentDbContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">ILogger</span><span class="p">&lt;</span><span class="n">PaymentsController</span><span class="p">&gt;</span> <span class="n">logger</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_context</span> <span class="p">=</span> <span class="n">context</span><span class="p">;</span>
            <span class="n">_logger</span> <span class="p">=</span> <span class="n">logger</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="n">HttpGet</span><span class="p">]</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">ActionResult</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">PaymentTransaction</span><span class="p">&gt;&gt;&gt;</span> <span class="nf">GetPayments</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">_context</span><span class="p">.</span><span class="n">PaymentTransactions</span>
                <span class="p">.</span><span class="nf">OrderByDescending</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">CreatedAt</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">ToListAsync</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="nf">HttpGet</span><span class="p">(</span><span class="s">"{id}"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">ActionResult</span><span class="p">&lt;</span><span class="n">PaymentTransaction</span><span class="p">&gt;&gt;</span> <span class="nf">GetPayment</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">payment</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_context</span><span class="p">.</span><span class="n">PaymentTransactions</span><span class="p">.</span><span class="nf">FindAsync</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">payment</span> <span class="p">==</span> <span class="k">null</span> <span class="p">?</span> <span class="nf">NotFound</span><span class="p">()</span> <span class="p">:</span> <span class="n">payment</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="nf">HttpGet</span><span class="p">(</span><span class="s">"order/{orderId}"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">ActionResult</span><span class="p">&lt;</span><span class="n">PaymentTransaction</span><span class="p">&gt;&gt;</span> <span class="nf">GetPaymentByOrder</span><span class="p">(</span><span class="kt">int</span> <span class="n">orderId</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">payment</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_context</span><span class="p">.</span><span class="n">PaymentTransactions</span>
                <span class="p">.</span><span class="nf">FirstOrDefaultAsync</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">OrderId</span> <span class="p">==</span> <span class="n">orderId</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">payment</span> <span class="p">==</span> <span class="k">null</span> <span class="p">?</span> <span class="nf">NotFound</span><span class="p">()</span> <span class="p">:</span> <span class="n">payment</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="nf">HttpGet</span><span class="p">(</span><span class="s">"transaction/{transactionId}"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">ActionResult</span><span class="p">&lt;</span><span class="n">PaymentTransaction</span><span class="p">&gt;&gt;</span> <span class="nf">GetPaymentByTransaction</span><span class="p">(</span><span class="kt">string</span> <span class="n">transactionId</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">payment</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_context</span><span class="p">.</span><span class="n">PaymentTransactions</span>
                <span class="p">.</span><span class="nf">FirstOrDefaultAsync</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">TransactionId</span> <span class="p">==</span> <span class="n">transactionId</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">payment</span> <span class="p">==</span> <span class="k">null</span> <span class="p">?</span> <span class="nf">NotFound</span><span class="p">()</span> <span class="p">:</span> <span class="n">payment</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="appsettingsjson-2"><strong>appsettings.json</strong></h3>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"Logging"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"LogLevel"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Default"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Information"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Microsoft.AspNetCore"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Warning"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Microsoft.EntityFrameworkCore"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Warning"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"ConnectionStrings"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"DefaultConnection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Data Source=payments.db"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"PaymentSettings"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"SuccessRate"</span><span class="p">:</span><span class="w"> </span><span class="mi">90</span><span class="p">,</span><span class="w">
    </span><span class="nl">"ProcessingDelayMs"</span><span class="p">:</span><span class="w"> </span><span class="mi">2000</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"AllowedHosts"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="programcs-2"><strong>Program.cs</strong></h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">using</span> <span class="nn">Microsoft.EntityFrameworkCore</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Payment.API.Data</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Payment.API.Services</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Plain.RabbitMQ</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">RabbitMQ.Client</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Payment.API</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">builder</span> <span class="p">=</span> <span class="n">WebApplication</span><span class="p">.</span><span class="nf">CreateBuilder</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>

            <span class="c1">// Add services</span>
            <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="nf">AddControllers</span><span class="p">();</span>
            <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="nf">AddEndpointsApiExplorer</span><span class="p">();</span>
            <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="nf">AddSwaggerGen</span><span class="p">();</span>

            <span class="c1">// Database</span>
            <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddDbContext</span><span class="p">&lt;</span><span class="n">PaymentDbContext</span><span class="p">&gt;(</span><span class="n">options</span> <span class="p">=&gt;</span>
                <span class="n">options</span><span class="p">.</span><span class="nf">UseSqlite</span><span class="p">(</span><span class="n">builder</span><span class="p">.</span><span class="n">Configuration</span><span class="p">.</span><span class="nf">GetConnectionString</span><span class="p">(</span><span class="s">"DefaultConnection"</span><span class="p">)));</span>

            <span class="c1">// Payment Service</span>
            <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddScoped</span><span class="p">&lt;</span><span class="n">IPaymentProcessor</span><span class="p">,</span> <span class="n">PaymentProcessor</span><span class="p">&gt;();</span>

            <span class="c1">// RabbitMQ Configuration</span>
            <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">IConnectionProvider</span><span class="p">&gt;(</span>
                <span class="k">new</span> <span class="nf">ConnectionProvider</span><span class="p">(</span><span class="s">"amqp://guest:guest@localhost:5672"</span><span class="p">));</span>

            <span class="c1">// Publisher for Payment events</span>
            <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">IPublisher</span><span class="p">&gt;(</span><span class="n">provider</span> <span class="p">=&gt;</span>
                <span class="k">new</span> <span class="nf">Publisher</span><span class="p">(</span>
                    <span class="n">provider</span><span class="p">.</span><span class="n">GetService</span><span class="p">&lt;</span><span class="n">IConnectionProvider</span><span class="p">&gt;(),</span>
                    <span class="s">"payment.exchange"</span><span class="p">,</span>
                    <span class="n">ExchangeType</span><span class="p">.</span><span class="n">Topic</span><span class="p">));</span>

            <span class="c1">// Subscriber for Inventory events</span>
            <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">ISubscriber</span><span class="p">&gt;(</span><span class="n">provider</span> <span class="p">=&gt;</span>
                <span class="k">new</span> <span class="nf">Subscriber</span><span class="p">(</span>
                    <span class="n">provider</span><span class="p">.</span><span class="n">GetService</span><span class="p">&lt;</span><span class="n">IConnectionProvider</span><span class="p">&gt;(),</span>
                    <span class="s">"inventory.exchange"</span><span class="p">,</span>
                    <span class="s">"inventory.reserved.queue"</span><span class="p">,</span>
                    <span class="s">"inventory.reserved"</span><span class="p">,</span>
                    <span class="n">ExchangeType</span><span class="p">.</span><span class="n">Topic</span><span class="p">));</span>

            <span class="c1">// Background Services</span>
            <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddHostedService</span><span class="p">&lt;</span><span class="n">InventoryReservedListener</span><span class="p">&gt;();</span>

            <span class="kt">var</span> <span class="n">app</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">Build</span><span class="p">();</span>

            <span class="c1">// Configure the HTTP request pipeline</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="n">Environment</span><span class="p">.</span><span class="nf">IsDevelopment</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="n">app</span><span class="p">.</span><span class="nf">UseSwagger</span><span class="p">();</span>
                <span class="n">app</span><span class="p">.</span><span class="nf">UseSwaggerUI</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="n">app</span><span class="p">.</span><span class="nf">UseHttpsRedirection</span><span class="p">();</span>
            <span class="n">app</span><span class="p">.</span><span class="nf">UseAuthorization</span><span class="p">();</span>
            <span class="n">app</span><span class="p">.</span><span class="nf">MapControllers</span><span class="p">();</span>

            <span class="c1">// Ensure database is created</span>
            <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">scope</span> <span class="p">=</span> <span class="n">app</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="nf">CreateScope</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">context</span> <span class="p">=</span> <span class="n">scope</span><span class="p">.</span><span class="n">ServiceProvider</span><span class="p">.</span><span class="n">GetRequiredService</span><span class="p">&lt;</span><span class="n">PaymentDbContext</span><span class="p">&gt;();</span>
                <span class="n">context</span><span class="p">.</span><span class="n">Database</span><span class="p">.</span><span class="nf">EnsureCreated</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="n">app</span><span class="p">.</span><span class="nf">Run</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Run <code class="language-plaintext highlighter-rouge">dotnet build</code> to ensure everything compiles successfully.</li>
</ul>

<h2 id="step-7-configure-multiple-startup-projects"><strong>Step 7: Configure Multiple Startup Projects</strong></h2>

<ol>
  <li>In Visual Studio, right-click solution → <strong>“Set StartUp Projects”</strong></li>
  <li>Select <strong>“Multiple startup projects”</strong></li>
  <li>Set <strong>Order.API</strong>, <strong>Catalog.API</strong>, and <strong>Payment.API</strong> to <strong>“Start”</strong></li>
  <li>Configure different ports in <code class="language-plaintext highlighter-rouge">launchSettings.json</code>:
    <ul>
      <li>Order.API: <code class="language-plaintext highlighter-rouge">https://localhost:7001</code></li>
      <li>Catalog.API: <code class="language-plaintext highlighter-rouge">https://localhost:7002</code></li>
      <li>Payment.API: <code class="language-plaintext highlighter-rouge">https://localhost:7003</code></li>
    </ul>
  </li>
</ol>

<h2 id="step-8-testing-the-enhanced-saga-implementation"><strong>Step 8: Testing the Enhanced SAGA Implementation</strong></h2>

<h3 id="test-scenario-1-complete-success-flow-happy-path"><strong>Test Scenario 1: Complete Success Flow (Happy Path)</strong></h3>

<ol>
  <li><strong>Check Products</strong>: Open Catalog.API Swagger at <code class="language-plaintext highlighter-rouge">https://localhost:7002/swagger</code>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /api/products
</code></pre></div>    </div>
  </li>
  <li><strong>Create Order</strong>: Open Order.API Swagger at <code class="language-plaintext highlighter-rouge">https://localhost:7001/swagger</code>
    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">POST</span><span class="w"> </span><span class="err">/api/orders</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"productId"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
  </span><span class="nl">"productName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Gaming Laptop"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"quantity"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
  </span><span class="nl">"unitPrice"</span><span class="p">:</span><span class="w"> </span><span class="mf">1299.99</span><span class="p">,</span><span class="w">
  </span><span class="nl">"customerEmail"</span><span class="p">:</span><span class="w"> </span><span class="s2">"customer@example.com"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li><strong>Expected Flow</strong>:
    <ul>
      <li>Order status: Pending → InventoryReserved → PaymentProcessing → Confirmed</li>
      <li>Inventory: Available stock decreases, reserved stock increases</li>
      <li>Payment: Transaction created and processed successfully</li>
    </ul>
  </li>
  <li><strong>Verify Results</strong>:
    <ul>
      <li>Order status should be “Confirmed”</li>
      <li>Product inventory properly updated</li>
      <li>Payment transaction completed in Payment.API</li>
    </ul>
  </li>
</ol>

<h3 id="test-scenario-2-inventory-failure-immediate-compensation"><strong>Test Scenario 2: Inventory Failure (Immediate Compensation)</strong></h3>

<ol>
  <li><strong>Create Large Order</strong>:
    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">POST</span><span class="w"> </span><span class="err">/api/orders</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"productId"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
  </span><span class="nl">"productName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Gaming Laptop"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"quantity"</span><span class="p">:</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w">
  </span><span class="nl">"unitPrice"</span><span class="p">:</span><span class="w"> </span><span class="mf">1299.99</span><span class="p">,</span><span class="w">
  </span><span class="nl">"customerEmail"</span><span class="p">:</span><span class="w"> </span><span class="s2">"customer@example.com"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li><strong>Expected Flow</strong>:
    <ul>
      <li>Order status: Pending → Cancelled</li>
      <li>No inventory changes</li>
      <li>No payment attempted</li>
    </ul>
  </li>
</ol>

<h3 id="test-scenario-3-payment-failure-multi-step-compensation"><strong>Test Scenario 3: Payment Failure (Multi-step Compensation)</strong></h3>

<ol>
  <li><strong>Create Valid Order</strong> (payment service has ~10% failure rate for demo):
    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">POST</span><span class="w"> </span><span class="err">/api/orders</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"productId"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
  </span><span class="nl">"productName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Gaming Laptop"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"quantity"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
  </span><span class="nl">"unitPrice"</span><span class="p">:</span><span class="w"> </span><span class="mf">1299.99</span><span class="p">,</span><span class="w">
  </span><span class="nl">"customerEmail"</span><span class="p">:</span><span class="w"> </span><span class="s2">"customer@example.com"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li><strong>If Payment Fails, Observe</strong>:
    <ul>
      <li>Order status: Pending → InventoryReserved → Cancelled</li>
      <li>Reserved inventory released back to available stock</li>
      <li>Payment transaction marked as failed</li>
    </ul>
  </li>
</ol>

<h3 id="test-scenario-4-non-existent-product"><strong>Test Scenario 4: Non-existent Product</strong></h3>

<ol>
  <li><strong>Create Invalid Order</strong>:
    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">POST</span><span class="w"> </span><span class="err">/api/orders</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"productId"</span><span class="p">:</span><span class="w"> </span><span class="mi">999</span><span class="p">,</span><span class="w">
  </span><span class="nl">"productName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Non-existent Product"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"quantity"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
  </span><span class="nl">"unitPrice"</span><span class="p">:</span><span class="w"> </span><span class="mf">100.00</span><span class="p">,</span><span class="w">
  </span><span class="nl">"customerEmail"</span><span class="p">:</span><span class="w"> </span><span class="s2">"customer@example.com"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li><strong>Expected Results</strong>:
    <ul>
      <li>Order cancelled immediately</li>
      <li>Error message: “Product with ID 999 not found”</li>
    </ul>
  </li>
</ol>

<h3 id="monitor-the-complete-flow"><strong>Monitor the Complete Flow</strong></h3>

<p><strong>Using RabbitMQ Management UI:</strong></p>
<ol>
  <li>Open <code class="language-plaintext highlighter-rouge">http://localhost:15672</code></li>
  <li>Navigate to <strong>Exchanges</strong>:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">order.exchange</code> - Order events</li>
      <li><code class="language-plaintext highlighter-rouge">inventory.exchange</code> - Inventory events</li>
      <li><code class="language-plaintext highlighter-rouge">payment.exchange</code> - Payment events</li>
    </ul>
  </li>
  <li>Check <strong>Queues</strong>:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">order.created.queue</code></li>
      <li><code class="language-plaintext highlighter-rouge">inventory.response.queue</code></li>
      <li><code class="language-plaintext highlighter-rouge">payment.response.queue</code></li>
      <li><code class="language-plaintext highlighter-rouge">inventory.release.queue</code></li>
    </ul>
  </li>
</ol>

<p><strong>Service Logs Monitoring:</strong>
Watch the console logs of all three services to see:</p>
<ul>
  <li>Event publishing and receiving</li>
  <li>Business logic processing</li>
  <li>Compensation actions</li>
  <li>Error handling</li>
</ul>

<p><strong>APIs for Verification:</strong></p>
<ul>
  <li><strong>Orders</strong>: <code class="language-plaintext highlighter-rouge">GET https://localhost:7001/api/orders</code></li>
  <li><strong>Products</strong>: <code class="language-plaintext highlighter-rouge">GET https://localhost:7002/api/products</code></li>
  <li><strong>Payments</strong>: <code class="language-plaintext highlighter-rouge">GET https://localhost:7003/api/payments</code></li>
</ul>

<hr />

<h2 id="step-9-understanding-the-enhanced-saga-flow"><strong>Step 9: Understanding the Enhanced SAGA Flow</strong></h2>

<h3 id="complete-success-flow"><strong>Complete Success Flow:</strong></h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1. Customer creates order via Order.API
2. Order.API saves order with "Pending" status
3. Order.API publishes OrderCreatedEvent to RabbitMQ
4. Catalog.API receives OrderCreatedEvent
5. Catalog.API reserves inventory and publishes InventoryReservedEvent
6. Order.API updates order status to "InventoryReserved"
7. Payment.API receives InventoryReservedEvent
8. Payment.API processes payment and publishes PaymentProcessedEvent
9. Order.API receives PaymentProcessedEvent (success) and updates to "Confirmed"
10. Catalog.API receives PaymentProcessedEvent (inventory reservation committed)
</code></pre></div></div>

<h3 id="compensation-flow-inventory-failure"><strong>Compensation Flow (Inventory Failure):</strong></h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1. Customer creates order via Order.API
2. Order.API saves order with "Pending" status
3. Order.API publishes OrderCreatedEvent to RabbitMQ
4. Catalog.API receives OrderCreatedEvent
5. Catalog.API detects insufficient stock
6. Catalog.API publishes InventoryReservedEvent (success=false)
7. Order.API receives InventoryReservedEvent and updates to "Cancelled"
</code></pre></div></div>

<h3 id="compensation-flow-payment-failure"><strong>Compensation Flow (Payment Failure):</strong></h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1-6. Same as success flow through inventory reservation
7. Payment.API processes payment and fails
8. Payment.API publishes PaymentProcessedEvent (success=false)
9. Order.API receives PaymentProcessedEvent and updates to "Cancelled"
10. Order.API publishes InventoryReleaseEvent for compensation
11. Catalog.API receives InventoryReleaseEvent and releases reserved inventory
</code></pre></div></div>

<h3 id="enhanced-business-logic-features"><strong>Enhanced Business Logic Features:</strong></h3>

<p><strong>Order Status Tracking:</strong></p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">Pending</code> - Order created, awaiting inventory check</li>
  <li><code class="language-plaintext highlighter-rouge">InventoryReserved</code> - Inventory allocated, awaiting payment</li>
  <li><code class="language-plaintext highlighter-rouge">PaymentProcessing</code> - Payment being processed</li>
  <li><code class="language-plaintext highlighter-rouge">Confirmed</code> - All steps successful</li>
  <li><code class="language-plaintext highlighter-rouge">Cancelled</code> - Failed at any step</li>
</ul>

<p><strong>Inventory Management:</strong></p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">AvailableStock</code> - Immediately available for new orders</li>
  <li><code class="language-plaintext highlighter-rouge">ReservedStock</code> - Allocated to pending orders awaiting payment</li>
  <li>Automatic release of reservations when payments fail</li>
</ul>

<p><strong>Payment Processing:</strong></p>
<ul>
  <li>Realistic payment simulation with configurable failure rates</li>
  <li>Transaction tracking with external transaction IDs</li>
  <li>Detailed failure reason tracking</li>
</ul>

<hr />

<h2 id="production-considerations"><strong>Production Considerations</strong></h2>

<h3 id="error-handling-and-resilience"><strong>Error Handling and Resilience</strong></h3>
<ul>
  <li><strong>Retry Logic</strong>: Implement exponential backoff for failed messages</li>
  <li><strong>Dead Letter Queues</strong>: Handle messages that fail repeatedly</li>
  <li><strong>Idempotency</strong>: Ensure message processing is idempotent</li>
  <li><strong>Timeouts</strong>: Implement timeouts for long-running processes</li>
</ul>

<h3 id="monitoring-and-observability"><strong>Monitoring and Observability</strong></h3>
<ul>
  <li><strong>Correlation IDs</strong>: Track requests across services</li>
  <li><strong>Structured Logging</strong>: Use structured logging for better searchability</li>
  <li><strong>Health Checks</strong>: Implement health checks for all services</li>
  <li><strong>Metrics</strong>: Monitor message processing rates and errors</li>
</ul>

<h3 id="data-consistency"><strong>Data Consistency</strong></h3>
<ul>
  <li><strong>Event Sourcing</strong>: Consider event sourcing for audit trails</li>
  <li><strong>Outbox Pattern</strong>: Ensure reliable message publishing</li>
  <li><strong>Saga State Management</strong>: Track saga state for complex workflows</li>
</ul>

<p>Hopefully, this enhanced implementation provides a robust foundation for distributed transactions using the SAGA pattern with RabbitMQ and ASP.NET Core. If you have any questions or need further assistance, feel free to ask in the comments! If you found this guide helpful, please share it with your network. Happy coding!</p>

<hr />

<p><strong><a href="https://github.com/mahedee/code-sample02/tree/main/saga-choreography-v02">Complete Source Code on GitHub</a></strong></p>

        
        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#aspnetcore" class="page__taxonomy-item" rel="tag">aspnetcore</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#choreography" class="page__taxonomy-item" rel="tag">choreography</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#dataconsistency" class="page__taxonomy-item" rel="tag">dataconsistency</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#designpattern" class="page__taxonomy-item" rel="tag">designpattern</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#distributedtransactions" class="page__taxonomy-item" rel="tag">distributedtransactions</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#eventdriven" class="page__taxonomy-item" rel="tag">eventdriven</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#microservices" class="page__taxonomy-item" rel="tag">microservices</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#rabbitmq" class="page__taxonomy-item" rel="tag">rabbitmq</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#saga" class="page__taxonomy-item" rel="tag">saga</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#asp-net-core" class="page__taxonomy-item" rel="tag">ASP.NET Core</a><span class="sep">, </span>
    
      
      
      <a href="/categories/#design-pattern" class="page__taxonomy-item" rel="tag">Design Pattern</a><span class="sep">, </span>
    
      
      
      <a href="/categories/#microservices" class="page__taxonomy-item" rel="tag">Microservices</a><span class="sep">, </span>
    
      
      
      <a href="/categories/#rabbitmq" class="page__taxonomy-item" rel="tag">RabbitMQ</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2026-01-04T00:00:00-05:00">January 04, 2026</time></p>
        
      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?text=Implementing+Distributed+Transactions+in+Microservices%3A+SAGA+Pattern+with+RabbitMQ+and+ASP.NET+Core%20https%3A%2F%2Fmahedee.net%2Fimplementing-distributed-transactions-saga-pattern-rabbitmq-aspnetcore.md%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fmahedee.net%2Fimplementing-distributed-transactions-saga-pattern-rabbitmq-aspnetcore.md%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fmahedee.net%2Fimplementing-distributed-transactions-saga-pattern-rabbitmq-aspnetcore.md%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/middleware-in-aspnet-core-why-it-matters-and-how-to-build-custom-middleware/" class="pagination--pager" title="Middleware in ASP.NET Core: Why It Matters and How to Build Custom Middleware with a Real-World Examples
">Previous</a>
    
    
      <a href="#" class="pagination--pager disabled">Next</a>
    
  </nav>

    </div>

    
      <div class="page__comments">
  
  
      <h4 class="page__comments-title">Comments</h4>
      <div id="fb-root"></div>
<script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v18.0&appId=1641495303280571"></script>

<div class="fb-comments" 
     data-href="https://mahedee.net/implementing-distributed-transactions-saga-pattern-rabbitmq-aspnetcore.md/" 
     data-width="100%" 
     data-numposts="10"
     data-colorscheme="light"
     data-order-by="social"
     data-mobile="true">
</div>
    
</div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src=
          
            "/assets/images/post_banner01.jpeg"
          
          alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/middleware-in-aspnet-core-why-it-matters-and-how-to-build-custom-middleware/" rel="permalink">Middleware in ASP.NET Core: Why It Matters and How to Build Custom Middleware with a Real-World Examples
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  6 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Learn why middleware matters in ASP.NET Core and how to build custom middleware with practical, real-world examples used in modern applications.
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src=
          
            "/assets/images/post_banner01.jpeg"
          
          alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/social-media-images-jekyll-minimal-mistakes/" rel="permalink">How to Configure Social Media Images for Jekyll Minimal Mistakes Blog
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  7 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Learn how to configure social media images for your Jekyll Minimal Mistakes blog to get beautiful thumbnails when sharing articles on Facebook, LinkedIn, Twi...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src=
          
            "/assets/images/post_banner01.jpeg"
          
          alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/procedural-vs-object-oriented-programming/" rel="permalink">Procedural vs Object-Oriented Programming: Key Differences Explained
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  5 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Discover the key differences between procedural and OOP paradigms. Compare data organization, reusability, and real-world applications in software development.
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src=
          
            "/assets/images/post_banner01.jpeg"
          
          alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/implementing-metrics-and-dashboards-dotnet-core-api-prometheus-grafana/" rel="permalink">Implementing Metrics and Dashboards for .NET Core APIs with Prometheus and Grafana
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  18 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Step-by-step tutorial to implement metrics and dashboards for .NET Core APIs using Prometheus and Grafana for effective monitoring.
</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>


      <!-- AdSense disabled:
      <ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3654930341568980"
     data-ad-slot="2244980843"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
     -->

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    <li><i class="fas fa-fw fa-award" aria-hidden="true"></i> <a href = "https://mvp.microsoft.com/en-us/PublicProfile/5001294">MVP Profile</a></li> 
    ||<li><i class="fas fa-fw fa-list-alt" aria-hidden="true"></i> <a href = "/categories/">Categories</a></li>
    ||<li><i class="fas fa-fw fa-code" aria-hidden="true"></i> <a href = "#">Programming</a></li>  
    ||<li><i class="fas fa-fw fa-globe" aria-hidden="true"></i> <a href = "/categories/#asp-net">ASP.NET</a></li> 
    ||<li><a href = "#">AI & ML</a></li>
    ||<li><a href = "#">Javascript</a></li>
    ||<li><a href = "#">Software Architecture</a></li>
    ||<li><a href = "#">Database</a></li>
    ||<li><a href = "#">OOP</a></li>
    ||<li><a href = "#">Design Pattern</a></li>  
    ||<li><a href = "#">Algorithm</a></li>
    ||<li><a href = "#">Interview Tips</a></li>
    ||<li><a href = "#">Opinions</a></li>
    ||<li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2026 Mahedee Hasan. 
  <!-- Powered by  -->
  <!-- <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>. -->
</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id="></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', '', { 'anonymize_ip': false});
</script>











        <!-- AdSense disabled: Add sense code for all page : added globaly
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3654930341568980"
        crossorigin="anonymous"></script>
        -->

  </body>
</html>
