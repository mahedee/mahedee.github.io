<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.16.6 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Application of Event Sourcing using asp.net core, DDD, EF, EventStoreDB and SQL Server - Think Simple</title>
<meta name="description" content="Event sourcing is a most important pattern to design a microservice based application. If you are working with multiple services in a microservice based application, you have to use event driven architecture. In this article I will discuss and apply event sourcing using asp.net core, DDD and EventStoreDB.">


  <meta name="author" content="Mahedee Hasan">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Think Simple">
<meta property="og:title" content="Application of Event Sourcing using asp.net core, DDD, EF, EventStoreDB and SQL Server">
<meta property="og:url" content="http://localhost:4000/Application-of-Event-Sourcing-using-aspnet-core-DDD-EF-EventStoreDB-and-SQL-Server/">


  <meta property="og:description" content="Event sourcing is a most important pattern to design a microservice based application. If you are working with multiple services in a microservice based application, you have to use event driven architecture. In this article I will discuss and apply event sourcing using asp.net core, DDD and EventStoreDB.">







  <meta property="article:published_time" content="2022-12-16T00:00:00-04:00">





  

  


<link rel="canonical" href="http://localhost:4000/Application-of-Event-Sourcing-using-aspnet-core-DDD-EF-EventStoreDB-and-SQL-Server/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Mahedee Hasan",
      "url": "http://localhost:4000/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Think Simple Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->


    <!-- Add sense code for all page : added globaly -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3654930341568980"
     crossorigin="anonymous"></script>
     
  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Think Simple
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/" >Home</a>
            </li><li class="masthead__menu-item">
              <a href="/categories" >Categories</a>
            </li><li class="masthead__menu-item">
              <a href="/about/" >About</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/assets/images/me.jpg" alt="Mahedee Hasan" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Mahedee Hasan</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>I am a Microsoft MVP (8th times), programmer, software developer, software architect, consultant, author, researcher, technical blogger, technical speaker, trainer and learner. I have more than 15 years experience in the field of software design and development.</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Dhaka, Bangladesh</span>
        </li>
      

      
        
          
            <li><a href="mailto:mahedee.hasan@gmail.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i> Email</a></li>
          
        
          
            <li><a href="https://mahedee.net" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-link" aria-hidden="true"></i> Website</a></li>
          
        
          
            <li><a href="https://mvp.microsoft.com/en-us/PublicProfile/5001294" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-award" aria-hidden="true"></i> MVP</a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/mahedee/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> LinkedIn</a></li>
          
        
          
            <li><a href="https://twitter.com/mahedeehasan" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
          
        
          
            <li><a href="https://facebook.com/mahedee19" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-facebook-square" aria-hidden="true"></i> Facebook</a></li>
          
        
          
            <li><a href="https://github.com/mahedee" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
          
        
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Application of Event Sourcing using asp.net core, DDD, EF, EventStoreDB and SQL Server">
    <meta itemprop="description" content="Event sourcing is a most important pattern to design a microservice based application. If you are working with multiple services in a microservice based application, you have to use event driven architecture. In this article I will discuss and apply event sourcing using asp.net core, DDD and EventStoreDB.">
    <meta itemprop="datePublished" content="December 16, 2022">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Application of Event Sourcing using asp.net core, DDD, EF, EventStoreDB and SQL Server
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  20 minute read
</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p><strong>Introduction</strong></p>

<p>Event sourcing is a most important pattern to design a microservice based application. If you are working with multiple services in a microservice based application, you have to use event driven architecture. In this article I will discuss and apply event sourcing using asp.net core, DDD and EventStoreDB.</p>

<p><strong>Domain Driven Design (DDD)</strong>_<br />
Domain-driven design (DDD) is a major software design approach, focusing on modeling software to match a domain according to input from that domainâ€™s experts.  Under domain-driven design, the structure and language of software code (class names, class methods, class variables) should match the business domain. (Wikipedia)</p>

<p><strong>Event Sourcing</strong><br />
Event sourcing is a technique to store all events of an Object to get all of its versions. Event sourcing pattern is used to implement microservice based application.  Using this pattern, we can track the changes of an object in its lifecycle.</p>

<p><strong>EventStoreDB</strong> 
EventStoreDB specially built for Event Sourcing. It is a NoSQL database. This is a one-way database â€“ we can only insert data into database.</p>

<p><strong>Implementation</strong><br />
Letâ€™s implement Event Sourcing using DDD and EventStoreDB.</p>

<p><strong>Tools and Technologies Used</strong></p>

<ul>
  <li>Visual Studio 2022</li>
  <li>.NET 6.0</li>
  <li>ASP.NET Core Web API</li>
  <li>Visual C#</li>
  <li>DDD</li>
  <li>EventStoreDB</li>
  <li>SQL Server</li>
</ul>

<p><strong>Step 1: Install EventStoreDB</strong></p>

<ul>
  <li>
    <p>You can install EventStoreDB using EventStoreDB documentation. Visit the following link : https://developers.eventstore.com/server/v20.10/installation.html#quick-start</p>
  </li>
  <li>
    <p>Or, you can run docker image of EventStoreDB as below.</p>
  </li>
</ul>

<div class="language-ps highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">docker</span> <span class="nb">run</span> <span class="nf">--name</span> <span class="nf">esdb-node</span> <span class="nf">-it</span> <span class="nf">-p</span> <span class="nf">2113:2113</span> <span class="nf">-p</span> <span class="nf">1113:1113</span> <span class="nf">eventstore</span><span class="nv">/eventstore:latest</span> <span class="nf">--insecure</span> <span class="nf">--run-projections=All</span> <span class="nf">--enable-external-tcp</span> <span class="nf">--enable-atom-pub-over-http</span>
</code></pre></div></div>

<ul>
  <li>Here I used docker images for EventStoreDB. After running the above command, browse EventStoreDB using the following link.</li>
</ul>

<p>http://localhost:2113/web/index.html#/dashboard</p>

<p><strong>Step 2: Create solution and projects</strong></p>

<ul>
  <li>Create a solution name EventSourcing.</li>
  <li>Add a new web api projects name -  Catalog.API</li>
  <li>Add three class library projects name â€“ Application, Domain, Infrastructure</li>
</ul>

<p><strong>Step 3: Install nuget packages</strong></p>

<ul>
  <li>Install following nuget packages in Catalog.API</li>
</ul>

<div class="language-ps highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">PM</span><span class="p">&gt;</span> <span class="nf">Install-Package</span> <span class="nf">Microsoft.EntityFrameworkCore.Tools</span>
</code></pre></div></div>
<ul>
  <li>Install following nuget packages in Application</li>
</ul>

<div class="language-ps highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">PM</span><span class="p">&gt;</span> <span class="nf">Install-Package</span> <span class="nf">MediatR</span>
<span class="nf">PM</span><span class="p">&gt;</span> <span class="nf">Install-Package</span> <span class="nf">MediatR.Extensions.Microsoft.DependencyInjection</span>
<span class="nf">PM</span><span class="p">&gt;</span> <span class="nf">Install-Package</span> <span class="nf">Microsoft.Extensions.DependencyInjection.Abstractions</span>
<span class="nf">PM</span><span class="p">&gt;</span> <span class="nf">Install-Package</span> <span class="nf">Newtonsoft.Json</span>
</code></pre></div></div>

<ul>
  <li>Install following nuget packages in Infrastructure</li>
</ul>

<div class="language-ps highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">PM</span><span class="p">&gt;</span> <span class="nf">Install-Package</span> <span class="nf">EventStore.Client.Grpc.Streams</span>
<span class="nf">PM</span><span class="p">&gt;</span> <span class="nf">Install-Package</span> <span class="nf">Microsoft.EntityFrameworkCore</span>
<span class="nf">PM</span><span class="p">&gt;</span> <span class="nf">Install-Package</span> <span class="nf">Microsoft.Extensions.Configuration.Abstractions</span>
<span class="nf">PM</span><span class="p">&gt;</span> <span class="nf">Install-Package</span> <span class="nf">Microsoft.Extensions.DependencyInjection.Abstractions</span>
<span class="nf">PM</span><span class="p">&gt;</span> <span class="nf">Install-Package</span> <span class="nf">Newtonsoft.Json</span>
</code></pre></div></div>

<p><strong>Step 4: Organize Domain</strong></p>

<ul>
  <li>Create IBaseEntity interface for Base entity in Entities-&gt;Common folder.</li>
</ul>

<p><strong>IBaseEntity.cs</strong></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">namespace</span> <span class="nn">Domain.Entities.Common</span>
<span class="p">{</span>
    <span class="c1">/// Ref: Coverience in C#</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Interface for Base Entity</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="c1">/// &lt;typeparam name="TKey"&gt;&lt;/typeparam&gt;</span>
    <span class="k">public</span> <span class="k">interface</span> <span class="nc">IBaseEntity</span><span class="p">&lt;</span><span class="k">out</span> <span class="n">TKey</span><span class="p">&gt;</span>
    <span class="p">{</span>
        <span class="n">TKey</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<ul>
  <li>Create IDomainEvent interface for domain event in Entities-&gt;Common folder</li>
</ul>

<p><strong>IDomainEvent.cs</strong></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">namespace</span> <span class="nn">Domain.Entities.Common</span>
<span class="p">{</span>

    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Interface for Domain Event</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="c1">/// &lt;typeparam name="TKey"&gt;&lt;/typeparam&gt;</span>
    <span class="k">public</span> <span class="k">interface</span> <span class="nc">IDomainEvent</span><span class="p">&lt;</span><span class="k">out</span> <span class="n">TKey</span><span class="p">&gt;</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">long</span> <span class="n">AggregateVersion</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
        <span class="n">TKey</span> <span class="n">AggregateId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
        <span class="n">DateTime</span> <span class="n">TimeStamp</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<ul>
  <li>Create IAggregateRoot interface for Aggregate Root in Entities-&gt;Common folder. IAggregateRoot is the combination of IBaseEntity and IAggregateRoot</li>
</ul>

<p><strong>IAggregateRoot.cs</strong></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">namespace</span> <span class="nn">Domain.Entities.Common</span>
<span class="p">{</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Interface for AggregateRoot</span>
    <span class="c1">/// IAggregateRoot is the combination of IBaseEntity and IAggregateRoot</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="c1">/// &lt;typeparam name="TKey"&gt;&lt;/typeparam&gt;</span>
    <span class="k">public</span> <span class="k">interface</span> <span class="nc">IAggregateRoot</span><span class="p">&lt;</span><span class="k">out</span> <span class="n">TKey</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IBaseEntity</span><span class="p">&lt;</span><span class="n">TKey</span><span class="p">&gt;</span>
    <span class="p">{</span>
        <span class="kt">long</span> <span class="n">Version</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
        <span class="n">IReadOnlyCollection</span><span class="p">&lt;</span><span class="n">IDomainEvent</span><span class="p">&lt;</span><span class="n">TKey</span><span class="p">&gt;&gt;</span> <span class="n">Events</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span>  <span class="p">}</span>
        <span class="k">void</span> <span class="nf">ClearEvents</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<ul>
  <li>Create BaseEntity class for Base Aggregate Root in Entities-&gt;Common folder. BaseEntityâ€™s properties is shared in all entity classes.</li>
</ul>

<p><strong>BaseEntity.cs</strong></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">namespace</span> <span class="nn">Domain.Entities.Common</span>
<span class="p">{</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Base class for BaseAggregateRoot class</span>
    <span class="c1">/// Shared for all entities</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="c1">/// &lt;typeparam name="TKey"&gt;&lt;/typeparam&gt;</span>
    <span class="k">public</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">BaseEntity</span><span class="p">&lt;</span><span class="n">TKey</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IBaseEntity</span><span class="p">&lt;</span><span class="n">TKey</span><span class="p">&gt;</span>
    <span class="p">{</span>
        <span class="k">protected</span> <span class="nf">BaseEntity</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>
        <span class="k">protected</span> <span class="nf">BaseEntity</span><span class="p">(</span><span class="n">TKey</span> <span class="n">id</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">Id</span> <span class="p">=</span> <span class="n">id</span><span class="p">;</span>

        <span class="c1">//Implementation of interface</span>
        <span class="k">public</span> <span class="n">TKey</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">protected</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<ul>
  <li>Create BaseDomainEvent class for all domain event class in Entities-&gt;Common folder.</li>
</ul>

<p><strong>BaseDomainEvent.cs</strong></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">namespace</span> <span class="nn">Domain.Entities.Common</span>
<span class="p">{</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Base domain event for all domain event</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="c1">/// &lt;typeparam name="TA"&gt;&lt;/typeparam&gt;</span>
    <span class="c1">/// &lt;typeparam name="TKey"&gt;&lt;/typeparam&gt;</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">BaseDomainEvent</span><span class="p">&lt;</span><span class="n">TA</span><span class="p">,</span> <span class="n">TKey</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IDomainEvent</span><span class="p">&lt;</span><span class="n">TKey</span><span class="p">&gt;</span> <span class="k">where</span> <span class="n">TA</span> <span class="p">:</span> <span class="n">IAggregateRoot</span><span class="p">&lt;</span><span class="n">TKey</span><span class="p">&gt;</span>
    <span class="p">{</span>
        <span class="k">protected</span> <span class="nf">BaseDomainEvent</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>
        <span class="k">public</span> <span class="nf">BaseDomainEvent</span><span class="p">(</span><span class="n">TA</span> <span class="n">aggregateRoot</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">aggregateRoot</span> <span class="k">is</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">aggregateRoot</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="n">AggregateId</span> <span class="p">=</span> <span class="n">aggregateRoot</span><span class="p">.</span><span class="n">Id</span><span class="p">;</span>
            <span class="n">AggregateVersion</span> <span class="p">=</span> <span class="n">aggregateRoot</span><span class="p">.</span><span class="n">Version</span><span class="p">;</span>
            <span class="n">TimeStamp</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">//Implementation of IDomainEvent</span>
        <span class="k">public</span> <span class="kt">long</span> <span class="n">AggregateVersion</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="c1">//Implementation of IDomainEvent</span>
        <span class="k">public</span> <span class="n">TKey</span> <span class="n">AggregateId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="c1">//Implementation of IDomainEvent</span>
        <span class="k">public</span> <span class="n">DateTime</span> <span class="n">TimeStamp</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<ul>
  <li>Create BaseAggregateRoot class for all aggregate root in Entities-&gt;Common folder. Here _event queue is used to queue all events of the aggregate root. AddEvent method used to add new event.</li>
</ul>

<p><strong>BaseAggregateRoot.cs</strong></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">using</span> <span class="nn">System.Collections.Immutable</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Reflection</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Domain.Entities.Common</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">BaseAggregateRoot</span><span class="p">&lt;</span><span class="n">TA</span><span class="p">,</span> <span class="n">TKey</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">BaseEntity</span><span class="p">&lt;</span><span class="n">TKey</span><span class="p">&gt;,</span> <span class="n">IAggregateRoot</span><span class="p">&lt;</span><span class="n">TKey</span><span class="p">&gt;</span> <span class="k">where</span> <span class="n">TA</span> <span class="p">:</span> <span class="n">IAggregateRoot</span><span class="p">&lt;</span><span class="n">TKey</span><span class="p">&gt;</span>
    <span class="p">{</span>

        <span class="c1">// Queuing all events</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">Queue</span><span class="p">&lt;</span><span class="n">IDomainEvent</span><span class="p">&lt;</span><span class="n">TKey</span><span class="p">&gt;&gt;</span> <span class="n">_events</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Queue</span><span class="p">&lt;</span><span class="n">IDomainEvent</span><span class="p">&lt;</span><span class="n">TKey</span><span class="p">&gt;&gt;();</span>

        <span class="k">protected</span> <span class="nf">BaseAggregateRoot</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>
        <span class="k">protected</span> <span class="nf">BaseAggregateRoot</span><span class="p">(</span><span class="n">TKey</span> <span class="n">id</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
        <span class="p">{</span>

        <span class="p">}</span>

        <span class="k">protected</span> <span class="k">void</span> <span class="nf">AddEvent</span><span class="p">(</span><span class="n">IDomainEvent</span><span class="p">&lt;</span><span class="n">TKey</span><span class="p">&gt;</span> <span class="n">@event</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">@event</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">@event</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="n">_events</span><span class="p">.</span><span class="nf">Enqueue</span><span class="p">(</span><span class="n">@event</span><span class="p">);</span>
            <span class="nf">Apply</span><span class="p">(</span><span class="n">@event</span><span class="p">);</span>
            <span class="n">Version</span><span class="p">++;</span>
        <span class="p">}</span>

        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// This method is implemented in the derived class</span>
        <span class="c1">/// Apply this method to implement different events</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="c1">/// &lt;param name="event"&gt;&lt;/param&gt;</span>
        
        <span class="k">protected</span> <span class="k">abstract</span> <span class="k">void</span> <span class="nf">Apply</span><span class="p">(</span><span class="n">IDomainEvent</span><span class="p">&lt;</span><span class="n">TKey</span><span class="p">&gt;</span> <span class="n">@event</span><span class="p">);</span>

        <span class="c1">// Implementation of IAggregateRoot</span>
        <span class="c1">// Aggregate version</span>
        <span class="k">public</span> <span class="kt">long</span> <span class="n">Version</span><span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="c1">// Implementation of IAggregateRoot</span>
        <span class="k">public</span> <span class="n">IReadOnlyCollection</span><span class="p">&lt;</span><span class="n">IDomainEvent</span><span class="p">&lt;</span><span class="n">TKey</span><span class="p">&gt;&gt;</span> <span class="n">Events</span> <span class="p">=&gt;</span> <span class="n">_events</span><span class="p">.</span><span class="nf">ToImmutableArray</span><span class="p">();</span>

        <span class="c1">// Implementation of IAggregateRoot</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">ClearEvents</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">_events</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="err">#</span><span class="n">region</span> <span class="n">Factory</span>

        <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">ConstructorInfo</span> <span class="n">CTor</span><span class="p">;</span>

        <span class="k">static</span> <span class="nf">BaseAggregateRoot</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">aggregateType</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">TA</span><span class="p">);</span>
            <span class="n">CTor</span> <span class="p">=</span> <span class="n">aggregateType</span><span class="p">.</span><span class="nf">GetConstructor</span><span class="p">(</span><span class="n">BindingFlags</span><span class="p">.</span><span class="n">Instance</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">NonPublic</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Public</span><span class="p">,</span>
                <span class="k">null</span><span class="p">,</span> <span class="k">new</span> <span class="n">Type</span><span class="p">[</span><span class="m">0</span><span class="p">],</span> <span class="k">new</span> <span class="n">ParameterModifier</span><span class="p">[</span><span class="m">0</span><span class="p">]);</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">null</span> <span class="p">==</span> <span class="n">CTor</span><span class="p">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidOperationException</span><span class="p">(</span><span class="s">$"Unable to find required private parameterless constructor for Aggregate of type '</span><span class="p">{</span><span class="n">aggregateType</span><span class="p">.</span><span class="n">Name</span><span class="p">}</span><span class="s">'"</span><span class="p">);</span>
        <span class="p">}</span>


        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// Create Base Aggregate root when Rehydrate all Events</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="c1">/// &lt;param name="events"&gt;&lt;/param&gt;</span>
        <span class="c1">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span class="c1">/// &lt;exception cref="ArgumentNullException"&gt;&lt;/exception&gt;</span>
        <span class="k">public</span> <span class="k">static</span> <span class="n">TA</span> <span class="nf">Create</span><span class="p">(</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">IDomainEvent</span><span class="p">&lt;</span><span class="n">TKey</span><span class="p">&gt;&gt;</span> <span class="n">events</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">null</span> <span class="p">==</span> <span class="n">events</span> <span class="p">||</span> <span class="p">!</span><span class="n">events</span><span class="p">.</span><span class="nf">Any</span><span class="p">())</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">events</span><span class="p">));</span>
            <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="p">(</span><span class="n">TA</span><span class="p">)</span><span class="n">CTor</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="k">new</span> <span class="kt">object</span><span class="p">[</span><span class="m">0</span><span class="p">]);</span>

            <span class="c1">// Problem is in here</span>
            <span class="kt">var</span> <span class="n">baseAggregate</span> <span class="p">=</span> <span class="n">result</span> <span class="k">as</span> <span class="n">BaseAggregateRoot</span><span class="p">&lt;</span><span class="n">TA</span><span class="p">,</span> <span class="n">TKey</span><span class="p">&gt;;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">baseAggregate</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">@event</span> <span class="k">in</span> <span class="n">events</span><span class="p">)</span>
                    <span class="n">baseAggregate</span><span class="p">.</span><span class="nf">AddEvent</span><span class="p">(</span><span class="n">@event</span><span class="p">);</span>

            <span class="n">result</span><span class="p">.</span><span class="nf">ClearEvents</span><span class="p">();</span>

            <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="err">#</span><span class="n">endregion</span>  
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<ul>
  <li>Create CatalogItemCreated  Event class in Events-&gt;CatalogItem folder</li>
</ul>

<p><strong>CatalogItemCreated.cs</strong></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">using</span> <span class="nn">Domain.Entities.Common</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Domain.Events.CatalogItem</span>
<span class="p">{</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Catalog item created event</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">CatalogItemCreated</span><span class="p">:</span> <span class="n">BaseDomainEvent</span><span class="p">&lt;</span><span class="n">Entities</span><span class="p">.</span><span class="n">CatalogItem</span><span class="p">,</span> <span class="n">Guid</span><span class="p">&gt;</span>
    <span class="p">{</span>

        <span class="k">private</span> <span class="nf">CatalogItemCreated</span><span class="p">()</span>
        <span class="p">{</span>

        <span class="p">}</span>
        <span class="k">public</span> <span class="nf">CatalogItemCreated</span><span class="p">(</span><span class="n">Entities</span><span class="p">.</span><span class="n">CatalogItem</span> <span class="n">catalogItem</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">catalogItem</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//Id = catalogItem.Id;</span>
            <span class="n">Name</span> <span class="p">=</span> <span class="n">catalogItem</span><span class="p">.</span><span class="n">Name</span><span class="p">;</span>
            <span class="n">Description</span> <span class="p">=</span> <span class="n">catalogItem</span><span class="p">.</span><span class="n">Description</span><span class="p">;</span>
            <span class="n">Price</span> <span class="p">=</span> <span class="n">catalogItem</span><span class="p">.</span><span class="n">Price</span><span class="p">;</span>
            <span class="n">AvailableStock</span> <span class="p">=</span> <span class="n">catalogItem</span><span class="p">.</span><span class="n">AvailableStock</span><span class="p">;</span>
            <span class="n">RestockThreshold</span> <span class="p">=</span> <span class="n">catalogItem</span><span class="p">.</span><span class="n">RestockThreshold</span><span class="p">;</span>
            <span class="n">MaxStockThreshold</span> <span class="p">=</span> <span class="n">catalogItem</span><span class="p">.</span><span class="n">MaxStockThreshold</span><span class="p">;</span>
            <span class="n">OnReorder</span> <span class="p">=</span> <span class="n">catalogItem</span><span class="p">.</span><span class="n">OnReorder</span><span class="p">;</span>
            <span class="n">IsDeleted</span> <span class="p">=</span> <span class="n">catalogItem</span><span class="p">.</span><span class="n">IsDeleted</span><span class="p">;</span>
            
        <span class="p">}</span>

        <span class="c1">//public Guid Id { get; set; }</span>

        <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">string</span> <span class="n">Description</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">double</span> <span class="n">Price</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="c1">// Quantity in stock</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">AvailableStock</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="c1">// Available stock at which we should reorder</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">RestockThreshold</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="c1">// Maximum number of units that can be in-stock at any time (due to physicial/logistical constraints in warehouses)</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">MaxStockThreshold</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// True if item is on reorder</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="k">public</span> <span class="kt">bool</span> <span class="n">OnReorder</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">bool</span> <span class="n">IsDeleted</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="p">}</span>
<span class="p">}</span>
 
</code></pre></div></div>

<ul>
  <li>Create CatalogItemDeleted Event class in Events-&gt;CatalogItem folder</li>
</ul>

<p><strong>CatalogItemDeleted.cs</strong></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">using</span> <span class="nn">Domain.Entities.Common</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Domain.Events.CatalogItem</span>
<span class="p">{</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Catalog item created event</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">CatalogItemDeleted</span><span class="p">:</span> <span class="n">BaseDomainEvent</span><span class="p">&lt;</span><span class="n">Entities</span><span class="p">.</span><span class="n">CatalogItem</span><span class="p">,</span> <span class="n">Guid</span><span class="p">&gt;</span>
    <span class="p">{</span>

        <span class="k">private</span> <span class="nf">CatalogItemDeleted</span><span class="p">()</span>
        <span class="p">{</span>

        <span class="p">}</span>
        <span class="k">public</span> <span class="nf">CatalogItemDeleted</span><span class="p">(</span><span class="n">Entities</span><span class="p">.</span><span class="n">CatalogItem</span> <span class="n">catalogItem</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">catalogItem</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">IsDeleted</span> <span class="p">=</span> <span class="n">catalogItem</span><span class="p">.</span><span class="n">IsDeleted</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">public</span> <span class="kt">bool</span> <span class="n">IsDeleted</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="p">}</span>
<span class="p">}</span>


</code></pre></div></div>

<ul>
  <li>Create CatalogItemUpdated Event class in Events-&gt;CatalogItem folder</li>
</ul>

<p><strong>CatalogItemUpdated.cs</strong></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">Domain.Entities.Common</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Domain.Events.CatalogItem</span>
<span class="p">{</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Catalog item created event</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">CatalogItemUpdated</span><span class="p">:</span> <span class="n">BaseDomainEvent</span><span class="p">&lt;</span><span class="n">Entities</span><span class="p">.</span><span class="n">CatalogItem</span><span class="p">,</span> <span class="n">Guid</span><span class="p">&gt;</span>
    <span class="p">{</span>

        <span class="k">private</span> <span class="nf">CatalogItemUpdated</span><span class="p">()</span>
        <span class="p">{</span>

        <span class="p">}</span>
        <span class="k">public</span> <span class="nf">CatalogItemUpdated</span><span class="p">(</span><span class="n">Entities</span><span class="p">.</span><span class="n">CatalogItem</span> <span class="n">catalogItem</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">catalogItem</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//Id = catalogItem.Id;</span>
            <span class="n">Name</span> <span class="p">=</span> <span class="n">catalogItem</span><span class="p">.</span><span class="n">Name</span><span class="p">;</span>
            <span class="n">Description</span> <span class="p">=</span> <span class="n">catalogItem</span><span class="p">.</span><span class="n">Description</span><span class="p">;</span>
            <span class="n">Price</span> <span class="p">=</span> <span class="n">catalogItem</span><span class="p">.</span><span class="n">Price</span><span class="p">;</span>
            <span class="n">AvailableStock</span> <span class="p">=</span> <span class="n">catalogItem</span><span class="p">.</span><span class="n">AvailableStock</span><span class="p">;</span>
            <span class="n">RestockThreshold</span> <span class="p">=</span> <span class="n">catalogItem</span><span class="p">.</span><span class="n">RestockThreshold</span><span class="p">;</span>
            <span class="n">MaxStockThreshold</span> <span class="p">=</span> <span class="n">catalogItem</span><span class="p">.</span><span class="n">MaxStockThreshold</span><span class="p">;</span>
            <span class="n">OnReorder</span> <span class="p">=</span> <span class="n">catalogItem</span><span class="p">.</span><span class="n">OnReorder</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">//public Guid Id { get; set; }</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">string</span> <span class="n">Description</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">double</span> <span class="n">Price</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="c1">// Quantity in stock</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">AvailableStock</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="c1">// Available stock at which we should reorder</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">RestockThreshold</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="c1">// Maximum number of units that can be in-stock at any time (due to physicial/logistical constraints in warehouses)</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">MaxStockThreshold</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// True if item is on reorder</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="k">public</span> <span class="kt">bool</span> <span class="n">OnReorder</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<ul>
  <li>Create CatalogItem Aggregate Root class in Entities folder.  Here we used DDD so CatalogItem is the main domain class here. Create, update, delete is performed using this class.</li>
</ul>

<p><strong>CatalogItem.cs</strong></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">Domain.Entities.Common</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Domain.Events.CatalogItem</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Domain.Entities</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">CatalogItem</span> <span class="p">:</span> <span class="n">BaseAggregateRoot</span><span class="p">&lt;</span><span class="n">CatalogItem</span><span class="p">,</span> <span class="n">Guid</span><span class="p">&gt;</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="nf">CatalogItem</span><span class="p">()</span>
        <span class="p">{</span>

        <span class="p">}</span>

        <span class="k">public</span> <span class="nf">CatalogItem</span><span class="p">(</span><span class="n">Guid</span> <span class="n">id</span><span class="p">,</span> <span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="kt">string</span> <span class="n">description</span><span class="p">,</span> <span class="kt">double</span> <span class="n">price</span><span class="p">,</span> <span class="kt">int</span> <span class="n">availableStock</span><span class="p">,</span> 
            <span class="kt">int</span> <span class="n">restockThreshold</span><span class="p">,</span> <span class="kt">int</span> <span class="n">maxStockThreshold</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">onReorder</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Id</span> <span class="p">=</span> <span class="n">id</span><span class="p">;</span>
            <span class="n">Name</span> <span class="p">=</span> <span class="n">name</span><span class="p">;</span>
            <span class="n">Description</span> <span class="p">=</span> <span class="n">description</span><span class="p">;</span>
            <span class="n">Price</span> <span class="p">=</span> <span class="n">price</span><span class="p">;</span>
            <span class="n">AvailableStock</span> <span class="p">=</span> <span class="n">availableStock</span><span class="p">;</span>
            <span class="n">RestockThreshold</span> <span class="p">=</span> <span class="n">restockThreshold</span><span class="p">;</span>
            <span class="n">MaxStockThreshold</span> <span class="p">=</span> <span class="n">maxStockThreshold</span><span class="p">;</span>
            <span class="n">OnReorder</span> <span class="p">=</span> <span class="n">onReorder</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">Version</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">"Catalog item already created"</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="c1">//Validation Exception will be placed here</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">"Name Can not be Empty"</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">price</span> <span class="p">&lt;=</span> <span class="m">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">//Validation Exception will be placed here</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">"Price must be positive value"</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="c1">// Add CatalogItem Event Here to create</span>
            <span class="nf">AddEvent</span><span class="p">(</span><span class="k">new</span> <span class="nf">CatalogItemCreated</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">string</span> <span class="n">Description</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">double</span> <span class="n">Price</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="c1">// Quantity in stock</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">AvailableStock</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="c1">// Available stock at which we should reorder</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">RestockThreshold</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="c1">// Maximum number of units that can be in-stock at any time (due to physicial/logistical constraints in warehouses)</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">MaxStockThreshold</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// True if item is on reorder</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="k">public</span> <span class="kt">bool</span> <span class="n">OnReorder</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">bool</span> <span class="n">IsDeleted</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>

        <span class="k">public</span> <span class="k">static</span> <span class="n">CatalogItem</span> <span class="nf">Create</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="kt">string</span> <span class="n">description</span><span class="p">,</span> <span class="kt">double</span> <span class="n">price</span><span class="p">,</span> <span class="kt">int</span> <span class="n">availableStock</span><span class="p">,</span> 
            <span class="kt">int</span> <span class="n">restockThreshold</span><span class="p">,</span> <span class="kt">int</span> <span class="n">maxStockThreshold</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">onReorder</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">CatalogItem</span><span class="p">(</span><span class="n">Guid</span><span class="p">.</span><span class="nf">NewGuid</span><span class="p">(),</span> <span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">availableStock</span><span class="p">,</span> <span class="n">restockThreshold</span><span class="p">,</span> <span class="n">maxStockThreshold</span><span class="p">,</span> <span class="n">onReorder</span><span class="p">);</span> <span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">Update</span><span class="p">(</span><span class="n">Guid</span> <span class="n">id</span><span class="p">,</span> <span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="kt">string</span> <span class="n">description</span><span class="p">,</span> <span class="kt">double</span> <span class="n">price</span><span class="p">,</span> <span class="kt">int</span> <span class="n">availableStock</span><span class="p">,</span>
         <span class="kt">int</span> <span class="n">restockThreshold</span><span class="p">,</span> <span class="kt">int</span> <span class="n">maxStockThreshold</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">onReorder</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Id</span> <span class="p">=</span> <span class="n">id</span><span class="p">;</span>
            <span class="n">Name</span> <span class="p">=</span> <span class="n">name</span><span class="p">;</span>
            <span class="n">Description</span> <span class="p">=</span> <span class="n">description</span><span class="p">;</span>
            <span class="n">Price</span> <span class="p">=</span> <span class="n">price</span><span class="p">;</span>
            <span class="n">AvailableStock</span> <span class="p">=</span> <span class="n">availableStock</span><span class="p">;</span>
            <span class="n">RestockThreshold</span> <span class="p">=</span> <span class="n">restockThreshold</span><span class="p">;</span>
            <span class="n">MaxStockThreshold</span> <span class="p">=</span> <span class="n">maxStockThreshold</span><span class="p">;</span>
            <span class="n">OnReorder</span> <span class="p">=</span> <span class="n">onReorder</span><span class="p">;</span>

            <span class="nf">AddEvent</span><span class="p">(</span><span class="k">new</span> <span class="nf">CatalogItemUpdated</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">Delete</span><span class="p">(</span><span class="n">Guid</span> <span class="n">id</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Id</span> <span class="p">=</span> <span class="n">id</span><span class="p">;</span>
            <span class="n">IsDeleted</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="nf">AddEvent</span><span class="p">(</span><span class="k">new</span> <span class="nf">CatalogItemDeleted</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
        <span class="p">}</span>



        <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Apply</span><span class="p">(</span><span class="n">IDomainEvent</span><span class="p">&lt;</span><span class="n">Guid</span><span class="p">&gt;</span> <span class="n">@event</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">switch</span> <span class="p">(</span><span class="n">@event</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">case</span> <span class="n">CatalogItemCreated</span> <span class="n">catalogItemCreated</span><span class="p">:</span> <span class="nf">OnCatalogItemCreated</span><span class="p">(</span><span class="n">catalogItemCreated</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="n">CatalogItemUpdated</span> <span class="n">catalogItemUpdated</span><span class="p">:</span> <span class="nf">OnCatalogItemUpdated</span><span class="p">(</span><span class="n">catalogItemUpdated</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="n">CatalogItemDeleted</span> <span class="n">catalogItemDeleted</span><span class="p">:</span> 
                    <span class="n">IsDeleted</span> <span class="p">=</span> <span class="n">catalogItemDeleted</span><span class="p">.</span><span class="n">IsDeleted</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>

            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">// On Catalog Item Created Event</span>
        <span class="k">private</span> <span class="k">void</span> <span class="nf">OnCatalogItemCreated</span><span class="p">(</span><span class="n">CatalogItemCreated</span> <span class="n">catalogItemCreated</span><span class="p">)</span>
        <span class="p">{</span>

            <span class="n">Id</span> <span class="p">=</span> <span class="n">catalogItemCreated</span><span class="p">.</span><span class="n">AggregateId</span><span class="p">;</span> <span class="c1">// Must have ID</span>
            <span class="n">Name</span> <span class="p">=</span> <span class="n">catalogItemCreated</span><span class="p">.</span><span class="n">Name</span><span class="p">;</span>
            <span class="n">Description</span><span class="p">=</span> <span class="n">catalogItemCreated</span><span class="p">.</span><span class="n">Description</span><span class="p">;</span>
            <span class="n">Price</span> <span class="p">=</span> <span class="n">catalogItemCreated</span><span class="p">.</span><span class="n">Price</span><span class="p">;</span>
            <span class="n">AvailableStock</span> <span class="p">=</span> <span class="n">catalogItemCreated</span><span class="p">.</span><span class="n">AvailableStock</span><span class="p">;</span>
            <span class="n">RestockThreshold</span> <span class="p">=</span> <span class="n">catalogItemCreated</span><span class="p">.</span><span class="n">RestockThreshold</span><span class="p">;</span>
            <span class="n">MaxStockThreshold</span> <span class="p">=</span> <span class="n">catalogItemCreated</span><span class="p">.</span><span class="n">MaxStockThreshold</span><span class="p">;</span>
            <span class="n">OnReorder</span> <span class="p">=</span> <span class="n">catalogItemCreated</span><span class="p">.</span><span class="n">OnReorder</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// On Catalog Item Updated Event</span>
        <span class="k">private</span> <span class="k">void</span> <span class="nf">OnCatalogItemUpdated</span><span class="p">(</span><span class="n">CatalogItemUpdated</span> <span class="n">catalogItemUpdated</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Name</span> <span class="p">=</span> <span class="n">catalogItemUpdated</span><span class="p">.</span><span class="n">Name</span><span class="p">;</span>
            <span class="n">Description</span> <span class="p">=</span> <span class="n">catalogItemUpdated</span><span class="p">.</span><span class="n">Description</span><span class="p">;</span>
            <span class="n">Price</span> <span class="p">=</span> <span class="n">catalogItemUpdated</span><span class="p">.</span><span class="n">Price</span><span class="p">;</span>
            <span class="n">AvailableStock</span> <span class="p">=</span> <span class="n">catalogItemUpdated</span><span class="p">.</span><span class="n">AvailableStock</span><span class="p">;</span>
            <span class="n">RestockThreshold</span> <span class="p">=</span> <span class="n">catalogItemUpdated</span><span class="p">.</span><span class="n">RestockThreshold</span><span class="p">;</span>
            <span class="n">MaxStockThreshold</span> <span class="p">=</span> <span class="n">catalogItemUpdated</span><span class="p">.</span><span class="n">MaxStockThreshold</span><span class="p">;</span>
            <span class="n">OnReorder</span> <span class="p">=</span> <span class="n">catalogItemUpdated</span><span class="p">.</span><span class="n">OnReorder</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>Step 5: Organize Application</strong></p>

<ul>
  <li>Add domain as a reference project in Application project. You may add using project file as follows.</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;ItemGroup&gt;</span>
    <span class="nt">&lt;ProjectReference</span> <span class="na">Include=</span><span class="s">"..\Domain\Domain.csproj"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/ItemGroup&gt;</span>
</code></pre></div></div>

<ul>
  <li>Create CreateCatalogItemDTO class in Common-&gt;DTOs folder</li>
</ul>

<p><strong>CreateCatalogItemDTO.cs</strong></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">namespace</span> <span class="nn">Application.Common.DTOs</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">CreateCatalogItemDTO</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">string</span> <span class="n">Description</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">double</span> <span class="n">Price</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="c1">// Quantity in stock</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">AvailableStock</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="c1">// Available stock at which we should reorder</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">RestockThreshold</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="c1">// Maximum number of units that can be in-stock at any time (due to physicial/logistical constraints in warehouses)</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">MaxStockThreshold</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// True if item is on reorder</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="k">public</span> <span class="kt">bool</span> <span class="n">OnReorder</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<ul>
  <li>Create UpdateCatalogItemDTO class in Common-&gt;DTOs folder</li>
</ul>

<p><strong>UpdateCatalogItemDTO.cs</strong></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">namespace</span> <span class="nn">Application.Common.DTOs</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">UpdateCatalogItemDTO</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="n">Guid</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">string</span> <span class="n">Description</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">double</span> <span class="n">Price</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="c1">// Quantity in stock</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">AvailableStock</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="c1">// Available stock at which we should reorder</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">RestockThreshold</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="c1">// Maximum number of units that can be in-stock at any time (due to physicial/logistical constraints in warehouses)</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">MaxStockThreshold</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// True if item is on reorder</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="k">public</span> <span class="kt">bool</span> <span class="n">OnReorder</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<ul>
  <li>Create IAggregateRepository Interface in Common-&gt;Interfaces folder. This interface is used for event sourcing. Here,  AppendAsync method is used to append events to store in event store database, RehydreateAsync method is used to read all events using aggregate id and ReadEventsAsync method is used to read events as a log and return in to dictionary.</li>
</ul>

<p><strong>IAggregateRepository.cs</strong></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">Domain.Entities.Common</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Application.Common.Interfaces</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">interface</span> <span class="nc">IAggregateRepository</span><span class="p">&lt;</span><span class="n">TA</span><span class="p">,</span> <span class="n">TKey</span><span class="p">&gt;</span> <span class="k">where</span> <span class="n">TA</span> <span class="p">:</span> <span class="k">class</span><span class="err">,</span> <span class="nc">IAggregateRoot</span><span class="p">&lt;</span><span class="n">TKey</span><span class="p">&gt;</span>
    <span class="p">{</span>
        <span class="c1">// Append events to store in event store database</span>
        <span class="n">Task</span> <span class="nf">AppendAsync</span><span class="p">(</span><span class="n">TA</span> <span class="n">aggregate</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">cancellationToken</span> <span class="p">=</span> <span class="k">default</span><span class="p">);</span>

        <span class="c1">// Read all events using aggregate ID</span>
        <span class="n">Task</span><span class="p">&lt;</span><span class="n">TA</span><span class="p">?&gt;</span> <span class="nf">RehydreateAsync</span><span class="p">(</span><span class="n">TKey</span> <span class="n">aggregateId</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">cancellationToken</span> <span class="p">=</span> <span class="k">default</span><span class="p">);</span>

        <span class="c1">// Read events as a log and return into a dictionary</span>
        <span class="n">Task</span><span class="p">&lt;</span><span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;&gt;</span> <span class="nf">ReadEventsAsync</span><span class="p">(</span><span class="n">TKey</span> <span class="n">aggregateId</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">cancellationToken</span> <span class="p">=</span> <span class="k">default</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<ul>
  <li>Create ICatalogItemRepository interface to insert and update into sql server. Since, we use soft delete so here delete means update of isDelete filed to 1.</li>
</ul>

<p><strong>ICatalogItemRepository.cs</strong></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">using</span> <span class="nn">Domain.Entities</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Application.Common.Interfaces</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">interface</span> <span class="nc">ICatalogItemRepository</span>
    <span class="p">{</span>
        <span class="n">Task</span> <span class="nf">AddAsync</span><span class="p">(</span><span class="n">CatalogItem</span> <span class="n">catalogItem</span><span class="p">);</span>
        <span class="n">Task</span> <span class="nf">UpdateAsync</span><span class="p">(</span><span class="n">CatalogItem</span> <span class="n">catalogItem</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<ul>
  <li>Create PrivateSetterContractResolver class in Common-&gt;Resolvers folder. This is a Custom Contract Resolver to Set Private property when Rehydrate Events</li>
</ul>

<p><strong>PrivateSetterContractResolver.cs</strong></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">using</span> <span class="nn">Newtonsoft.Json</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Newtonsoft.Json.Serialization</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Reflection</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Application.Common.Resolvers</span>
<span class="p">{</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Custom Contract Resolver to Set Private property when Rehydrate Events</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">PrivateSetterContractResolver</span> <span class="p">:</span> <span class="n">DefaultContractResolver</span>
    <span class="p">{</span>
        <span class="k">protected</span> <span class="k">override</span> <span class="n">JsonProperty</span> <span class="nf">CreateProperty</span><span class="p">(</span><span class="n">MemberInfo</span> <span class="n">member</span><span class="p">,</span> <span class="n">MemberSerialization</span> <span class="n">memberSerialization</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">jsonProperty</span> <span class="p">=</span> <span class="k">base</span><span class="p">.</span><span class="nf">CreateProperty</span><span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="n">memberSerialization</span><span class="p">);</span>

            <span class="k">if</span><span class="p">(</span><span class="n">jsonProperty</span><span class="p">.</span><span class="n">Writable</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">jsonProperty</span><span class="p">;</span>

            <span class="k">if</span><span class="p">(</span><span class="n">member</span> <span class="k">is</span> <span class="n">PropertyInfo</span> <span class="n">propertyInfo</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">setter</span> <span class="p">=</span> <span class="n">propertyInfo</span><span class="p">.</span><span class="nf">GetSetMethod</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
                <span class="n">jsonProperty</span><span class="p">.</span><span class="n">Writable</span> <span class="p">=</span> <span class="n">setter</span> <span class="p">!=</span> <span class="k">null</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">jsonProperty</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">//EnvironmentVariableTarget jsonProperty = base.CreateProperty();</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<ul>
  <li>Create CreateCatalogItemCommand and CreateCatalogItemCommandHandler class in Commands-&gt;CatalogItems folder.</li>
</ul>

<p><strong>CreateCatalogItemCommand.cs</strong></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">using</span> <span class="nn">Application.Common.Interfaces</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Domain.Entities</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">MediatR</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Application.Commands.CatalogItems</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">CreateCatalogItemCommand</span> <span class="p">:</span> <span class="n">INotification</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="nf">CreateCatalogItemCommand</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="kt">string</span> <span class="n">description</span><span class="p">,</span> <span class="kt">double</span> <span class="n">price</span><span class="p">,</span> <span class="kt">int</span> <span class="n">availableStock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">restockThreshold</span><span class="p">,</span> 
            <span class="kt">int</span> <span class="n">maxStockThreshold</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">onReorder</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Name</span> <span class="p">=</span> <span class="n">name</span><span class="p">;</span>
            <span class="n">Description</span> <span class="p">=</span> <span class="n">description</span><span class="p">;</span>
            <span class="n">Price</span> <span class="p">=</span> <span class="n">price</span><span class="p">;</span>
            <span class="n">AvailableStock</span> <span class="p">=</span> <span class="n">availableStock</span><span class="p">;</span>
            <span class="n">RestockThreshold</span> <span class="p">=</span> <span class="n">restockThreshold</span><span class="p">;</span>
            <span class="n">MaxStockThreshold</span> <span class="p">=</span> <span class="n">maxStockThreshold</span><span class="p">;</span>
            <span class="n">OnReorder</span> <span class="p">=</span> <span class="n">onReorder</span><span class="p">;</span>
        <span class="p">}</span>


        <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">string</span> <span class="n">Description</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">double</span> <span class="n">Price</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="c1">// Quantity in stock</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">AvailableStock</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="c1">// Available stock at which we should reorder</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">RestockThreshold</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="c1">// Maximum number of units that can be in-stock at any time (due to physicial/logistical constraints in warehouses)</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">MaxStockThreshold</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// True if item is on reorder</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="k">public</span> <span class="kt">bool</span> <span class="n">OnReorder</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">class</span> <span class="nc">CreateCatalogItemCommandHandler</span> <span class="p">:</span> <span class="n">INotificationHandler</span><span class="p">&lt;</span><span class="n">CreateCatalogItemCommand</span><span class="p">&gt;</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IAggregateRepository</span><span class="p">&lt;</span><span class="n">CatalogItem</span><span class="p">,</span> <span class="n">Guid</span><span class="p">&gt;</span> <span class="n">_aggregateRepository</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">ICatalogItemRepository</span> <span class="n">_catalogItemRepository</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">CreateCatalogItemCommandHandler</span><span class="p">(</span><span class="n">IAggregateRepository</span><span class="p">&lt;</span><span class="n">CatalogItem</span><span class="p">,</span> <span class="n">Guid</span><span class="p">&gt;</span> <span class="n">aggregateRepository</span><span class="p">,</span> 
            <span class="n">ICatalogItemRepository</span> <span class="n">catalogItemRepository</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_aggregateRepository</span> <span class="p">=</span> <span class="n">aggregateRepository</span><span class="p">;</span>
            <span class="n">_catalogItemRepository</span> <span class="p">=</span> <span class="n">catalogItemRepository</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">Handle</span><span class="p">(</span><span class="n">CreateCatalogItemCommand</span> <span class="n">notification</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
        <span class="p">{</span>

    

            <span class="c1">// Insert event into eventstore db</span>
            <span class="kt">var</span> <span class="n">catalogItem</span> <span class="p">=</span> <span class="n">CatalogItem</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="n">notification</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">notification</span><span class="p">.</span><span class="n">Description</span><span class="p">,</span> <span class="n">notification</span><span class="p">.</span><span class="n">Price</span><span class="p">,</span> <span class="n">notification</span><span class="p">.</span><span class="n">AvailableStock</span><span class="p">,</span>
                <span class="n">notification</span><span class="p">.</span><span class="n">RestockThreshold</span><span class="p">,</span> <span class="n">notification</span><span class="p">.</span><span class="n">MaxStockThreshold</span><span class="p">,</span> <span class="n">notification</span><span class="p">.</span><span class="n">OnReorder</span><span class="p">);</span>
            <span class="k">await</span> <span class="n">_aggregateRepository</span><span class="p">.</span><span class="nf">AppendAsync</span><span class="p">(</span><span class="n">catalogItem</span><span class="p">);</span>

            <span class="c1">// Save data into database</span>
            <span class="c1">//await _catalogItemAggregateRepository.SaveAsync(catalogItem.Events.FirstOrDefault());</span>
            <span class="k">await</span> <span class="n">_catalogItemRepository</span><span class="p">.</span><span class="nf">AddAsync</span><span class="p">(</span><span class="n">catalogItem</span><span class="p">);</span>

            <span class="c1">// Dispatch events to any event/service bus to do next actions</span>
            <span class="c1">// We can also register EventStore db Subscription to receive Event Notification</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<ul>
  <li>Create UpdateCatalogItemCommand and UpdateCatalogItemCommandHandler class in Commands-&gt;CatalogItems folder.</li>
</ul>

<p><strong>UpdateCatalogItemCommand.cs</strong></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">using</span> <span class="nn">Application.Common.Interfaces</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Domain.Entities</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">MediatR</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Application.Commands.CatalogItems</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">UpdateCatalogItemCommand</span> <span class="p">:</span> <span class="n">INotification</span>
    <span class="p">{</span>
        <span class="c1">// Update Catalog Item Command</span>
        <span class="k">public</span> <span class="nf">UpdateCatalogItemCommand</span><span class="p">(</span><span class="n">Guid</span> <span class="n">id</span><span class="p">,</span> <span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="kt">string</span> <span class="n">description</span><span class="p">,</span> <span class="kt">double</span> <span class="n">price</span><span class="p">,</span> <span class="kt">int</span> <span class="n">availableStock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">restockThreshold</span><span class="p">,</span>
            <span class="kt">int</span> <span class="n">maxStockThreshold</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">onReorder</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">CatalogItemId</span> <span class="p">=</span> <span class="n">id</span><span class="p">;</span>
            <span class="n">Name</span> <span class="p">=</span> <span class="n">name</span><span class="p">;</span>
            <span class="n">Description</span> <span class="p">=</span> <span class="n">description</span><span class="p">;</span>
            <span class="n">Price</span> <span class="p">=</span> <span class="n">price</span><span class="p">;</span>
            <span class="n">AvailableStock</span> <span class="p">=</span> <span class="n">availableStock</span><span class="p">;</span>
            <span class="n">RestockThreshold</span> <span class="p">=</span> <span class="n">restockThreshold</span><span class="p">;</span>
            <span class="n">MaxStockThreshold</span> <span class="p">=</span> <span class="n">maxStockThreshold</span><span class="p">;</span>
            <span class="n">OnReorder</span> <span class="p">=</span> <span class="n">onReorder</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">Guid</span> <span class="n">CatalogItemId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">string</span> <span class="n">Description</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">double</span> <span class="n">Price</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="c1">// Quantity in stock</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">AvailableStock</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="c1">// Available stock at which we should reorder</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">RestockThreshold</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="c1">// Maximum number of units that can be in-stock at any time (due to physicial/logistical constraints in warehouses)</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">MaxStockThreshold</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// True if item is on reorder</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="k">public</span> <span class="kt">bool</span> <span class="n">OnReorder</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="p">}</span>

    <span class="k">public</span> <span class="k">class</span> <span class="nc">UpdateCatalogItemCommandHandler</span><span class="p">:</span> <span class="n">INotificationHandler</span><span class="p">&lt;</span><span class="n">UpdateCatalogItemCommand</span><span class="p">&gt;</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IAggregateRepository</span><span class="p">&lt;</span><span class="n">CatalogItem</span><span class="p">,</span> <span class="n">Guid</span><span class="p">&gt;</span> <span class="n">_aggregateRepository</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">ICatalogItemRepository</span> <span class="n">_catalogItemRepository</span><span class="p">;</span>
        <span class="k">public</span> <span class="nf">UpdateCatalogItemCommandHandler</span><span class="p">(</span><span class="n">IAggregateRepository</span><span class="p">&lt;</span><span class="n">CatalogItem</span><span class="p">,</span> <span class="n">Guid</span><span class="p">&gt;</span> <span class="n">aggregateRepository</span><span class="p">,</span> 
            <span class="n">ICatalogItemRepository</span> <span class="n">catalogItemRepository</span><span class="p">)</span>
        <span class="p">{</span> 
            <span class="n">_aggregateRepository</span> <span class="p">=</span> <span class="n">aggregateRepository</span><span class="p">;</span>
            <span class="n">_catalogItemRepository</span> <span class="p">=</span> <span class="n">catalogItemRepository</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="err">#</span><span class="n">region</span> <span class="n">INotificationHandler</span> <span class="n">implementation</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">Handle</span><span class="p">(</span><span class="n">UpdateCatalogItemCommand</span> <span class="n">notification</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">catalogItem</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_aggregateRepository</span><span class="p">.</span><span class="nf">RehydreateAsync</span><span class="p">(</span><span class="n">notification</span><span class="p">.</span><span class="n">CatalogItemId</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">);</span>

            <span class="k">if</span><span class="p">(</span><span class="n">catalogItem</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">"Invalide catalog item information"</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="n">catalogItem</span><span class="p">.</span><span class="nf">Update</span><span class="p">(</span><span class="n">notification</span><span class="p">.</span><span class="n">CatalogItemId</span><span class="p">,</span> <span class="n">notification</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">notification</span><span class="p">.</span><span class="n">Description</span><span class="p">,</span> <span class="n">notification</span><span class="p">.</span><span class="n">Price</span><span class="p">,</span>
                <span class="n">notification</span><span class="p">.</span><span class="n">AvailableStock</span><span class="p">,</span> <span class="n">notification</span><span class="p">.</span><span class="n">RestockThreshold</span><span class="p">,</span> <span class="n">notification</span><span class="p">.</span><span class="n">MaxStockThreshold</span><span class="p">,</span> <span class="n">notification</span><span class="p">.</span><span class="n">OnReorder</span><span class="p">);</span>

            <span class="k">await</span> <span class="n">_aggregateRepository</span><span class="p">.</span><span class="nf">AppendAsync</span><span class="p">(</span><span class="n">catalogItem</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">);</span>

            <span class="c1">// Save data into database</span>

            <span class="k">await</span> <span class="n">_catalogItemRepository</span><span class="p">.</span><span class="nf">UpdateAsync</span><span class="p">(</span><span class="n">catalogItem</span><span class="p">);</span>


        <span class="p">}</span>

        <span class="err">#</span><span class="n">endregion</span>
    <span class="p">}</span>


<span class="p">}</span>

</code></pre></div></div>

<ul>
  <li>Create DeleteCatalogItemCommand and DeleteCatlogItemCommandHandler class in Commands-&gt;CatalogItems folder.</li>
</ul>

<p><strong>DeleteCatalogItemCommand.cs</strong></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">using</span> <span class="nn">Application.Common.Interfaces</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Domain.Entities</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">MediatR</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Application.Commands.CatalogItems</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">DeleteCatalogItemCommand</span> <span class="p">:</span> <span class="n">INotification</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="nf">DeleteCatalogItemCommand</span><span class="p">(</span><span class="n">Guid</span> <span class="n">id</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Id</span> <span class="p">=</span> <span class="n">id</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">public</span> <span class="n">Guid</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">class</span> <span class="nc">DeleteCatlogItemCommandHandler</span> <span class="p">:</span> <span class="n">INotificationHandler</span><span class="p">&lt;</span><span class="n">DeleteCatalogItemCommand</span><span class="p">&gt;</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IAggregateRepository</span><span class="p">&lt;</span><span class="n">CatalogItem</span><span class="p">,</span> <span class="n">Guid</span><span class="p">&gt;</span> <span class="n">_aggregateRepository</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">ICatalogItemRepository</span> <span class="n">_catalogItemRepository</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">DeleteCatlogItemCommandHandler</span><span class="p">(</span><span class="n">IAggregateRepository</span><span class="p">&lt;</span><span class="n">CatalogItem</span><span class="p">,</span> <span class="n">Guid</span><span class="p">&gt;</span> <span class="n">agrregateRepository</span>
            <span class="p">,</span> <span class="n">ICatalogItemRepository</span> <span class="n">catalogItemRepository</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_aggregateRepository</span> <span class="p">=</span> <span class="n">agrregateRepository</span><span class="p">;</span>
            <span class="n">_catalogItemRepository</span> <span class="p">=</span> <span class="n">catalogItemRepository</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">Handle</span><span class="p">(</span><span class="n">DeleteCatalogItemCommand</span> <span class="n">notification</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">catalogItem</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_aggregateRepository</span><span class="p">.</span><span class="nf">RehydreateAsync</span><span class="p">(</span><span class="n">notification</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">catalogItem</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">"Invalid Catalog Item information"</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="n">catalogItem</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="n">catalogItem</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>
            <span class="k">await</span> <span class="n">_aggregateRepository</span><span class="p">.</span><span class="nf">AppendAsync</span><span class="p">(</span><span class="n">catalogItem</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">);</span>

            <span class="c1">// Save data into database</span>
            <span class="k">await</span> <span class="n">_catalogItemRepository</span><span class="p">.</span><span class="nf">UpdateAsync</span><span class="p">(</span><span class="n">catalogItem</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<ul>
  <li>Create GetCatalogItemLogByIdQuery and GetCatalogItemLogByIdQueryHandler class in Queries-&gt;CatalogItems folder</li>
</ul>

<p><strong>GetCatalogItemLogByIdQuery.cs</strong></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">using</span> <span class="nn">Application.Common.Interfaces</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Domain.Entities</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">MediatR</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Application.Queries.CatalogItems</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">GetCatalogItemLogByIdQuery</span> <span class="p">:</span> <span class="n">IRequest</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;&gt;</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="nf">GetCatalogItemLogByIdQuery</span><span class="p">(</span><span class="n">Guid</span> <span class="n">catalogItemId</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">CatalogItemId</span> <span class="p">=</span> <span class="n">catalogItemId</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">Guid</span> <span class="n">CatalogItemId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">class</span> <span class="nc">GetCatalogItemLogByIdQueryHandler</span> <span class="p">:</span> <span class="n">IRequestHandler</span><span class="p">&lt;</span><span class="n">GetCatalogItemLogByIdQuery</span><span class="p">,</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;&gt;</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IAggregateRepository</span><span class="p">&lt;</span><span class="n">CatalogItem</span><span class="p">,</span> <span class="n">Guid</span><span class="p">&gt;</span> <span class="n">_aggregateRepository</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">GetCatalogItemLogByIdQueryHandler</span><span class="p">(</span><span class="n">IAggregateRepository</span><span class="p">&lt;</span><span class="n">CatalogItem</span><span class="p">,</span> <span class="n">Guid</span><span class="p">&gt;</span> <span class="n">aggregateRepository</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_aggregateRepository</span> <span class="p">=</span> <span class="n">aggregateRepository</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;&gt;</span> <span class="nf">Handle</span><span class="p">(</span><span class="n">GetCatalogItemLogByIdQuery</span> <span class="n">request</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">data</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_aggregateRepository</span><span class="p">.</span><span class="nf">ReadEventsAsync</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">CatalogItemId</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">data</span><span class="p">.</span><span class="n">Values</span><span class="p">.</span><span class="nf">ToList</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<ul>
  <li>Create service collection extension method in root directory.</li>
</ul>

<p><strong>DependencyInjection.cs</strong></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">using</span> <span class="nn">MediatR</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.DependencyInjection</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Reflection</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Application</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">DependencyInjection</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">static</span> <span class="n">IServiceCollection</span> <span class="nf">AddApplication</span><span class="p">(</span><span class="k">this</span> <span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//Add MediatR to the Pipe line</span>
            <span class="n">services</span><span class="p">.</span><span class="nf">AddMediatR</span><span class="p">(</span><span class="n">Assembly</span><span class="p">.</span><span class="nf">GetExecutingAssembly</span><span class="p">());</span>
            <span class="k">return</span> <span class="n">services</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<p><strong>Step 6: Organize Infrastructure</strong></p>

<ul>
  <li>Add Domain and Application project as reference in the Infrastructure project.</li>
  <li>You may add in the project file as follows.</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
  <span class="nt">&lt;ItemGroup&gt;</span>
    <span class="nt">&lt;ProjectReference</span> <span class="na">Include=</span><span class="s">"..\Application\Application.csproj"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;ProjectReference</span> <span class="na">Include=</span><span class="s">"..\Domain\Domain.csproj"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/ItemGroup&gt;</span>

</code></pre></div></div>

<ul>
  <li>Create ApplicationDbContext class in Persistance folder</li>
</ul>

<p><strong>ApplicationDbContext.cs</strong></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">using</span> <span class="nn">Domain.Entities</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.EntityFrameworkCore</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Reflection</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Infrastructure.Persistance</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">ApplicationDbContext</span> <span class="p">:</span> <span class="n">DbContext</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="nf">ApplicationDbContext</span><span class="p">(</span><span class="n">DbContextOptions</span><span class="p">&lt;</span><span class="n">ApplicationDbContext</span><span class="p">&gt;</span> <span class="n">options</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="p">{</span>

        <span class="p">}</span>

        <span class="k">public</span> <span class="n">DbSet</span><span class="p">&lt;</span><span class="n">CatalogItem</span><span class="p">&gt;</span> <span class="n">CatalogItems</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnConfiguring</span><span class="p">(</span><span class="n">DbContextOptionsBuilder</span> <span class="n">optionsBuilder</span><span class="p">)</span>
        <span class="p">{</span>

        <span class="p">}</span>

        <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnModelCreating</span><span class="p">(</span><span class="n">ModelBuilder</span> <span class="n">builder</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">base</span><span class="p">.</span><span class="nf">OnModelCreating</span><span class="p">(</span><span class="n">builder</span><span class="p">);</span>
            <span class="n">builder</span><span class="p">.</span><span class="nf">ApplyConfigurationsFromAssembly</span><span class="p">(</span><span class="n">Assembly</span><span class="p">.</span><span class="nf">GetExecutingAssembly</span><span class="p">());</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>


</code></pre></div></div>

<ul>
  <li>Create CatalogItemRepository class in Persistance folder for insert and update in the sql server.</li>
</ul>

<p><strong>CatalogItemRepository.cs</strong></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">using</span> <span class="nn">Application.Common.Interfaces</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Domain.Entities</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Infrastructure.Persistance</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">CatalogItemRepository</span> <span class="p">:</span> <span class="n">ICatalogItemRepository</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">ApplicationDbContext</span> <span class="n">_context</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">CatalogItemRepository</span><span class="p">(</span><span class="n">ApplicationDbContext</span> <span class="n">applicationDbContext</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_context</span> <span class="p">=</span> <span class="n">applicationDbContext</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">AddAsync</span><span class="p">(</span><span class="n">CatalogItem</span> <span class="n">catalogItem</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">await</span> <span class="n">_context</span><span class="p">.</span><span class="nf">AddAsync</span><span class="p">(</span><span class="n">catalogItem</span><span class="p">);</span>
            <span class="k">await</span> <span class="n">_context</span><span class="p">.</span><span class="nf">SaveChangesAsync</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">UpdateAsync</span><span class="p">(</span><span class="n">CatalogItem</span> <span class="n">catalogItem</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_context</span><span class="p">.</span><span class="nf">Entry</span><span class="p">(</span><span class="n">catalogItem</span><span class="p">).</span><span class="n">State</span> <span class="p">=</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">EntityFrameworkCore</span><span class="p">.</span><span class="n">EntityState</span><span class="p">.</span><span class="n">Modified</span><span class="p">;</span>
            <span class="k">await</span> <span class="n">_context</span><span class="p">.</span><span class="nf">SaveChangesAsync</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<ul>
  <li>Create AggregateRepository class in Persistance for inserting into event store db.</li>
</ul>

<p><strong>AggregateRepository.cs</strong></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">using</span> <span class="nn">Application.Common.Interfaces</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Application.Common.Resolvers</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Domain.Entities.Common</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">EventStore.Client</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Newtonsoft.Json</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Text.Json</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Text.Json.Serialization</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">JsonSerializer</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">Text</span><span class="p">.</span><span class="n">Json</span><span class="p">.</span><span class="n">JsonSerializer</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Infrastructure.Persistance</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">AggregateRepository</span><span class="p">&lt;</span><span class="n">TA</span><span class="p">,</span> <span class="n">TKey</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IAggregateRepository</span><span class="p">&lt;</span><span class="n">TA</span><span class="p">,</span> <span class="n">TKey</span><span class="p">&gt;</span> <span class="k">where</span> <span class="n">TA</span> <span class="p">:</span> <span class="k">class</span><span class="err">,</span> <span class="nc">IAggregateRoot</span><span class="p">&lt;</span><span class="n">TKey</span><span class="p">&gt;</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">EventStoreClient</span> <span class="n">_eventStoreClient</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">_stramBaseName</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">AggregateRepository</span><span class="p">(</span><span class="n">EventStoreClient</span> <span class="n">eventStoreClient</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_eventStoreClient</span> <span class="p">=</span> <span class="n">eventStoreClient</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">aggregateType</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">TA</span><span class="p">);</span>
            <span class="n">_stramBaseName</span> <span class="p">=</span> <span class="n">aggregateType</span><span class="p">.</span><span class="n">Name</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">AppendAsync</span><span class="p">(</span><span class="n">TA</span> <span class="n">aggregate</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">cancellationToken</span> <span class="p">=</span> <span class="k">default</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">null</span> <span class="p">==</span> <span class="n">aggregate</span><span class="p">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">aggregate</span><span class="p">));</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">aggregate</span><span class="p">.</span><span class="n">Events</span><span class="p">.</span><span class="nf">Any</span><span class="p">())</span>
                <span class="k">return</span><span class="p">;</span>

            <span class="kt">var</span> <span class="n">streamName</span> <span class="p">=</span> <span class="nf">GetStreamName</span><span class="p">(</span><span class="n">aggregate</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>

            <span class="kt">var</span> <span class="n">eventList</span> <span class="p">=</span> <span class="n">aggregate</span><span class="p">.</span><span class="n">Events</span><span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">Map</span><span class="p">).</span><span class="nf">ToArray</span><span class="p">();</span>

            <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_eventStoreClient</span><span class="p">.</span><span class="nf">AppendToStreamAsync</span><span class="p">(</span><span class="n">streamName</span><span class="p">,</span> <span class="n">StreamState</span><span class="p">.</span><span class="n">Any</span><span class="p">,</span>
                <span class="n">eventList</span><span class="p">.</span><span class="nf">ToArray</span><span class="p">(),</span> <span class="n">cancellationToken</span><span class="p">:</span> <span class="n">cancellationToken</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;&gt;</span> <span class="nf">ReadEventsAsync</span><span class="p">(</span><span class="n">TKey</span> <span class="n">aggregateId</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">cancellationToken</span> <span class="p">=</span> <span class="k">default</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">streamName</span> <span class="p">=</span> <span class="nf">GetStreamName</span><span class="p">(</span><span class="n">aggregateId</span><span class="p">);</span>
            <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">_eventStoreClient</span><span class="p">.</span><span class="nf">ReadStreamAsync</span><span class="p">(</span><span class="n">Direction</span><span class="p">.</span><span class="n">Forwards</span><span class="p">,</span> <span class="n">streamName</span><span class="p">,</span> <span class="n">StreamPosition</span><span class="p">.</span><span class="n">Start</span><span class="p">);</span>

            <span class="kt">var</span> <span class="n">events</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;();</span>
            <span class="kt">var</span> <span class="n">index</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>

            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">data</span> <span class="k">in</span> <span class="k">await</span> <span class="n">result</span><span class="p">.</span><span class="nf">ToListAsync</span><span class="p">(</span><span class="n">cancellationToken</span><span class="p">:</span> <span class="n">cancellationToken</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="c1">// Read event metadata to get type information of an event</span>
                <span class="kt">var</span> <span class="n">eventMetaData</span> <span class="p">=</span> <span class="n">JsonSerializer</span><span class="p">.</span><span class="n">Deserialize</span><span class="p">&lt;</span><span class="n">EventMeta</span><span class="p">&gt;(</span><span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">Event</span><span class="p">.</span><span class="n">Metadata</span><span class="p">.</span><span class="nf">ToArray</span><span class="p">()));</span>
                <span class="n">Type</span><span class="p">?</span> <span class="n">typeInfo</span> <span class="p">=</span> <span class="n">Type</span><span class="p">.</span><span class="nf">GetType</span><span class="p">(</span><span class="n">eventMetaData</span><span class="p">.</span><span class="n">EventType</span><span class="p">);</span>
                <span class="k">if</span><span class="p">(</span><span class="n">typeInfo</span> <span class="k">is</span> <span class="k">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">$"Invalid type </span><span class="p">{</span><span class="n">eventMetaData</span><span class="p">.</span><span class="n">EventType</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="kt">var</span> <span class="n">jsonData</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">Event</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="nf">ToArray</span><span class="p">());</span>
                <span class="kt">var</span> <span class="n">eventInfo</span> <span class="p">=</span> <span class="n">JsonConvert</span><span class="p">.</span><span class="nf">DeserializeObject</span><span class="p">(</span><span class="n">jsonData</span><span class="p">,</span> <span class="n">typeInfo</span><span class="p">,</span> <span class="k">new</span> <span class="nf">JsonSerializerSettings</span><span class="p">()</span>
                <span class="p">{</span>
                    <span class="n">ConstructorHandling</span> <span class="p">=</span> <span class="n">ConstructorHandling</span><span class="p">.</span><span class="n">AllowNonPublicDefaultConstructor</span><span class="p">,</span>
                    <span class="n">ContractResolver</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">PrivateSetterContractResolver</span><span class="p">()</span>
                <span class="p">});</span>

                <span class="n">events</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="k">new</span>
                <span class="p">{</span>
                    <span class="n">Events</span> <span class="p">=</span> <span class="n">eventInfo</span><span class="p">,</span>
                    <span class="n">EventType</span> <span class="p">=</span> <span class="n">data</span><span class="p">.</span><span class="n">OriginalEvent</span><span class="p">.</span><span class="n">EventType</span>
                <span class="p">});</span>

                <span class="n">index</span><span class="p">++;</span>

            <span class="p">}</span>

            <span class="k">return</span> <span class="n">events</span><span class="p">;</span>
        <span class="p">}</span>


        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// Read all events using Aggregate ID</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="c1">/// &lt;param name="aggregateId"&gt;&lt;/param&gt;</span>
        <span class="c1">/// &lt;param name="cancellationToken"&gt;&lt;/param&gt;</span>
        <span class="c1">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span class="c1">/// &lt;exception cref="NotImplementedException"&gt;&lt;/exception&gt;</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">TA</span><span class="p">?&gt;</span> <span class="nf">RehydreateAsync</span><span class="p">(</span><span class="n">TKey</span> <span class="n">key</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">cancellationToken</span> <span class="p">=</span> <span class="k">default</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>

                <span class="kt">var</span> <span class="n">streamName</span> <span class="p">=</span> <span class="nf">GetStreamName</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>

                <span class="kt">var</span> <span class="n">events</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">IDomainEvent</span><span class="p">&lt;</span><span class="n">TKey</span><span class="p">&gt;&gt;();</span>

                <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">_eventStoreClient</span><span class="p">.</span><span class="nf">ReadStreamAsync</span><span class="p">(</span><span class="n">Direction</span><span class="p">.</span><span class="n">Forwards</span><span class="p">,</span> <span class="n">streamName</span><span class="p">,</span> <span class="n">StreamPosition</span><span class="p">.</span><span class="n">Start</span><span class="p">);</span>


                <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">data</span> <span class="k">in</span> <span class="k">await</span> <span class="n">result</span><span class="p">.</span><span class="nf">ToListAsync</span><span class="p">(</span><span class="n">cancellationToken</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="c1">//Read Event Metadata to get Type Information of an event</span>
                    <span class="kt">var</span> <span class="n">eventMetaData</span> <span class="p">=</span> <span class="n">JsonSerializer</span><span class="p">.</span><span class="n">Deserialize</span><span class="p">&lt;</span><span class="n">EventMeta</span><span class="p">&gt;</span>
                        <span class="p">(</span><span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">Event</span><span class="p">.</span><span class="n">Metadata</span><span class="p">.</span><span class="nf">ToArray</span><span class="p">()));</span>

                    <span class="n">Type</span><span class="p">?</span> <span class="n">typeInfo</span> <span class="p">=</span> <span class="n">Type</span><span class="p">.</span><span class="nf">GetType</span><span class="p">(</span><span class="n">eventMetaData</span><span class="p">.</span><span class="n">EventType</span><span class="p">);</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">typeInfo</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">$"Invalid type </span><span class="p">{</span><span class="n">eventMetaData</span><span class="p">.</span><span class="n">EventType</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
                    <span class="p">}</span>

                    <span class="kt">var</span> <span class="n">jsonData</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">Event</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="nf">ToArray</span><span class="p">());</span>
                    <span class="kt">var</span> <span class="n">eventInfo</span> <span class="p">=</span> <span class="n">JsonConvert</span><span class="p">.</span><span class="nf">DeserializeObject</span><span class="p">(</span><span class="n">jsonData</span><span class="p">,</span> <span class="n">typeInfo</span><span class="p">,</span> <span class="k">new</span> <span class="nf">JsonSerializerSettings</span><span class="p">()</span>
                    <span class="p">{</span>
                        <span class="n">ConstructorHandling</span> <span class="p">=</span> <span class="n">ConstructorHandling</span><span class="p">.</span><span class="n">AllowNonPublicDefaultConstructor</span><span class="p">,</span>
                        <span class="n">ContractResolver</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">PrivateSetterContractResolver</span><span class="p">()</span>
                    <span class="p">});</span>


                    <span class="n">events</span><span class="p">.</span><span class="nf">Add</span><span class="p">((</span><span class="n">IDomainEvent</span><span class="p">&lt;</span><span class="n">TKey</span><span class="p">&gt;)</span><span class="n">eventInfo</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(!</span><span class="n">events</span><span class="p">.</span><span class="nf">Any</span><span class="p">())</span>
                    <span class="k">return</span> <span class="k">null</span><span class="p">;</span>

                <span class="kt">var</span> <span class="n">aggregateResult</span> <span class="p">=</span> <span class="n">BaseAggregateRoot</span><span class="p">&lt;</span><span class="n">TA</span><span class="p">,</span> <span class="n">TKey</span><span class="p">&gt;.</span><span class="nf">Create</span><span class="p">(</span><span class="n">events</span><span class="p">.</span><span class="nf">OrderBy</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">AggregateVersion</span><span class="p">));</span>

                <span class="k">return</span> <span class="n">aggregateResult</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
                <span class="k">throw</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">// Techical: Expression-bodied member</span>
        <span class="c1">// Generate stream name format</span>
        <span class="k">private</span> <span class="kt">string</span> <span class="nf">GetStreamName</span><span class="p">(</span><span class="n">TKey</span> <span class="n">aggregateKey</span><span class="p">)</span>
            <span class="p">=&gt;</span> <span class="s">$"</span><span class="p">{</span><span class="n">_stramBaseName</span><span class="p">}</span><span class="s">_</span><span class="p">{</span><span class="n">aggregateKey</span><span class="p">}</span><span class="s">"</span><span class="p">;</span>

        <span class="c1">// Map domain event to event data</span>
        <span class="k">private</span> <span class="k">static</span> <span class="n">EventData</span> <span class="nf">Map</span><span class="p">(</span><span class="n">IDomainEvent</span><span class="p">&lt;</span><span class="n">TKey</span><span class="p">&gt;</span> <span class="n">@event</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">meta</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">EventMeta</span><span class="p">()</span>
            <span class="p">{</span>
                <span class="n">EventType</span> <span class="p">=</span> <span class="n">@event</span><span class="p">.</span><span class="nf">GetType</span><span class="p">().</span><span class="n">AssemblyQualifiedName</span>
            <span class="p">};</span>

            <span class="kt">var</span> <span class="n">metaJson</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">Text</span><span class="p">.</span><span class="n">Json</span><span class="p">.</span><span class="n">JsonSerializer</span><span class="p">.</span><span class="nf">Serialize</span><span class="p">(</span><span class="n">meta</span><span class="p">);</span>
            <span class="kt">var</span> <span class="n">metadata</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="n">metaJson</span><span class="p">);</span>

            <span class="kt">var</span> <span class="n">eventData</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">EventData</span><span class="p">(</span>
                <span class="n">Uuid</span><span class="p">.</span><span class="nf">NewUuid</span><span class="p">(),</span>
                <span class="n">@event</span><span class="p">.</span><span class="nf">GetType</span><span class="p">().</span><span class="n">Name</span><span class="p">,</span>
                <span class="n">JsonSerializer</span><span class="p">.</span><span class="nf">SerializeToUtf8Bytes</span><span class="p">(</span><span class="n">@event</span><span class="p">,</span> <span class="n">@event</span><span class="p">.</span><span class="nf">GetType</span><span class="p">(),</span> <span class="k">new</span> <span class="nf">JsonSerializerOptions</span><span class="p">()</span>
                <span class="p">{</span>
                    <span class="n">ReferenceHandler</span> <span class="p">=</span> <span class="n">ReferenceHandler</span><span class="p">.</span><span class="n">IgnoreCycles</span>
                <span class="p">}),</span>
                <span class="n">metadata</span>
                <span class="p">);</span>
            <span class="k">return</span> <span class="n">eventData</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">///  Meta data information for an event which will also saved into each Event Payload</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="k">internal</span> <span class="k">struct</span> <span class="nc">EventMeta</span>
        <span class="p">{</span>
            <span class="k">public</span> <span class="kt">string</span> <span class="n">EventType</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<ul>
  <li>Add service collection extension method in the root directory. Here sql server, event store db and dependency injection is configured.</li>
</ul>

<p><strong>DependencyInjection.cs</strong></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">using</span> <span class="nn">Application.Common.Interfaces</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Domain.Entities</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Domain.Entities.Common</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">EventStore.Client</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Infrastructure.Persistance</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.EntityFrameworkCore</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.Configuration</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.DependencyInjection</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Infrastructure</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">DependencyInjection</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">static</span> <span class="n">IServiceCollection</span> <span class="nf">AddEventStore</span><span class="p">(</span><span class="k">this</span> <span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">,</span> <span class="n">IConfiguration</span> <span class="n">configuration</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// Event store database connection</span>
            <span class="kt">var</span> <span class="n">settings</span> <span class="p">=</span> <span class="n">EventStoreClientSettings</span>
                <span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s">"esdb://127.0.0.1:2113?tls=false&amp;keepAliveTimeout=10000&amp;keepAliveInterval=10000"</span><span class="p">);</span>

            <span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">EventStoreClient</span><span class="p">(</span><span class="n">settings</span><span class="p">);</span>
            <span class="n">services</span><span class="p">.</span><span class="nf">AddSingleton</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

            <span class="c1">// Register DbContext for SQL Server</span>

            <span class="n">services</span><span class="p">.</span><span class="n">AddDbContext</span><span class="p">&lt;</span><span class="n">ApplicationDbContext</span><span class="p">&gt;(</span><span class="n">options</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="n">options</span><span class="p">.</span><span class="nf">UseSqlServer</span><span class="p">(</span>
                    <span class="n">configuration</span><span class="p">.</span><span class="nf">GetConnectionString</span><span class="p">(</span><span class="s">"DefaultConnection"</span><span class="p">),</span>
                    <span class="n">sqlServerOptionsAction</span><span class="p">:</span> <span class="n">sqlOptions</span> <span class="p">=&gt;</span>
                    <span class="p">{</span>
                    <span class="p">});</span>
            <span class="p">});</span>

            <span class="n">services</span><span class="p">.</span><span class="n">AddScoped</span><span class="p">&lt;</span><span class="n">ICatalogItemRepository</span><span class="p">,</span> <span class="n">CatalogItemRepository</span><span class="p">&gt;();</span>
            <span class="n">services</span><span class="p">.</span><span class="n">AddEventsRepository</span><span class="p">&lt;</span><span class="n">CatalogItem</span><span class="p">,</span> <span class="n">Guid</span><span class="p">&gt;();</span>

            <span class="k">return</span> <span class="n">services</span><span class="p">;</span>

        <span class="p">}</span>


        <span class="k">private</span> <span class="k">static</span> <span class="n">IServiceCollection</span> <span class="n">AddEventsRepository</span><span class="p">&lt;</span><span class="n">TA</span><span class="p">,</span> <span class="n">TK</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
    <span class="k">where</span> <span class="n">TA</span> <span class="p">:</span> <span class="k">class</span><span class="err">,</span> <span class="nc">IAggregateRoot</span><span class="p">&lt;</span><span class="n">TK</span><span class="p">&gt;</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">services</span><span class="p">.</span><span class="nf">AddSingleton</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IAggregateRepository</span><span class="p">&lt;</span><span class="n">TA</span><span class="p">,</span> <span class="n">TK</span><span class="p">&gt;),</span> <span class="k">typeof</span><span class="p">(</span><span class="n">AggregateRepository</span><span class="p">&lt;</span><span class="n">TA</span><span class="p">,</span> <span class="n">TK</span><span class="p">&gt;));</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<p><strong>Step 7: Organize Catalog.API</strong></p>

<ul>
  <li>Add connection string in the appsettings.json file as follows.</li>
</ul>

<p><strong>appsettings.json</strong></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"Logging"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"LogLevel"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Default"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Information"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Microsoft.AspNetCore"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Warning"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"AllowedHosts"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"ConnectionStrings"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"DefaultConnection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Data Source=localhost;Initial Catalog=CatalogDB;Persist Security Info=False;User ID=sa; Password = yourpassword;Pooling=False;MultipleActiveResultSets=False;Encrypt=False;TrustServerCertificate=False"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">

</span></code></pre></div></div>

<ul>
  <li>Add CatalogItemController class in Controllers folder as follows.</li>
</ul>

<p><strong>CatalogItemController.cs</strong></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">using</span> <span class="nn">Application.Commands.CatalogItems</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Application.Common.DTOs</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Application.Queries.CatalogItems</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">MediatR</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Mvc</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Catalog.API.Controllers</span>
<span class="p">{</span>
    <span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"api/[controller]"</span><span class="p">)]</span>
    <span class="p">[</span><span class="n">ApiController</span><span class="p">]</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">CatalogItemController</span> <span class="p">:</span> <span class="n">ControllerBase</span>
    <span class="p">{</span>

        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IMediator</span> <span class="n">_mediator</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">CatalogItemController</span><span class="p">(</span><span class="n">IMediator</span> <span class="n">mediator</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_mediator</span> <span class="p">=</span> <span class="n">mediator</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="nf">HttpPost</span><span class="p">(</span><span class="s">"Create"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">IActionResult</span><span class="p">&gt;</span> <span class="nf">CreateCatalogItemAsync</span><span class="p">([</span><span class="n">FromBody</span><span class="p">]</span> <span class="n">CreateCatalogItemDTO</span><span class="p">?</span> <span class="n">dto</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dto</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                <span class="k">return</span> <span class="nf">BadRequest</span><span class="p">();</span>

            <span class="kt">var</span> <span class="n">command</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CreateCatalogItemCommand</span><span class="p">(</span><span class="n">dto</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">dto</span><span class="p">.</span><span class="n">Description</span><span class="p">,</span> <span class="n">dto</span><span class="p">.</span><span class="n">Price</span><span class="p">,</span> <span class="n">dto</span><span class="p">.</span><span class="n">AvailableStock</span><span class="p">,</span> <span class="n">dto</span><span class="p">.</span><span class="n">RestockThreshold</span><span class="p">,</span>
                <span class="n">dto</span><span class="p">.</span><span class="n">MaxStockThreshold</span><span class="p">,</span> <span class="n">dto</span><span class="p">.</span><span class="n">OnReorder</span><span class="p">);</span>
            <span class="k">await</span> <span class="n">_mediator</span><span class="p">.</span><span class="nf">Publish</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>

            <span class="k">return</span> <span class="nf">Ok</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="nf">HttpPatch</span><span class="p">(</span><span class="s">"update/{id:guid}"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">IActionResult</span><span class="p">&gt;</span> <span class="nf">UpdateCatalogItem</span><span class="p">(</span><span class="n">Guid</span> <span class="n">id</span><span class="p">,</span> <span class="p">[</span><span class="n">FromBody</span><span class="p">]</span> <span class="n">UpdateCatalogItemDTO</span><span class="p">?</span> <span class="n">dto</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dto</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                <span class="k">return</span> <span class="nf">BadRequest</span><span class="p">();</span>

            <span class="kt">var</span> <span class="n">updateCommand</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">UpdateCatalogItemCommand</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">dto</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">dto</span><span class="p">.</span><span class="n">Description</span><span class="p">,</span> <span class="n">dto</span><span class="p">.</span><span class="n">Price</span><span class="p">,</span> <span class="n">dto</span><span class="p">.</span><span class="n">AvailableStock</span><span class="p">,</span>
                <span class="n">dto</span><span class="p">.</span><span class="n">RestockThreshold</span><span class="p">,</span> <span class="n">dto</span><span class="p">.</span><span class="n">MaxStockThreshold</span><span class="p">,</span> <span class="n">dto</span><span class="p">.</span><span class="n">OnReorder</span><span class="p">);</span>
            <span class="k">await</span> <span class="n">_mediator</span><span class="p">.</span><span class="nf">Publish</span><span class="p">(</span><span class="n">updateCommand</span><span class="p">);</span>

            <span class="k">return</span> <span class="nf">Ok</span><span class="p">(</span><span class="n">updateCommand</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// Delete a catalog item which is soft delete not hard delete</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="c1">/// &lt;param name="id"&gt;&lt;/param&gt;</span>
        <span class="c1">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span class="p">[</span><span class="nf">HttpDelete</span><span class="p">(</span><span class="s">"delete/{id:guid}"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">IActionResult</span><span class="p">&gt;</span> <span class="nf">DeleteCatalogItem</span><span class="p">(</span><span class="n">Guid</span> <span class="n">id</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">deleteCatalogCommand</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DeleteCatalogItemCommand</span><span class="p">(</span><span class="n">id</span><span class="p">);</span> 
            <span class="k">await</span> <span class="n">_mediator</span><span class="p">.</span><span class="nf">Publish</span><span class="p">(</span><span class="n">deleteCatalogCommand</span><span class="p">);</span>
            <span class="k">return</span> <span class="nf">Ok</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="nf">HttpGet</span><span class="p">(</span><span class="s">"log/{id:guid}"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">IActionResult</span><span class="p">&gt;</span> <span class="nf">GetLog</span><span class="p">(</span><span class="n">Guid</span> <span class="n">id</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nf">Ok</span><span class="p">(</span><span class="k">await</span> <span class="n">_mediator</span><span class="p">.</span><span class="nf">Send</span><span class="p">(</span><span class="k">new</span> <span class="nf">GetCatalogItemLogByIdQuery</span><span class="p">(</span><span class="n">id</span><span class="p">)));</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<ul>
  <li>Modify Program.cs as follows.</li>
</ul>

<p><strong>Program.cs</strong></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">using</span> <span class="nn">Application</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Infrastructure</span><span class="p">;</span>

<span class="kt">var</span> <span class="n">builder</span> <span class="p">=</span> <span class="n">WebApplication</span><span class="p">.</span><span class="nf">CreateBuilder</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>

<span class="c1">// Add services to the container.</span>

<span class="kt">var</span> <span class="n">environment</span> <span class="p">=</span> <span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"ASPNETCORE_ENVIRONMENT"</span><span class="p">);</span>
<span class="n">builder</span><span class="p">.</span><span class="n">Configuration</span><span class="p">.</span><span class="nf">SetBasePath</span><span class="p">(</span><span class="n">Directory</span><span class="p">.</span><span class="nf">GetCurrentDirectory</span><span class="p">())</span>
    <span class="p">.</span><span class="nf">AddJsonFile</span><span class="p">(</span><span class="s">"appsettings.json"</span><span class="p">,</span> <span class="n">optional</span><span class="p">:</span> <span class="k">false</span><span class="p">,</span> <span class="n">reloadOnChange</span><span class="p">:</span> <span class="k">true</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">AddJsonFile</span><span class="p">(</span><span class="s">$"appsettings.</span><span class="p">{</span><span class="n">environment</span><span class="p">}</span><span class="s">.json"</span><span class="p">,</span> <span class="n">optional</span><span class="p">:</span> <span class="k">true</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">AddEnvironmentVariables</span><span class="p">();</span>

<span class="c1">//Register Application layer and Event Store layer from Infrastructure here</span>
<span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="nf">AddApplication</span><span class="p">().</span><span class="nf">AddEventStore</span><span class="p">(</span><span class="n">builder</span><span class="p">.</span><span class="n">Configuration</span><span class="p">);</span>



<span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="nf">AddControllers</span><span class="p">();</span>
<span class="c1">// Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle</span>
<span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="nf">AddEndpointsApiExplorer</span><span class="p">();</span>
<span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="nf">AddSwaggerGen</span><span class="p">();</span>

<span class="kt">var</span> <span class="n">app</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">Build</span><span class="p">();</span>

<span class="c1">// Configure the HTTP request pipeline.</span>
<span class="k">if</span> <span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="n">Environment</span><span class="p">.</span><span class="nf">IsDevelopment</span><span class="p">())</span>
<span class="p">{</span>
    <span class="n">app</span><span class="p">.</span><span class="nf">UseSwagger</span><span class="p">();</span>
    <span class="n">app</span><span class="p">.</span><span class="nf">UseSwaggerUI</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">app</span><span class="p">.</span><span class="nf">UseHttpsRedirection</span><span class="p">();</span>

<span class="n">app</span><span class="p">.</span><span class="nf">UseAuthorization</span><span class="p">();</span>

<span class="n">app</span><span class="p">.</span><span class="nf">MapControllers</span><span class="p">();</span>

<span class="n">app</span><span class="p">.</span><span class="nf">Run</span><span class="p">();</span>

</code></pre></div></div>

<p><strong>Step 8: Add Migration</strong></p>

<ul>
  <li>Set Catalog.API as startup project and go to package manager console.</li>
  <li>Select Infrastructure as Default project and run the following commands.</li>
</ul>

<div class="language-ps highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">PM</span><span class="p">&gt;</span> <span class="nf">Add-Migration</span> <span class="nf">init-mig</span>
<span class="nf">PM</span><span class="p">&gt;</span> <span class="nf">Update-Database</span> <span class="nf">-Verbose</span>
</code></pre></div></div>

<p><strong>Step 9: Run application and perform CRUD operation using swagger.  See the impact in sql server and EventStoreDB as follows.</strong></p>

<p>Swagger UI: Create, update and delete CatalogItem using SwaggerUI</p>

<p><img src="/assets/images/posts/2022/es-01.png" alt="" /></p>

<p>EventStoreDB UI: Browse event store db to see the impact</p>

<p><img src="/assets/images/posts/2022/es-02.png" alt="" /></p>

<p><strong><a href="https://github.com/mahedee/code-sample02/tree/main/EventSourcing">Source code</a></strong></p>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#aspnetcore" class="page__taxonomy-item" rel="tag">aspnetcore</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#csharp" class="page__taxonomy-item" rel="tag">csharp</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#ddd" class="page__taxonomy-item" rel="tag">ddd</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#eventstoredb" class="page__taxonomy-item" rel="tag">eventstoredb</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#microservices" class="page__taxonomy-item" rel="tag">microservices</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#softwarearchitecture" class="page__taxonomy-item" rel="tag">softwarearchitecture</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#asp-net-core" class="page__taxonomy-item" rel="tag">ASP.NET Core</a><span class="sep">, </span>
    
      
      
      <a href="/categories/#c" class="page__taxonomy-item" rel="tag">C#</a><span class="sep">, </span>
    
      
      
      <a href="/categories/#ddd" class="page__taxonomy-item" rel="tag">DDD</a><span class="sep">, </span>
    
      
      
      <a href="/categories/#eventstoredb" class="page__taxonomy-item" rel="tag">EventStoreDB</a><span class="sep">, </span>
    
      
      
      <a href="/categories/#microservices" class="page__taxonomy-item" rel="tag">Microservices</a><span class="sep">, </span>
    
      
      
      <a href="/categories/#software-architecture" class="page__taxonomy-item" rel="tag">Software Architecture</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2022-12-16T00:00:00-04:00">December 16, 2022</time></p>
        
      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?text=Application+of+Event+Sourcing+using+asp.net+core%2C+DDD%2C+EF%2C+EventStoreDB+and+SQL+Server%20http%3A%2F%2Flocalhost%3A4000%2FApplication-of-Event-Sourcing-using-aspnet-core-DDD-EF-EventStoreDB-and-SQL-Server%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2FApplication-of-Event-Sourcing-using-aspnet-core-DDD-EF-EventStoreDB-and-SQL-Server%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2FApplication-of-Event-Sourcing-using-aspnet-core-DDD-EF-EventStoreDB-and-SQL-Server%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/How-to-create-Net-custom-template-using-GitHub-Packages-Registry/" class="pagination--pager" title="How to create .Net custom template using GitHub Packages Registry
">Previous</a>
    
    
      <a href="/Configure-Load-Balancer-using-Eureka-and-ocelot-with-aspnet-core/" class="pagination--pager" title="Configure Load Balancer using Eureka and ocelot with asp.net core and docker
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/micro-frontend-using-react-and-aspnet-core/" rel="permalink">Unleashing Micro Frontends with React and ASP.NET Core: A Step-by-Step Implementation Approach
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  27 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Micro frontends are an architectural pattern and approach for building modern web applications. Similar to microservices on the backend, micro frontends focu...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/sample-application-redux-react-aspnet-core/" rel="permalink">Simplified Sample Application: Building with Redux Toolkit, React.js, and ASP.NET Core
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  20 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Redux is a popular state management library for JavaScript applications. In this article I will show you how to build a front-end application using redux too...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/singleton-design-pattern/" rel="permalink">Singleton design pattern using C#
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  5 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">The Singleton pattern is a design pattern that restrict to create object more than once and provides a global point of access to that instance. This pattern ...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/some-example-of-javascript-setInterval-method/" rel="permalink">JavaScript setInterval method with some example
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  1 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Extension methods are a powerful feature in C# that allows developers to add new functionality to existing classes without modifying the original source code...</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    <li><i class="fas fa-fw fa-award" aria-hidden="true"></i> <a href = "https://mvp.microsoft.com/en-us/PublicProfile/5001294">MVP Profile</a></li> 
    ||<li><i class="fas fa-fw fa-list-alt" aria-hidden="true"></i> <a href = "/categories/">Categories</a></li>
    ||<li><i class="fas fa-fw fa-code" aria-hidden="true"></i> <a href = "#">Programming</a></li>  
    ||<li><i class="fas fa-fw fa-globe" aria-hidden="true"></i> <a href = "/categories/#asp-net">ASP.NET</a></li> 
    ||<li><a href = "#">AI & ML</a></li>
    ||<li><a href = "#">Javascript</a></li>
    ||<li><a href = "#">Software Architecture</a></li>
    ||<li><a href = "#">Database</a></li>
    ||<li><a href = "#">OOP</a></li>
    ||<li><a href = "#">Design Pattern</a></li>  
    ||<li><a href = "#">Algorithm</a></li>
    ||<li><a href = "#">Interview Tips</a></li>
    ||<li><a href = "#">Opinions</a></li>
    ||<li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2023 Mahedee Hasan. 
  <!-- Powered by  -->
  <!-- <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>. -->
</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




    
  <script>
    var disqus_config = function () {
      this.page.url = "http://localhost:4000/Application-of-Event-Sourcing-using-aspnet-core-DDD-EF-EventStoreDB-and-SQL-Server/";  // Replace PAGE_URL with your page's canonical URL variable
      this.page.identifier = "/Application-of-Event-Sourcing-using-aspnet-core-DDD-EF-EventStoreDB-and-SQL-Server"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    (function() { // DON'T EDIT BELOW THIS LINE
      var d = document, s = d.createElement('script');
      s.src = 'https://https-mahedee-net.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


  





  </body>
</html>
